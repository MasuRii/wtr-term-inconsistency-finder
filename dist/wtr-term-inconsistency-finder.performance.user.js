// ==UserScript==
// @name WTR Lab Term Inconsistency Finder
// @description Performance-optimized version of the WTR Lab Term Inconsistency Finder. Finds term inconsistencies in WTR Lab chapters using Gemini AI with enhanced performance optimizations including tree shaking, minification, and code splitting.
// @version 5.3.2-perf
// @author MasuRii
// @supportURL https://github.com/MasuRii/wtr-term-inconsistency-finder/issues
// @match https://wtr-lab.com/en/novel/*/*/*
// @connect generativelanguage.googleapis.com
// @downloadURL https://raw.githubusercontent.com/MasuRii/wtr-term-inconsistency-finder/main/dist/wtr-term-inconsistency-finder.performance.user.js
// @grant GM_setValue
// @grant GM_getValue
// @grant GM_addStyle
// @grant GM_registerMenuCommand
// @grant GM_xmlhttpRequest
// @icon https://www.google.com/s2/favicons?sz=64&domain=wtr-lab.com
// @license MIT
// @namespace http://tampermonkey.net/
// @run-at document-idle
// @updateURL https://raw.githubusercontent.com/MasuRii/wtr-term-inconsistency-finder/main/dist/wtr-term-inconsistency-finder.performance.user.js
// @website https://github.com/MasuRii/wtr-term-inconsistency-finder
// ==/UserScript==

(()=>{"use strict";var e={56:(e,t,n)=>{e.exports=function(e){var t=n.nc;t&&e.setAttribute("nonce",t)}},72:e=>{var t=[];function n(e){for(var n=-1,i=0;i<t.length;i++)if(t[i].identifier===e){n=i;break}return n}function i(e,i){for(var o={},s=[],a=0;a<e.length;a++){var c=e[a],l=i.base?c[0]+i.base:c[0],d=o[l]||0,u="".concat(l," ").concat(d);o[l]=d+1;var p=n(u),f={css:c[1],media:c[2],sourceMap:c[3],supports:c[4],layer:c[5]};if(-1!==p)t[p].references++,t[p].updater(f);else{var g=r(f,i);i.byIndex=a,t.splice(a,0,{identifier:u,updater:g,references:1})}s.push(u)}return s}function r(e,t){var n=t.domAPI(t);return n.update(e),function(t){if(t){if(t.css===e.css&&t.media===e.media&&t.sourceMap===e.sourceMap&&t.supports===e.supports&&t.layer===e.layer)return;n.update(e=t)}else n.remove()}}e.exports=function(e,r){var o=i(e=e||[],r=r||{});return function(e){e=e||[];for(var s=0;s<o.length;s++){var a=n(o[s]);t[a].references--}for(var c=i(e,r),l=0;l<o.length;l++){var d=n(o[l]);0===t[d].references&&(t[d].updater(),t.splice(d,1))}o=c}}},113:e=>{e.exports=function(e,t){if(t.styleSheet)t.styleSheet.cssText=e;else{for(;t.firstChild;)t.removeChild(t.firstChild);t.appendChild(document.createTextNode(e))}}},249:(e,t,n)=>{n.d(t,{A:()=>a});var i=n(601),r=n.n(i),o=n(314),s=n.n(o)()(r());s.push([e.id,"@keyframes wtr-if-spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }\n            #wtr-if-panel {\n                background-color: var(--wtr-bg, #f2f3f4); color: var(--bs-body-color, #212529); border: 1px solid var(--bs-border-color, #dee2e6); font-family: var(--bs-body-font-family, sans-serif);\n                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 800px; max-height: 85vh; z-index: 10001; display: none; flex-direction: column; border-radius: 8px; box-shadow: 0 8px 24px rgba(0,0,0,0.4);\n            }\n            .wtr-if-header { padding: 12px 16px; border-bottom: 1px solid var(--bs-border-color, #dee2e6); display: flex; justify-content: space-between; align-items: center; background-color: var(--bs-tertiary-bg, #f8f9fa); }\n            .wtr-if-header h2 { margin: 0; font-size: 18px; }\n            .wtr-if-close-btn { background: none; border: none; font-size: 24px; cursor: pointer; line-height: 1; padding: 0 4px; color: var(--bs-body-color, #212529); }\n            .wtr-if-tabs { display: flex; border-bottom: 1px solid var(--bs-border-color, #dee2e6); background-color: var(--bs-tertiary-bg, #f8f9fa); }\n            .wtr-if-tab-btn { background: none; border: none; padding: 10px 15px; cursor: pointer; font-size: 14px; border-bottom: 3px solid transparent; color: var(--bs-secondary-color, #6c757d); }\n            .wtr-if-tab-btn.active { font-weight: bold; border-bottom-color: var(--bs-primary, #fd7e14); color: var(--bs-body-color, #212529); }\n            .wtr-if-content { padding: 16px; overflow-y: auto; flex-grow: 1; }\n            .wtr-if-tab-content { display: none; } .wtr-if-tab-content.active { display: block; }\n            \n            /* Section-based Finder layout improvements */\n            .wtr-if-section {\n                margin-bottom: 20px;\n                border: 1px solid var(--bs-border-color, #dee2e6);\n                border-radius: 8px;\n                overflow: hidden;\n                background-color: var(--bs-body-bg, #fff);\n                box-shadow: 0 2px 4px rgba(0,0,0,0.05);\n            }\n            \n            .wtr-if-section-header {\n                background-color: var(--bs-tertiary-bg, #f8f9fa);\n                padding: 12px 16px;\n                border-bottom: 1px solid var(--bs-border-color, #dee2e6);\n            }\n            \n            .wtr-if-section-header h3 {\n                margin: 0;\n                font-size: 16px;\n                font-weight: 600;\n                color: var(--bs-body-color, #212529);\n                display: flex;\n                align-items: center;\n                gap: 8px;\n            }\n            \n            .wtr-if-icon {\n                font-size: 18px;\n                width: 24px;\n                height: 24px;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n            }\n            \n            .wtr-if-section-content {\n                padding: 16px;\n            }\n            \n            .wtr-if-finder-controls {\n                display: flex;\n                gap: 12px;\n                flex-wrap: wrap;\n            }\n            \n            .wtr-if-btn-large {\n                padding: 12px 20px;\n                font-size: 16px;\n                flex: 1;\n                min-width: 180px;\n            }\n            \n            .wtr-if-action-buttons {\n                display: flex;\n                gap: 10px;\n                flex-wrap: wrap;\n            }\n            \n            .wtr-if-form-row {\n                display: flex;\n                align-items: center;\n                gap: 12px;\n                margin-bottom: 8px;\n                flex-wrap: wrap;\n            }\n            \n            .wtr-if-form-label {\n                font-weight: 600;\n                color: var(--bs-body-color, #212529);\n                white-space: nowrap;\n                min-width: 120px;\n            }\n            \n            .wtr-if-form-select {\n                padding: 8px 12px;\n                border-radius: 6px;\n                border: 1px solid var(--bs-border-color, #dee2e6);\n                background-color: var(--bs-secondary-bg, #e9ecef);\n                color: var(--bs-body-color, #212529);\n                min-width: 200px;\n                flex: 1;\n                max-width: 100%;\n            }\n            \n            .wtr-if-deep-analysis-controls, .wtr-if-filter-controls {\n                width: 100%;\n            }\n            \n            /* Configuration Tab Responsive Design */\n            @media (max-width: 768px) {\n                .wtr-if-finder-controls {\n                    flex-direction: column;\n                }\n                \n                .wtr-if-btn-large {\n                    min-width: auto;\n                    width: 100%;\n                }\n                \n                .wtr-if-form-row {\n                    flex-direction: column;\n                    align-items: stretch;\n                }\n                \n                .wtr-if-form-label {\n                    min-width: auto;\n                }\n                \n                .wtr-if-form-select {\n                    min-width: auto;\n                    width: 100%;\n                }\n                \n                .wtr-if-action-buttons {\n                    flex-direction: column;\n                }\n                \n                .wtr-if-action-buttons button {\n                    width: 100%;\n                }\n\n                /* Configuration Tab Specific Responsive */\n                .wtr-if-section {\n                    margin-bottom: 16px;\n                }\n\n                .wtr-if-section-header h3 {\n                    font-size: 15px;\n                    flex-direction: column;\n                    align-items: flex-start;\n                    gap: 6px;\n                }\n\n                .wtr-if-model-controls {\n                    flex-direction: column;\n                    gap: 8px;\n                }\n\n                .wtr-if-model-controls select,\n                .wtr-if-model-controls button {\n                    width: 100%;\n                }\n\n                .wtr-if-import-export .wtr-if-form-row {\n                    flex-direction: column;\n                    gap: 8px;\n                }\n\n                .wtr-if-import-export button {\n                    width: 100%;\n                }\n\n                .wtr-if-section-content {\n                    padding: 12px;\n                }\n\n                .wtr-if-api-keys-container-wrapper {\n                    max-height: 150px;\n                }\n            }\n            \n            /* Configuration Tab Specific Enhancements */\n            .wtr-if-section {\n                margin-bottom: 20px;\n                border: 1px solid var(--bs-border-color, #dee2e6);\n                border-radius: 8px;\n                overflow: hidden;\n                background-color: var(--bs-body-bg, #fff);\n                box-shadow: 0 2px 4px rgba(0,0,0,0.05);\n            }\n            \n            .wtr-if-section-header {\n                background-color: var(--bs-tertiary-bg, #f8f9fa);\n                padding: 12px 16px;\n                border-bottom: 1px solid var(--bs-border-color, #dee2e6);\n            }\n            \n            .wtr-if-section-header h3 {\n                margin: 0;\n                font-size: 16px;\n                font-weight: 600;\n                color: var(--bs-body-color, #212529);\n                display: flex;\n                align-items: center;\n                gap: 8px;\n            }\n            \n            .wtr-if-icon {\n                font-size: 18px;\n                width: 24px;\n                height: 24px;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n            }\n            \n            .wtr-if-section-content {\n                padding: 16px;\n            }\n\n            /* Enhanced Form Styling for Configuration */\n            .wtr-if-form-group {\n                margin-bottom: 16px;\n                padding: 12px;\n                background-color: var(--bs-body-bg, #fff);\n                border: 1px solid var(--bs-border-color, #dee2e6);\n                border-radius: 6px;\n            }\n            \n            .wtr-if-form-group label {\n                display: block;\n                margin-bottom: 8px;\n                font-weight: 600;\n                font-size: 14px;\n                color: var(--bs-body-color, #212529);\n            }\n            \n            .wtr-if-form-group label.checkbox-label {\n                display: flex;\n                align-items: center;\n                font-weight: normal;\n                margin-bottom: 0;\n            }\n            \n            .wtr-if-form-group label.checkbox-label input {\n                width: auto;\n                margin-right: 10px;\n                margin-bottom: 0;\n            }\n            \n            .wtr-if-form-group input,\n            .wtr-if-form-group select {\n                width: 100%;\n                padding: 10px 12px;\n                border: 1px solid var(--bs-border-color, #dee2e6);\n                border-radius: 6px;\n                box-sizing: border-box;\n                background-color: var(--bs-secondary-bg, #e9ecef);\n                color: var(--bs-body-color, #212529);\n                font-size: 14px;\n                transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;\n            }\n            \n            .wtr-if-form-group input:focus,\n            .wtr-if-form-group select:focus {\n                outline: none;\n                border-color: var(--bs-primary, #fd7e14);\n                box-shadow: 0 0 0 0.2rem rgba(253, 126, 20, 0.25);\n            }\n            \n            .wtr-if-form-group input[type=\"range\"] {\n                padding: 0;\n                background: transparent;\n            }\n            \n            .wtr-if-hint {\n                font-size: 12px;\n                color: var(--bs-secondary-color, #6c757d);\n                font-weight: normal;\n                margin-top: 6px;\n                display: block;\n            }\n            \n            .wtr-if-model-controls {\n                display: flex;\n                align-items: center;\n                gap: 12px;\n                margin-top: 8px;\n            }\n            \n            .wtr-if-model-controls select {\n                flex-grow: 1;\n            }\n            \n            .wtr-if-model-controls button {\n                flex-shrink: 0;\n                white-space: nowrap;\n            }\n            \n            .wtr-if-api-keys-container-wrapper {\n                max-height: 200px;\n                overflow-y: auto;\n                border: 1px solid var(--bs-border-color, #dee2e6);\n                border-radius: 6px;\n                padding: 12px;\n                background-color: var(--bs-secondary-bg, #e9ecef);\n                margin-bottom: 8px;\n            }\n            \n            .wtr-if-key-row {\n                display: flex;\n                align-items: center;\n                gap: 8px;\n                margin-bottom: 8px;\n            }\n            \n            .wtr-if-key-row input {\n                flex-grow: 1;\n            }\n            \n            .wtr-if-remove-key-btn {\n                background: var(--bs-danger, #dc3545);\n                color: white;\n                border: none;\n                border-radius: 50%;\n                width: 24px;\n                height: 24px;\n                font-size: 16px;\n                line-height: 1;\n                cursor: pointer;\n                flex-shrink: 0;\n                transition: background-color 0.15s ease-in-out;\n            }\n            \n            .wtr-if-remove-key-btn:hover {\n                background: #c82333;\n            }\n            .wtr-if-btn { padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; color: white; }\n            .wtr-if-btn:disabled { opacity: 0.6; cursor: not-allowed; }\n            .wtr-if-btn-primary { background-color: var(--bs-primary, #fd7e14); }\n            .wtr-if-btn-secondary { background-color: var(--bs-secondary, #6c757d); }\n            .wtr-if-status { margin-top: 10px; font-size: 14px; text-align: center; }\n            .wtr-if-session-restore {\n                background-color: var(--bs-info-bg-subtle, #cff4fc);\n                border: 1px solid var(--bs-info-border-subtle, #9eeaf9);\n                border-radius: 4px;\n                padding: 10px;\n                margin-bottom: 16px;\n            }\n            .wtr-if-session-restore button { margin-right: 8px; }\n            .wtr-if-import-export {\n                border-top: 1px solid var(--bs-border-color, #dee2e6);\n                padding-top: 15px;\n                margin-top: 15px;\n            }\n            .wtr-if-import-export h4 {\n                margin-top: 0;\n                margin-bottom: 10px;\n                font-size: 14px;\n                font-weight: bold;\n            }\n            #wtr-if-results { margin-top: 10px; }\n            .wtr-if-result-group { border: 1px solid var(--bs-border-color, #dee2e6); border-radius: 6px; margin-bottom: 16px; background-color: var(--bs-body-bg, #fff); }\n            .wtr-if-group-header { padding: 12px; border-bottom: 1px solid var(--bs-border-color, #dee2e6); background-color: var(--bs-tertiary-bg, #f8f9fa); position: relative; }\n            .wtr-if-group-header h3 { margin: 0 0 8px 0; display: flex; align-items: center; flex-wrap: wrap; gap: 8px; font-size: 16px; }\n            .wtr-if-explanation { margin: 0; font-style: italic; opacity: 0.9; font-size: 14px; }\n            .wtr-if-group-actions {\n                position: absolute;\n                top: 12px;\n                right: 12px;\n            }\n            .wtr-if-details-section { padding: 12px; }\n            .wtr-if-details-section h4 { margin-top: 0; margin-bottom: 8px; font-size: 14px; font-weight: bold; border-bottom: 1px solid var(--bs-border-color-translucent, #dee2e6); padding-bottom: 4px; }\n            .wtr-if-variations, .wtr-if-suggestions { display: flex; flex-direction: column; gap: 8px; }\n            .wtr-if-variation-item { border: 1px solid var(--bs-border-color-translucent, #dee2e6); border-radius: 4px; }\n            .wtr-if-variation-header { display: flex; justify-content: space-between; align-items: center; padding: 6px 8px; background-color: var(--bs-secondary-bg, #e9ecef); gap: 8px; }\n            .wtr-if-variation-header .wtr-if-incorrect { flex-grow: 1; }\n            .wtr-if-variation-checkbox { margin: 0; flex-shrink: 0; }\n            .wtr-if-copy-variation-btn { background: none; border: none; cursor: pointer; padding: 2px 4px; font-size: 16px; line-height: 1; opacity: 0.7; transition: opacity 0.2s; }\n            .wtr-if-copy-variation-btn:hover { opacity: 1; }\n            .wtr-if-context { padding: 6px 8px; margin: 0; font-size: 13px; }\n            .wtr-if-suggestion-item { border: 1px solid var(--bs-border-color-translucent, #dee2e6); border-radius: 4px; overflow: hidden; }\n            .wtr-if-suggestion-header { display: flex; justify-content: space-between; align-items: center; padding: 8px; background-color: var(--bs-success-bg-subtle, #d1e7dd); }\n            .wtr-if-suggestion-header .wtr-if-correct { flex-grow: 1; }\n            .wtr-if-suggestion-actions { display: flex; gap: 8px; }\n            .wtr-if-replacement-info { padding: 6px 8px; margin: 0; font-size: 13px; background-color: var(--bs-tertiary-bg, #f8f9fa); border-top: 1px solid var(--bs-border-color-translucent, #dee2e6); }\n            .wtr-if-replacement-info code { background-color: var(--bs-body-bg, #fff); padding: 2px 5px; border-radius: 4px; border: 1px solid var(--bs-border-color, #dee2e6); font-family: var(--bs-font-monospace, monospace); }\n            .wtr-if-reasoning { padding: 6px 8px; margin: 0; font-size: 13px; }\n            .wtr-if-apply-btn { padding: 4px 10px; font-size: 12px; background-color: var(--bs-success, #198754); color: white; border: none; border-radius: 4px; cursor: pointer; white-space: nowrap; }\n            .wtr-if-apply-btn.sent { background-color: var(--bs-secondary, #6c757d); }\n            .wtr-if-priority { padding: 3px 8px; border-radius: 12px; font-size: 12px; color: white; font-weight: bold; }\n            .wtr-if-priority-critical { background-color: var(--bs-danger, #dc3545); }\n            .wtr-if-priority-high { background-color: var(--bs-warning, #ffc107); color: #000; }\n            .wtr-if-priority-medium { background-color: var(--bs-info, #0dcaf0); }\n            .wtr-if-priority-low { background-color: var(--bs-secondary, #6c757d); }\n            .wtr-if-priority-stylistic, .wtr-if-priority-info { background-color: var(--bs-light, #f8f9fa); color: #000; border: 1px solid #ccc; }\n            .wtr-if-concept { color: var(--bs-link-color, #0d6efd); font-weight: bold; }\n            .wtr-if-incorrect { color: var(--bs-danger-text-emphasis, #58151c); font-weight: bold; }\n            .wtr-if-correct { color: var(--bs-success-text-emphasis, #0a3622); font-weight: bold; }\n            .wtr-if-chapter { font-size: 12px; font-weight: bold; padding: 3px 6px; border-radius: 4px; background-color: var(--bs-tertiary-bg, #f8f9fa); color: var(--bs-secondary-color, #6c757d); }\n            .wtr-if-error { padding: 10px; border: 1px solid var(--bs-danger, #dc3545); background-color: var(--bs-danger-bg-subtle, #f8d7da); color: var(--bs-danger-text-emphasis, #58151c); border-radius: 4px; margin-bottom: 10px; }\n            .wtr-if-no-results { padding: 10px; text-align: center; }\n            .wtr-if-verified-badge { background-color: var(--bs-success, #198754); color: white; font-size: 11px; font-weight: bold; padding: 3px 8px; border-radius: 12px; margin-left: 8px; }\n            .wtr-if-recommended-badge { background-color: var(--bs-info, #0dcaf0); color: white; font-size: 11px; font-weight: bold; padding: 3px 8px; border-radius: 12px; margin-left: 8px; vertical-align: middle; }\n            #wtr-if-status-indicator {\n                position: fixed; bottom: 20px; left: 20px; z-index: 10000;\n                background-color: #2c2c2e; color: #f0f0f0; padding: 10px 15px;\n                border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.3);\n                display: none; align-items: center; gap: 10px; font-family: sans-serif;\n                font-size: 14px; transition: background-color 0.3s ease, bottom 0.3s ease;\n            }\n            .wtr-if-status-icon {\n                width: 20px; height: 20px;\n                display: flex; align-items: center; justify-content: center;\n            }\n            #wtr-if-status-indicator.running .wtr-if-status-icon {\n                box-sizing: border-box;\n                border: 3px solid #555;\n                border-top-color: #4285F4;\n                border-radius: 50%;\n                animation: wtr-if-spin 1s linear infinite;\n            }\n            #wtr-if-status-indicator.complete {\n                background-color: #4CAF50; cursor: pointer;\n            }\n            #wtr-if-status-indicator.complete .wtr-if-status-icon::before { content: '✅'; }\n            #wtr-if-status-indicator.error {\n                background-color: #f44336; cursor: pointer;\n            }\n            #wtr-if-status-indicator.error .wtr-if-status-icon::before { content: '❌'; }",""]);const a=s},314:e=>{e.exports=function(e){var t=[];return t.toString=function(){return this.map(function(t){var n="",i=void 0!==t[5];return t[4]&&(n+="@supports (".concat(t[4],") {")),t[2]&&(n+="@media ".concat(t[2]," {")),i&&(n+="@layer".concat(t[5].length>0?" ".concat(t[5]):""," {")),n+=e(t),i&&(n+="}"),t[2]&&(n+="}"),t[4]&&(n+="}"),n}).join("")},t.i=function(e,n,i,r,o){"string"==typeof e&&(e=[[null,e,void 0]]);var s={};if(i)for(var a=0;a<this.length;a++){var c=this[a][0];null!=c&&(s[c]=!0)}for(var l=0;l<e.length;l++){var d=[].concat(e[l]);i&&s[d[0]]||(void 0!==o&&(void 0===d[5]||(d[1]="@layer".concat(d[5].length>0?" ".concat(d[5]):""," {").concat(d[1],"}")),d[5]=o),n&&(d[2]?(d[1]="@media ".concat(d[2]," {").concat(d[1],"}"),d[2]=n):d[2]=n),r&&(d[4]?(d[1]="@supports (".concat(d[4],") {").concat(d[1],"}"),d[4]=r):d[4]="".concat(r)),t.push(d))}},t}},540:e=>{e.exports=function(e){var t=document.createElement("style");return e.setAttributes(t,e.attributes),e.insert(t,e.options),t}},601:e=>{e.exports=function(e){return e[1]}},659:e=>{var t={};e.exports=function(e,n){var i=function(e){if(void 0===t[e]){var n=document.querySelector(e);if(window.HTMLIFrameElement&&n instanceof window.HTMLIFrameElement)try{n=n.contentDocument.head}catch(e){n=null}t[e]=n}return t[e]}(e);if(!i)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");i.appendChild(n)}},825:e=>{e.exports=function(e){if("undefined"==typeof document)return{update:function(){},remove:function(){}};var t=e.insertStyleElement(e);return{update:function(n){!function(e,t,n){var i="";n.supports&&(i+="@supports (".concat(n.supports,") {")),n.media&&(i+="@media ".concat(n.media," {"));var r=void 0!==n.layer;r&&(i+="@layer".concat(n.layer.length>0?" ".concat(n.layer):""," {")),i+=n.css,r&&(i+="}"),n.media&&(i+="}"),n.supports&&(i+="}");var o=n.sourceMap;o&&"undefined"!=typeof btoa&&(i+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(o))))," */")),t.styleTagTransform(i,e,t.options)}(t,e,n)},remove:function(){!function(e){if(null===e.parentNode)return!1;e.parentNode.removeChild(e)}(t)}}}}},t={};function n(i){var r=t[i];if(void 0!==r)return r.exports;var o=t[i]={id:i,exports:{}};return e[i](o,o.exports,n),o.exports}n.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return n.d(t,{a:t}),t},n.d=(e,t)=>{for(var i in t)n.o(t,i)&&!n.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.nc=void 0;var i=n(72),r=n.n(i),o=n(825),s=n.n(o),a=n(659),c=n.n(a),l=n(56),d=n.n(l),u=n(540),p=n.n(u),f=n(113),g=n.n(f),m=n(249),h={};h.styleTagTransform=g(),h.setAttributes=d(),h.insert=c().bind(null,"head"),h.domAPI=s(),h.insertStyleElement=p(),r()(m.A,h),m.A&&m.A.locals&&m.A.locals;function y(...e){R.config.loggingEnabled&&console.log("Inconsistency Finder:",...e)}function w(){const e=document.querySelectorAll(".chapter-tracker");y(`Found ${e.length} potential chapter elements.`);const t=[];return e.forEach((e,n)=>{const i=e.querySelector(".chapter-body"),r=e.dataset.chapterNo;i&&r?(y(`Processing chapter #${r}...`),t.push({chapter:r,text:i.innerText})):y(`Skipping element at index ${n}: missing chapter number or body. Chapter No: ${r||"not found"}`)}),y(`Successfully collected data for ${t.length} chapters: [${t.map(e=>e.chapter).join(", ")}]`),t}function b(e,t=[]){if(!t||0===t.length)return y("No terms provided. Skipping replacement step."),e;y(`Applying ${t.length} replacement terms using advanced logic.`);const n=new Map,i=new Map,r=new Map,o=new Map,s=[];for(const e of t)if(e.original)if(e.wholeWord=e.wholeWord??!1,e.isRegex)try{const t=e.caseSensitive?"g":"gi";s.push({pattern:new RegExp(e.original,t),replacement:e.replacement})}catch(t){console.error(`Inconsistency Finder: Skipping invalid regex for term "${e.original}":`,t)}else{const t=e.caseSensitive?e.original:e.original.toLowerCase(),s=e.replacement;e.caseSensitive?e.wholeWord?i.set(t,s):n.set(t,s):e.wholeWord?o.set(t,s):r.set(t,s)}const a=[...s],c=(e,t,n,i)=>{if(e.size>0){const r=[...e.keys()].sort((e,t)=>t.length-e.length).map(e=>{const t=k(e);return n?`\\b${t}\\b`:t}).join("|");a.push({pattern:new RegExp(r,t),replacement_map:e,is_simple:!0,case_sensitive:i})}};return c(n,"g",!1,!0),c(i,"g",!0,!0),c(r,"gi",!1,!1),c(o,"gi",!0,!1),e.map(e=>{let t=e.text,n=[];for(const e of a)for(const i of t.matchAll(e.pattern)){if(0===i[0].length)continue;let t;if(e.is_simple){const n=e.case_sensitive?i[0]:i[0].toLowerCase();t=e.replacement_map.get(n)}else t=e.replacement;void 0!==t&&n.push({start:i.index,end:i.index+i[0].length,replacement:t})}n.sort((e,t)=>e.start!==t.start?e.start-t.start:t.end-e.end);const i=[];let r=-1;for(const e of n)e.start>=r&&(i.push(e),r=e.end);for(let e=i.length-1;e>=0;e--){const n=i[e];t=t.substring(0,n.start)+n.replacement+t.substring(n.end)}return{...e,text:t}})}function v(e){let t=0;return t+={CRITICAL:100,HIGH:80,MEDIUM:60,LOW:40,STYLISTIC:20,INFO:10}[e.priority]||10,t+=5*(e.variations?.length||0),t+=3*(e.suggestions?.length||0),"Verified"===e.status&&(t+=20),e.isNew&&(t-=10),t}function x(e,t){const n=[...e];return t.forEach(e=>{const t=n.findIndex(t=>function(e,t){const n=e=>e.toLowerCase().replace(/[^a-z0-9\s]/g,"").trim(),i=n(e),r=n(t);if(i===r)return!0;if(i.includes(r)||r.includes(i))return!0;const o=i.split(/\s+/),s=r.split(/\s+/),a=o.filter(e=>s.includes(e));return a.length>0&&a.length/Math.max(o.length,s.length)>.5}(t.concept,e.concept));if(-1===t)n.push(e);else{const i=n[t],r=v(i),o=v(e);if(y(`Semantic duplicate detected: "${i.concept}" vs "${e.concept}". Quality scores: ${r} vs ${o}`),o>r)n[t]=e,y("Replaced lower quality result with higher quality version");else{const r={...i,concept:i.concept,priority:i.priority,explanation:i.explanation,variations:[...i.variations||[],...e.variations||[]].filter((e,t,n)=>n.findIndex(t=>t.phrase===e.phrase&&t.chapter===e.chapter)===t),suggestions:[...i.suggestions||[],...e.suggestions||[]].filter((e,t,n)=>n.findIndex(t=>t.suggestion===e.suggestion)===t),status:i.status||e.status,isNew:i.isNew&&e.isNew};n[t]=r,y("Merged duplicate results, preserving higher quality data")}}}),n}function I(e){const t=e.match(/```(?:json)?\s*([\s\S]*?)\s*```/);if(t&&t[1])return y("Extracted JSON from markdown block."),t[1];const n=e.indexOf("{"),i=e.indexOf("[");let r=-1;if(r=-1===n?i:-1===i?n:Math.min(n,i),-1!==r){const t=e.lastIndexOf("}"),n=e.lastIndexOf("]"),i=Math.max(t,n);if(i>r)return y("Extracted JSON using fallback brace/bracket matching."),e.substring(r,i+1)}return y("No JSON structure found, returning raw text."),e}function k(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function S(e){return"string"!=typeof e?"":e.replace(/&/g,"&").replace(/</g,"<").replace(/>/g,">").replace(/"/g,'"').replace(/'/g,"&#039;")}const E="wtr_inconsistency_finder_",A=`${E}config`,C=`${E}models_cache`,T=`${E}session_results`;let R={config:{apiKeys:[],model:"",useJson:!1,loggingEnabled:!1,temperature:.5,activeTab:"finder",activeFilter:"all",deepAnalysisDepth:1},runtime:{isAnalysisRunning:!1,cumulativeResults:[],currentApiKeyIndex:0,apiKeyCooldowns:new Map,currentIteration:1,totalIterations:1},session:{hasSavedResults:!1,lastAnalysisTime:null},preferences:{autoRestoreResults:!0}};function L(e){const t={...e};if((!t.suggestion||"string"!=typeof t.suggestion||""===t.suggestion.trim())&&t.display_text&&"string"==typeof t.display_text){const e=t.display_text.replace(/^(standardize to|use|change to|replace with|update to)\s*/i,"").replace(/^['"`]|['"`]$/g,"").trim();(e&&e!==t.display_text||e)&&(t.suggestion=e)}return t.suggestion&&"string"==typeof t.suggestion&&""!==t.suggestion.trim()||(t.suggestion=t.display_text||"[Informational]"),t.display_text=t.display_text||`Use "${t.suggestion}"`,t.reasoning=t.reasoning||"AI-generated suggestion",t}async function N(){try{const e={...R.config,preferences:R.preferences};return await GM_setValue(A,e),!0}catch(e){return console.error("Inconsistency Finder: Error saving config:",e),!1}}function $(){try{const e={results:R.runtime.cumulativeResults,timestamp:Date.now(),config:{model:R.config.model,temperature:R.config.temperature}};sessionStorage.setItem(T,JSON.stringify(e)),R.session.hasSavedResults=!0,R.session.lastAnalysisTime=e.timestamp,y("Session results saved")}catch(e){console.error("Inconsistency Finder: Error saving session results:",e)}}function M(){try{sessionStorage.removeItem(T),R.session.hasSavedResults=!1,R.session.lastAnalysisTime=null,y("Session results cleared")}catch(e){console.error("Inconsistency Finder: Error clearing session results:",e)}}const P=new Set(["RESOURCE_EXHAUSTED","INTERNAL","UNAVAILABLE","DEADLINE_EXCEEDED"]);function F(e,t=[]){let n='You are a specialized AI assistant, a "Translation Consistency Editor," designed to detect and fix translation inconsistencies in machine-translated novels. Your primary goal is to identify terms (character names, locations, items, abilities, titles, etc.) that have been translated inconsistently across chapters, provide standardization suggestions, and offer contextual analysis for nuances like aliases, stylistic localizations, and cultural honorifics.\n\n## Core Capabilities\n1.  Scanning & Detection: Automatically scan for inconsistent translations of the same entity. Track variations of character names, place names, items, abilities, titles, and other recurring terms. Detect semantic similarities between terms that may be different translations of the same concept.\n2.  Entity Profiling & Alias Linking: Build profiles for key narrative entities (characters, locations, etc.) to link aliases, nicknames, and full names using contextual clues. Recognize component-based naming schemes (e.g., \'Heavy Cavalry\' as a shorthand for \'Heavy Cavalry Exoskeleton\') and entity-derived names (e.g., a location incorporating a character\'s name like \'[Character] City\').\n3.  Username Lexical & Formatting Analysis: Proactively identify potential usernames based on non-English lexical patterns (pinyin, romaji, etc.) and formatting violations (the presence of spaces). If a username triggers both, present both sets of suggestions together in a single, consolidated report item.\n4.  Suggestion Generation: For each identified inconsistency, provide 3 distinct standardization suggestions. Include data-driven metrics for each suggestion (e.g., frequency, first appearance) and explain the reasoning with quantitative support, maintaining the story\'s context.\n\n## What NOT to Flag (Exclusions)\n- Do not flag or report terms that have been previously confirmed as an alias cluster.\n- Do not flag onomatopoeia (sound words, emotional expressions, or expressive vocalizations like "Wuwuwu", "Aha!", "Huhu", etc.) as these are cute stylistic elements that should remain in their original flavor.\n- Do not flag casual internet expressions or emotional vocalizations that are culturally appropriate and intentionally expressive.\n- Do NOT flag anything related to author notes, author commentary, or translator notes - these are intentional additions that may make the text longer but should not be flagged for inconsistencies.\n- Do NOT flag usernames or character references that are clearly aliases, undercovers, or alternate identifications of the same character.\n- CRITICAL: Do NOT flag quote-style inconsistencies (e.g., "Project Doomsday" vs "Project Doomsday" vs "Project Doomsday"). These are caused by different chapters having been processed by different quote conversion scripts (smart quotes vs straight quotes). Terms that differ only in their quote style (straight quotes ", single quotes \', or smart quotes “ ” ‘ ’) should be considered the same term and not flagged as inconsistencies. Only flag inconsistencies when the actual text content differs, not when only the quotation marks differ.\n\n## Focus On\n- In-text content within the chapter body.\n- Character names, locations, items, abilities, techniques, titles, and organizations.\n- Chapter titles and any inconsistencies within them.\n- Potential alias clusters for entities.\n- Usernames for holistic formatting and localization opportunities.\n- Non-English honorifics for cultural nuance handling.\n\n## Prioritization System (Dynamic Impact-Based)\nYou will use a dynamic Impact Score to rank all detected issues, ensuring that items most critical to the story are prioritized.\n\n### How the Impact Score is Calculated:\n1.  Frequency & Density (Base Score): The raw count of a term\'s appearances relative to the total length of the scanned text.\n2.  Narrative Centrality (Context Multiplier): A multiplier based on how tied a term is to the core plot. Boost scores for terms appearing near the protagonist, in chapter titles, or frequently in dialogue.\n3.  Chronological Volatility (Recency & Pattern Score): Prioritize inconsistencies in recent chapters. Lower the score for terms that were inconsistent early on but have since become consistent. Flag "Potential Term Evolutions" (e.g., a title changing after a promotion) for review with a lower error score.\n4.  Dependency & "Root" Status (Architectural Multiplier): Identify "root" inconsistencies (like a sect\'s name) that cause a cascade of "dependent" inconsistencies (like titles "Sect Elder," "Sect Disciple"). The root term receives a massive priority multiplier.\n\n### Priority Levels (Based on Calculated Impact Score):\n- [Priority: CRITICAL]: High-frequency, high-centrality terms with ongoing volatility. Main character names, core concepts in chapter titles, or major "root" inconsistencies.\n- [Priority: HIGH]: Important secondary characters, key locations, or recurring abilities that are inconsistent in recent chapters.\n- [Priority: MEDIUM]: Supporting elements, items, or inconsistencies that are less frequent or occurred in earlier chapters.\n- [Priority: LOW]: Minor background elements, one-off mentions with variations, or confirmed "Term Evolutions" that just need a final check.\n- [Priority: STYLISTIC]: All localization and formatting suggestions (usernames, honorifics) are grouped here.\n- [Priority: INFO]: Informational notes, such as \'Potential Alias Clusters\' or \'Potential Nuance Clusters\'.\n\n## Improved Detection Logic\nThink step by step in your analysis: 1. Scan the text for recurring terms. 2. Build entity profiles and link aliases using contextual clues. 3. Calculate impact scores based on frequency, centrality, volatility, and dependencies. 4. Verify each detection for high-confidence errors (reflect: Is this an unintentional inconsistency or a nuance/evolution? Discard if not a true error). 5. Generate data-driven suggestions.\n1.  QUOTE NORMALIZATION (CRITICAL): Before comparing any terms for inconsistencies, first normalize all quotation marks by stripping them. Terms like "Project Doomsday", \'Project Doomsday\', and “Project Doomsday” should be treated as the SAME term "Project Doomsday" for comparison purposes. Only flag an inconsistency if the CORE TEXT (excluding quotes) differs.\n2.  Contextual Verification Snippets: For each potential inconsistency, extract and present a brief contextual snippet (1-2 sentences) for each variant to verify the match.\n3.  Disambiguation Logic for Similar Terms: If two similar-sounding terms like "Flame Art" and "Blaze Art" appear in the same chapter or are used by different characters in the same context, treat them as distinct entities.\n4.  Source Term Inference: Infer a probable source term or pinyin as the "Original Concept" anchor for grouping variations (e.g., group "Li Fuchen," "Li Fu Chen," and "Lee Fuchen" under an inferred anchor like `[Li Fuchen]`).\n5.  Conceptual Anchoring: If terms with low string similarity share conceptual anchors (e.g., consistently associated with the same character or location), create a high-confidence link.\n6.  Component-Based Matching: Break down long names into core components (e.g., [Azure Dragon] + [Flame/Burning] + [Sword/Blade]) and match based on the core entity and synonymous descriptors.\n7.  Relational Inconsistency Detection: Identify "Relational Clusters" where inconsistencies are linked (e.g., a character\'s name changing along with their title in the same chapter).\n8.  Track and Flag Chronological Inconsistencies (Term Evolution): If a term disappears and is consistently replaced by a new one from a specific chapter onward, flag it as a "Potential Term Evolution" rather than a simple error.\n9.  Speaker-Based Disambiguation: Associate terms with the characters who use them to avoid false positives.\n10.  Proactively Identify "Root" Inconsistencies: Identify "root" terms that cause multiple dependent inconsistencies and prioritize them.\n11. Advanced Entity Recognition (Aliases & Nicknames): Build a profile for each key entity. Use contextual clues (explicit links like "...friends called him Jon" or implicit links like shared attributes) to link different names to the same entity. CRITICAL: When you encounter terms like \'BattlefieldAtmosphereGroup\' and \'BattlefieldOldBro\' used for the same character, analyze the context carefully - these are clearly shorthand variants of the same entity. Look for phrases like "also known as", "also called", "alias", "shorthand", "nickname", or contextual patterns where one term consistently refers to the same character as another term. Do NOT flag these as inconsistencies - they are intentional variations used in the story.\n12. Username Analysis Protocol:\n    *   Formatting Trigger: Flag any potential username containing one or more literal space characters (e.g., \'Elderly Abin\').\n    *   Lexical Trigger: Flag any potential username matching pinyin, Japanese Romaji, Korean Romanization, or other non-English romanized language patterns. Do not flag fluent, multi-word English usernames.\n    *   Formatting Exemption: You MUST NOT flag potential usernames that are presented as a single, concatenated word (e.g., \'PlayerName\', \'AnotherUser\'), even if they use internal capitalization (PascalCase). This is a standard and acceptable format.\n    *   Holistic Analysis: If a username is flagged by BOTH triggers, you MUST provide BOTH formatting and localization suggestions.\n    *   Contextual Differentiation: You MUST NOT flag a name for username-style inconsistencies if the context explicitly identifies the character as an NPC (e.g., \'secretary,\' \'guard,\' \'shopkeeper\'). Username analysis should only apply when context strongly suggests a player character (e.g., mentions of \'player,\' \'ID,\' \'leaderboard\').\n13. Non-English Honorifics Handling: Pattern-match for common honorifics, explain their nuance, and present options that align with common genre practices.\n14. Low-Frequency Alias Boosting: Apply a confidence boost to low-frequency terms if they exhibit strong conceptual ties to high-frequency core entities.\n15. Nuance Analysis: When detecting semantically similar terms, analyze usage patterns. If patterns suggest an intentional conceptual distinction (e.g., state vs. government), flag as \'Potential Nuance Cluster\' instead of an inconsistency.\n16. Enhanced Alias Recognition Pattern: Look for these specific patterns that indicate intentional aliases, not inconsistencies:\n    - Contextual indicators: "also known as", "alias", "shorthand", "nickname", "undercover", "went by"\n    - Game/online context: References to usernames, player IDs, gaming handles, or online personas\n    - Sequential usage: Same character being referred to with different names in different chapters\n    - Character development: Names changing as part of character progression or identity evolution\n    - Example pattern: A character with full username \'BattlefieldAtmosphereGroup\' using shorter variants like \'BattlefieldOldBro\' or \'BattlefieldAtmoGroup\' - these are deliberate shorthand, not errors\n    - When you see this pattern, mark as \'INFO\' priority with explanation about intentional alias usage\n17. Pinyin vs. English Mismatch: Identify and flag pinyin terms used inconsistently within a group of otherwise standardized English terms. For example, if a character\'s skills are \'Fireball\', \'Ice Lance\', and \'Shenlong Po\', flag \'Shenlong Po\' as a potential localization inconsistency and suggest an English equivalent.\n\n16. Localization Suggestions Logic:\n    - Localization suggestions should ONLY appear for terms that are in pinyin, Chinese characters, or other non-English formats\n    - If a term is already in English or appears to be an established English term in context, DO NOT suggest localization\n    - For pinyin terms, provide localization suggestions only if there is no reasonable English equivalent already established in the context\n    - If a pinyin term appears multiple times and all instances suggest the same English meaning, treat it as a proper noun (character name, place name, etc.) and only suggest localization once with full explanation\n    - Avoid duplicate localization suggestions that are still in pinyin format\n    - Only use "localization suggestion" terminology when the context strongly indicates the term needs translation from Chinese/pinyin to English\n\n## Core Directives\n1.  Prioritization is Key: Always process items with the highest Impact Score first.\n2.  Be a Data-Driven Partner: All suggestions must be supported by data (frequency, context, etc.).\n3.  Enhance the Reading Experience: Focus on changes that have the biggest positive impact on story comprehension.\n4.  Ensure Complete Report Population: For all detected items, always populate the \'variations\' section with the identified variants, including their appearance counts, chapters, and context snippets.\n5.  Recommend the Best Suggestion: For each inconsistency, you MUST identify the single best suggestion and add the field "is_recommended": true to it. Only one suggestion per group should have this flag.\n6.  Use Plain Text: Do not use any markdown formatting like bold or italics within the JSON fields, especially in \'explanation\', \'reasoning\', and \'suggestion\' fields. Use plain text only to ensure compatibility and reduce token usage.\n7.  Treat Each Finding as a Unique Concept: Each unique term or entity identified as an issue (e.g., an inconsistent name, a username with spaces, a pinyin term needing localization) MUST be treated as its own separate \'concept\'. Do NOT group multiple distinct entities under a single generic concept. For example, if you find two usernames \'Player One\' and \'Player Two\', they must be reported as two separate items in the JSON array, each with its own \'concept\' field set to the respective username. Similarly, if \'FangChang\' and \'TengTeng\' both need localization, they are two separate concepts.\n\n## Examples (Few-Shot Demonstration)\nExample 1: Text: --- CHAPTER 1 --- The hero Li Fuchen fought in Li City. --- CHAPTER 2 --- Lee Fu Chen escaped to Lee City.\nStep-by-Step Analysis: 1. Scan: Terms \'Li Fuchen\', \'Lee Fu Chen\' (names); \'Li City\', \'Lee City\' (locations). 2. Profile: Link as same entity via context (hero\'s journey). 3. Impact: High frequency, central to plot -> CRITICAL. 4. Verify: Unintentional inconsistency, not evolution. 5. Suggestions: Standardize name to \'Li Fuchen\' (frequency: 2, first appearance Ch1).\n\nQuote Normalization Example: Text: --- CHAPTER 1 --- The hero said "Project Doomsday" was dangerous. --- CHAPTER 2 --- The villain whispered \'Project Doomsday\' again. --- CHAPTER 3 --- The report mentioned "Project Doomsday" frequently.\nStep-by-Step Analysis: 1. Scan: Terms \'Project Doomsday\', \'Project Doomsday\', \'Project Doomsday\' (same term with different quote styles). 2. Normalize: Strip all quotation marks to compare core terms. 3. Verify: All variations are the same term "Project Doomsday" with different quote formatting. 4. Decision: This is NOT an inconsistency - it\'s a false positive caused by different chapters being processed by different quote conversion scripts. 5. Action: Do NOT flag this as an inconsistency.\n\nOutput JSON:\n```json\n[\n  {\n    "concept": "Li Fuchen",\n    "priority": "CRITICAL",\n    "explanation": "Inconsistent name translations for the main character.",\n    "suggestions": [\n      {\n        "display_text": "Standardize to \'Li Fuchen\'",\n        "suggestion": "Li Fuchen",\n        "reasoning": "This is the first and most frequently used variant.",\n        "is_recommended": true\n      }\n    ],\n    "variations": [\n      {\n        "phrase": "Li Fuchen",\n        "chapter": "1",\n        "context_snippet": "The hero Li Fuchen fought..."\n      },\n      {\n        "phrase": "Lee Fu Chen",\n        "chapter": "2",\n        "context_snippet": "Lee Fu Chen escaped..."\n      }\n    ]\n  }\n]\n```\n\nBase all detections exclusively on the provided text; use plain text only in JSON fields.';n+=`\n\nHere is the text to analyze:\n---\n${e}\n---`;const i='\n         [\n           {\n             "concept": "The core concept or inferred original term.",\n             "priority": "CRITICAL | HIGH | MEDIUM | LOW | STYLISTIC | INFO",\n             "explanation": "A brief explanation of the inconsistency or issue.",\n             "suggestions": [\n               {\n                 "display_text": "A user-friendly description of the suggestion (e.g., \'Standardize to \\\'Term A\\\' everywhere.\')",\n                 "suggestion": "The exact, clean text to be used for replacement (e.g., \'Term A\'). This field MUST NOT contain conversational text like \'Standardize to...\'. Use an empty string (\\"\\") for informational suggestions.",\n                 "reasoning": "The detailed reasoning behind this suggestion.",\n                 "is_recommended": "Optional. A boolean (true) indicating if this is the AI\'s top recommendation. Only one suggestion per concept should have this flag."\n               }\n             ],\n             "variations": [\n               {\n                 "phrase": "The specific incorrect/variant phrase found.",\n                 "chapter": "The chapter number as a string.",\n                 "context_snippet": "A snippet of text showing the context."\n               }\n             ]\n           }\n         ]';if(t.length>0){const e=t.filter(e=>{const t=function(e){if(!e||"object"!=typeof e)return!1;if(!e.concept||"string"!=typeof e.concept||""===e.concept.trim())return!1;if(!e.explanation||"string"!=typeof e.explanation||""===e.explanation.trim())return!1;if(!e.variations||!Array.isArray(e.variations)||0===e.variations.length)return!1;for(const t of e.variations){if(!t.phrase||"string"!=typeof t.phrase||""===t.phrase.trim())return!1;if(!t.chapter||"string"!=typeof t.chapter||""===t.chapter.trim())return!1;if(!t.context_snippet||"string"!=typeof t.context_snippet)return!1}return!0}(e);return t||y(`Filtered out invalid result from context: ${e.concept||"Unknown concept"}`),t});0===e.length?y("All existing results failed validation, proceeding without context"):y(`Context validation: ${t.length} results filtered to ${e.length} valid results`);const r=function(e,t=50){if(e.length<=t)return e;const n=e.map(e=>({...e,qualityScore:v(e)})).sort((e,t)=>t.qualityScore-e.qualityScore).slice(0,t),i=e.length-t,r={concept:`[${i} Additional Items Summarized]`,priority:"INFO",explanation:`Additional ${i} items from previous analysis are summarized. Focus verification on the detailed items below.`,suggestions:[],variations:[]};return y(`Context summarization: ${e.length} items reduced to ${t} detailed + 1 summarized`),[...n,r]}(e,30);n+=`\n\n## Senior Editor Verification & Continuation Task\nYou are now operating as a Senior Editor. Your task is to perform a rigorous second-pass verification on a list of potential inconsistencies identified in a previous analysis. The provided text may have been updated or corrected since the initial scan. Your judgment must be strict, and your output must be based *exclusively* on the new text provided.\n\nApply Chain of Verification: 1. For each concept, plan 2-3 critical questions to check accuracy. 2. Verify answers against the text. 3. Resolve any inconsistencies or discard if invalid (e.g., aliases, evolutions). 4. Reflect: Critique your verifications for high confidence; revise if needed.\n\nYour Mandatory Tasks:\n\n1.  Re-Scan and Re-Build Verified Inconsistencies:\n       *   For each concept in the "Previously Identified" list, you must re-scan the entire new text.\n       *   If a concept still represents a genuine, high-confidence, unintentional error that harms readability, you MUST build a completely new, fresh JSON object for it.\n       *   CRUCIAL: Do NOT copy any data from the provided list. All fields—especially \`variations\`, \`context_snippet\`, and \`priority\`—must be re-calculated and re-extracted from the current text. If a variation no longer appears, it must not be included. If new variations are found, they must be added.\n       *   Place these freshly built objects into the \`verified_inconsistencies\` array.\n\n2.  Strictly Discard Invalid Concepts:\n       *   You MUST OMIT any concept from the output if it is no longer a true error. Discard items if your deeper analysis reveals they are:\n           *   Intentional Aliases/Nicknames: (e.g., "Bob" vs. "Robert" used interchangeably).\n           *   Contextual Nuance: Similar terms with distinct meanings (e.g., "Flame Art" used by Character A vs. "Blaze Art" used by Character B).\n           *   Resolved/Corrected: The inconsistency no longer exists in the provided text.\n           *   Confirmed Term Evolution: A term is consistently replaced by another from a specific chapter onward (e.g., "Squire" becomes "Knight" after a promotion).\n           *   Initial False Positive: The original flag was an error upon closer inspection.\n       *   Discarded items should NOT appear in either output array.\n\n3.  Discover New Inconsistencies:\n       *   After completing the verification process, perform a full, fresh analysis of the text to find any NEW inconsistencies that were not on the original list.\n       *   Create a standard JSON object for each new finding.\n       *   Place these new objects into the \`new_inconsistencies\` array.\n\n## Few-Shot Example\nPreviously Identified: [{"concept": "Li Fuchen", "variations": [{"phrase": "Lee Fu Chen"}]}]\nNew Text: --- CHAPTER 1 --- The hero Li Fuchen fought. --- CHAPTER 2 --- Li Fuchen escaped.\nStep-by-Step Verification: 1. Plan questions: "Does 'Li Fuchen' appear consistently? Is 'Lee Fu Chen' still present?" 2. Verify: Scan text – 'Lee Fu Chen' is gone, inconsistency resolved. 3. Resolve: Discard as corrected. 4. New Scan: Find new 'Magic Sword' vs 'Mystic Blade' inconsistency.\nOutput:\n\`\`\`json\n{\n   "verified_inconsistencies": [],\n   "new_inconsistencies": [\n     {\n       "concept": "Magic Sword",\n       "priority": "MEDIUM",\n       "explanation": "The term for the sword is inconsistent.",\n       "suggestions": [\n         {\n           "display_text": "Standardize to 'Magic Sword'",\n           "suggestion": "Magic Sword",\n           "reasoning": "Appears first.",\n           "is_recommended": true\n         }\n       ],\n       "variations": [\n         { "phrase": "Magic Sword", "chapter": "1", "context_snippet": "..." },\n         { "phrase": "Mystic Blade", "chapter": "2", "context_snippet": "..." }\n       ]\n     }\n   ]\n}\n\`\`\`\n\nPreviously Identified Inconsistencies for Verification:\n\`\`\`json\n${JSON.stringify(r.map(({concept:e,explanation:t,variations:n})=>({concept:e,explanation:t,variations:n})),null,2)}\n\`\`\`\n\nRequired Output Format:\nYour response MUST be a single, valid JSON object with two keys: \`verified_inconsistencies\` and \`new_inconsistencies\`. Both arrays must contain objects that strictly follow the provided schema. If no items are found for a category, return an empty array (\`[]\`). Do not add any conversational text outside of the final JSON object.\n\nSchema Reference:\n\`\`\`json\n${i}\n\`\`\`\n`}else n+=`\n\nIMPORTANT: Your final output MUST be ONLY a single, valid JSON array matching this specific schema. Do not include any other text, explanations, or markdown formatting outside of the JSON array itself.\n        Schema:\n        ${i}`;return n}function O(){if(!R.config.apiKeys||0===R.config.apiKeys.length)return null;const e=R.config.apiKeys.length;for(let t=0;t<e;t++){const n=(R.runtime.currentApiKeyIndex+t)%e,i=R.config.apiKeys[n];if(R.runtime.apiKeyCooldowns.has(i)){const e=R.runtime.apiKeyCooldowns.get(i);if(Date.now()<e){y(`Key at index ${n} is on cooldown. Skipping.`);continue}y(`Cooldown for key at index ${n} has expired.`),R.runtime.apiKeyCooldowns.delete(i)}return R.runtime.currentApiKeyIndex=n,{key:i,index:n}}return y("All available API keys are currently on cooldown."),null}function D(e){console.error("Inconsistency Finder:",e),R.runtime.cumulativeResults.push({error:e}),R.runtime.isAnalysisRunning=!1,re("error","Error!"),q(R.runtime.cumulativeResults)}function z(e,t=[],n=0,i=0){const r=3*Math.max(1,R.config.apiKeys.length);if(n>=r)return void D(`Analysis failed after ${n} attempts across all keys. Please check your API keys or wait a while.`);const o=O();if(!o)return void D("All API keys are currently rate-limited or failing. Please wait a moment before trying again.");const s=o.key,a=o.index;R.runtime.isAnalysisRunning=!0,re("running",`Analyzing (Key ${a+1}, Attempt ${n+1})...`);const c=e.map(e=>`--- CHAPTER ${e.chapter} ---\n${e.text}`).join("\n\n");y(`Sending ${c.length} characters to the AI. Using key index: ${a}. (Total Attempt ${n+1})`);const l={contents:[{parts:[{text:F(c,t)}]}],generationConfig:{temperature:R.config.temperature}};GM_xmlhttpRequest({method:"POST",url:`https://generativelanguage.googleapis.com/v1beta/${R.config.model}:generateContent?key=${s}`,headers:{"Content-Type":"application/json"},data:JSON.stringify(l),onload:function(r){let o,c,l;y("Received raw response from API:",r.responseText);try{o=JSON.parse(r.responseText)}catch(e){return l=`Failed to parse API response shell: ${e.message}`,void D(l)}if(o.error){const r=o.error.status,c=o.error.message||"";if(P.has(r)||c.includes("The model is overloaded")){y(`Retriable API Error (Status: ${r}) with key index ${a}. Rotating key and retrying.`);const o="RESOURCE_EXHAUSTED"===r?2:1;return R.runtime.apiKeyCooldowns.set(s,Date.now()+1e3*o),re("running","API Error. Rotating key..."),void z(e,t,n+1,i)}return void D(`API Error (Status: ${r}): ${c}`)}const d=o.candidates?.[0];if(!d||!d.content)return l="MAX_TOKENS"===d?.finishReason?"Analysis failed: The text from the selected chapters is too long, and the AI's response was cut off. Please try again with fewer chapters.":`Invalid API response: No content found. Finish Reason: ${d?.finishReason||"Unknown"}`,void D(l);try{const e=I(d.content.parts[0].text);c=JSON.parse(e),y("Successfully parsed API response content.",c)}catch(r){return i<1?(y(`Failed to parse AI response content, retrying API call once. Error: ${r.message}`),re("running","AI response malformed. Retrying..."),void z(e,t,n+1,i+1)):(l=`Failed to process AI response content after retry: ${r.message}`,void D(l))}if(R.runtime.currentApiKeyIndex=(a+1)%R.config.apiKeys.length,R.runtime.isAnalysisRunning=!1,t.length>0){if(!c.verified_inconsistencies||!c.new_inconsistencies)return void D("Invalid response format for verification run. Expected 'verified_inconsistencies' and 'new_inconsistencies' keys.");const e=c.verified_inconsistencies||[],t=c.new_inconsistencies||[];e.forEach(e=>{e.isNew=!1,e.status="Verified"}),t.forEach(e=>{e.isNew=!0}),y(`Verification complete. ${e.length} concepts re-verified. ${t.length} new concepts found.`),R.runtime.cumulativeResults=[...e,...t]}else{if(!Array.isArray(c))return void D("Invalid response format for initial run. Expected a JSON array.");c.forEach(e=>e.isNew=!0),R.runtime.cumulativeResults=c}$(),re("complete","Complete!"),document.getElementById("wtr-if-continue-btn").disabled=!1,q(R.runtime.cumulativeResults)},onerror:function(r){console.error("Inconsistency Finder: Network error:",r),y(`Network error with key index ${a}. Rotating key and retrying.`),R.runtime.apiKeyCooldowns.set(s,Date.now()+1e3),re("running","Network Error. Rotating key..."),z(e,t,n+1,i)}})}function B(e,t=[],n=1,i=1){if(i>n)return R.runtime.isAnalysisRunning=!1,re("complete",n>1?`Complete! (Deep Analysis: ${n} iterations)`:"Complete!"),document.getElementById("wtr-if-continue-btn").disabled=!1,void q(R.runtime.cumulativeResults);y(`Starting deep analysis iteration ${i}/${n}`),re("running",n>1||i>1?`Deep Analysis (${i}/${n})...`:"Analyzing...");const r=R.runtime.cumulativeResults.length>0?R.runtime.cumulativeResults:t;n>1?function(e,t,n,i){const r=3*Math.max(1,R.config.apiKeys.length);let o=0,s=0;const a=()=>{if(o>=r)return void D(`Deep analysis iteration ${i} failed after ${o} attempts. Please check your API keys or wait a while.`);const c=O();if(!c)return void D("All API keys are currently rate-limited or failing. Please wait a moment before trying again.");const l=c.key,d=c.index,u=e.map(e=>`--- CHAPTER ${e.chapter} ---\n${e.text}`).join("\n\n");y(`Deep Analysis Iteration ${i}/${n}: Sending ${u.length} characters to the AI. Using key index: ${d}. (Total Attempt ${o+1})`);const p={contents:[{parts:[{text:F(u,t)}]}],generationConfig:{temperature:R.config.temperature}};GM_xmlhttpRequest({method:"POST",url:`https://generativelanguage.googleapis.com/v1beta/${R.config.model}:generateContent?key=${l}`,headers:{"Content-Type":"application/json"},data:JSON.stringify(p),onload:function(r){let c,u,p;y("Received raw response from API:",r.responseText);try{c=JSON.parse(r.responseText)}catch(e){return p=`Failed to parse API response shell: ${e.message}`,void D(p)}if(c.error){const e=c.error.status,t=c.error.message||"";if(P.has(e)||t.includes("The model is overloaded")){y(`Retriable API Error (Status: ${e}) with key index ${d}. Rotating key and retrying.`);const t="RESOURCE_EXHAUSTED"===e?2:1;return R.runtime.apiKeyCooldowns.set(l,Date.now()+1e3*t),re("running","API Error. Rotating key..."),o++,void a()}return void D(`API Error (Status: ${e}): ${t}`)}const f=c.candidates?.[0];if(!f||!f.content)return p="MAX_TOKENS"===f?.finishReason?"Analysis failed: The text from the selected chapters is too long, and the AI's response was cut off. Please try again with fewer chapters.":`Invalid API response: No content found. Finish Reason: ${f?.finishReason||"Unknown"}`,void D(p);try{const e=I(f.content.parts[0].text);u=JSON.parse(e),y("Successfully parsed API response content.",u)}catch(e){return s<1?(y(`Failed to parse AI response content, retrying API call once. Error: ${e.message}`),re("running","AI response malformed. Retrying..."),o++,s++,void a()):(p=`Failed to process AI response content after retry: ${e.message}`,void D(p))}R.runtime.currentApiKeyIndex=(d+1)%R.config.apiKeys.length;if(t.length>0){if(!u.verified_inconsistencies||!u.new_inconsistencies)return void D("Invalid response format for verification run. Expected 'verified_inconsistencies' and 'new_inconsistencies' keys.");const e=u.verified_inconsistencies||[],t=u.new_inconsistencies||[];e.forEach(e=>{e.isNew=!1,e.status="Verified"}),t.forEach(e=>{e.isNew=!0}),y(`Deep Analysis Iteration ${i}: ${e.length} concepts re-verified. ${t.length} new concepts found.`);const n=[...e,...t];R.runtime.cumulativeResults=x(R.runtime.cumulativeResults,n)}else{if(!Array.isArray(u))return void D("Invalid response format for initial run. Expected a JSON array.");u.forEach(e=>e.isNew=!0),R.runtime.cumulativeResults=x(R.runtime.cumulativeResults,u)}$(),R.runtime.currentIteration=i+1,i<n?setTimeout(()=>{B(e,R.runtime.cumulativeResults,n,i+1)},1e3):(R.runtime.isAnalysisRunning=!1,re("complete",`Complete! (Deep Analysis: ${n} iterations)`),document.getElementById("wtr-if-continue-btn").disabled=!1,q(R.runtime.cumulativeResults))},onerror:function(e){console.error("Inconsistency Finder: Network error:",e),y(`Network error with key index ${d}. Rotating key and retrying.`),R.runtime.apiKeyCooldowns.set(l,Date.now()+1e3),re("running","Network Error. Rotating key..."),o++,a()}})};a()}(e,r,n,i):z(e,r)}function q(e){const t=document.getElementById("wtr-if-results");t.innerHTML="";const n=document.getElementById("wtr-if-filter-select")?.value||"all";let i=e.filter(e=>!e.error&&e.concept);const r=e.filter(e=>e.error);if("new"===n?i=i.filter(e=>e.isNew):"verified"===n?i=i.filter(e=>"Verified"===e.status||!1===e.isNew&&"Verified"!==e.status):"all"!==n&&(i=i.filter(e=>e.priority===n)),0===i.length&&0===r.length)return void(t.innerHTML='<div class="wtr-if-no-results">No inconsistencies found matching the current filter.</div>');const o={CRITICAL:1,HIGH:2,MEDIUM:3,LOW:4,STYLISTIC:5,INFO:6};i.sort((e,t)=>(o[e.priority]||99)-(o[t.priority]||99));const s=document.createDocumentFragment();i.forEach(e=>{const t=document.createElement("div");t.className="wtr-if-result-group";const n=[...new Set(e.variations.map(e=>e.phrase))],i=JSON.stringify(n),r=(e.suggestions||[]).map((t,n)=>{const r=t.suggestion;let o="",s=!1;if("string"==typeof r&&r&&""!==r.trim())o=r.trim(),s=!0;else if(t.display_text&&t.display_text.trim()){const e=t.display_text.replace(/^(standardize to|use|change to|replace with|update to)\s*/i,"").replace(/^['"`]|['"`]$/g,"").trim();e&&e!==t.display_text&&(o=e,s=!0)}R.config.loggingEnabled&&!s&&y(`Suggestion validation for "${e.concept}" #${n}:`,{originalSuggestion:r,displayText:t.display_text,finalSuggestionValue:o,isActionable:s});const a=s?`<code>${S(o)}</code>`:"<em>(Informational, no replacement)</em>",c=s?"":"disabled",l=s?`Apply '${S(o)}'`:"No direct replacement",d=t.is_recommended?'<span class="wtr-if-recommended-badge">Recommended</span>':"";return`\n             <div class="wtr-if-suggestion-item">\n                 <div class="wtr-if-suggestion-header">\n                     <span class="wtr-if-correct">${S(t.display_text||r||"No suggestion available")} ${d}</span>\n                     <div class="wtr-if-suggestion-actions">\n                         <button class="wtr-if-apply-btn" data-action="apply-selected" data-suggestion="${S(o)}" title="${l} to selected variations" ${c}>Apply Selected</button>\n                         <button class="wtr-if-apply-btn" data-action="apply-all" data-suggestion="${S(o)}" data-variations='${S(i)}' title="${l} to all variations" ${c}>Apply All</button>\n                     </div>\n                 </div>\n                 <p class="wtr-if-replacement-info"><strong>Replacement:</strong> ${a}</p>\n                 <p class="wtr-if-reasoning">${S(t.reasoning)}</p>\n             </div>\n             `}).join("");t.innerHTML=`\n                <div class="wtr-if-group-header">\n                    <h3>\n                        <span class="wtr-if-priority wtr-if-priority-${(e.priority||"info").toLowerCase()}">${S(e.priority||"INFO")}</span>\n                        Concept: <span class="wtr-if-concept">${S(e.concept)}</span>\n                        ${"Verified"===e.status||!1===e.isNew&&"Verified"!==e.status?'<span class="wtr-if-verified-badge">Verified</span>':""}\n                    </h3>\n                    <p class="wtr-if-explanation">${S(e.explanation)}</p>\n                </div>\n                <div class="wtr-if-details-section">\n                    <h4>Variations Found</h4>\n                    <div class="wtr-if-variations">\n                        ${(e.variations||[]).map(e=>`\n                        <div class="wtr-if-variation-item">\n                            <div class="wtr-if-variation-header">\n                                <input type="checkbox" class="wtr-if-variation-checkbox" value="${S(e.phrase)}" title="Select this variation">\n                                <button class="wtr-if-copy-variation-btn" data-text="${S(e.phrase)}" title="Copy variation text">📋</button>\n                                <span class="wtr-if-incorrect">"${S(e.phrase)}"</span>\n                                <span class="wtr-if-chapter">Chapter ${S(e.chapter)}</span>\n                            </div>\n                            <p class="wtr-if-context"><strong>Context:</strong> <em>"...${S(e.context_snippet)}..."</em></p>\n                        </div>\n                        `).join("")}\n                    </div>\n                </div>\n                <div class="wtr-if-details-section">\n                    <h4>Suggestions</h4>\n                    <div class="wtr-if-suggestions">\n                        ${r}\n                    </div>\n                </div>\n            `,s.appendChild(t)}),t.appendChild(s),r.slice().reverse().forEach(e=>{const n=document.createElement("div");n.className="wtr-if-error",n.textContent=e.error,t.prepend(n)}),t.querySelectorAll(".wtr-if-apply-btn").forEach(e=>e.addEventListener("click",Y)),t.querySelectorAll(".wtr-if-copy-variation-btn").forEach(e=>e.addEventListener("click",W))}function _(e=!1){if(R.runtime.isAnalysisRunning)return void alert("An analysis is already in progress.");if(!R.config.apiKeys||0===R.config.apiKeys.length||!R.config.model)return alert("Please add at least one API key and select a model in the Configuration tab first."),document.querySelector('.wtr-if-tab-btn[data-tab="config"]').click(),void ie(!0);const t=Math.max(1,parseInt(R.config.deepAnalysisDepth)||1);e||(R.runtime.cumulativeResults=[],R.runtime.apiKeyCooldowns.clear(),R.runtime.currentApiKeyIndex=0,R.runtime.currentIteration=1,R.runtime.totalIterations=t,document.getElementById("wtr-if-results").innerHTML="",document.getElementById("wtr-if-continue-btn").disabled=!0,document.getElementById("wtr-if-filter-select").value="all",M()),e&&R.session.hasSavedResults&&(document.getElementById("wtr-if-continue-btn").disabled=!1),R.config.useJson?(document.getElementById("wtr-if-file-input").dataset.continuation=e,document.getElementById("wtr-if-file-input").click()):(B(b(w()),e?R.runtime.cumulativeResults:[],t),ie(!1))}function j(){const e=document.querySelectorAll(".wtr-if-api-key-input"),t=[];e.forEach(e=>{const n=e.value.trim();n&&t.push(n)}),R.config.apiKeys=t,R.config.model=document.getElementById("wtr-if-model").value,R.config.useJson=document.getElementById("wtr-if-use-json").checked,R.config.loggingEnabled=document.getElementById("wtr-if-logging-enabled").checked,R.config.temperature=parseFloat(document.getElementById("wtr-if-temperature").value);const n=document.getElementById("wtr-if-status");n.textContent="Saving...";const i=N();n.textContent=i?"Configuration saved successfully!":"Failed to save configuration.",setTimeout(()=>n.textContent="",3e3)}function H(){_(!1)}function U(){_(!0)}function K(e){const t=e.target.files[0];if(!t)return;const n="true"===e.target.dataset.continuation,i=new FileReader;i.onload=t=>{try{const e=JSON.parse(t.target.result),i=function(){const e=window.location.pathname.match(/novel\/\d+\/([^/]+)/);return e?e[1]:null}();if(y(`Detected novel slug: "${i}"`),!e||"object"!=typeof e)throw new Error("File is not a valid JSON object.");if(!e.terms||"object"!=typeof e.terms)throw new Error("JSON must contain a top-level 'terms' object.");const r=e.terms[i];if(void 0===r)y(`No replacement terms found for novel slug "${i}" in the JSON file.`),alert(`No terms found for the current novel ("${i}") in this file. Analysis will proceed without replacements.`);else{if(!Array.isArray(r))throw new Error(`The entry for "${i}" must be an array of term objects.`);if(r.length>0&&(!r[0].hasOwnProperty("original")||!r[0].hasOwnProperty("replacement")))throw new Error(`Term objects for "${i}" must contain 'original' and 'replacement' properties.`)}const o=b(w(),r||[]),s=Math.max(1,parseInt(R.config.deepAnalysisDepth)||1);B(o,n?R.runtime.cumulativeResults:[],s),ie(!1)}catch(e){alert("Failed to read or parse the JSON file. Error: "+e.message)}finally{e.target.value=""}},i.readAsText(t)}function J(){if(R.session.hasSavedResults){q(R.runtime.cumulativeResults);const e=document.getElementById("wtr-if-session-restore");e&&(e.style.display="none");const t=document.getElementById("wtr-if-continue-btn");t&&(t.disabled=!1);const n=document.getElementById("wtr-if-status");n&&(n.textContent=`Restored ${R.runtime.cumulativeResults.length} results from previous session`,setTimeout(()=>n.textContent="",3e3))}}function V(){M();const e=document.getElementById("wtr-if-session-restore");e&&(e.style.display="none");const t=document.getElementById("wtr-if-continue-btn");t&&(t.disabled=!0);const n=document.getElementById("wtr-if-status");n&&(n.textContent="Saved session results cleared",setTimeout(()=>n.textContent="",3e3))}function G(){const e=document.getElementById("wtr-if-status-indicator");(e.classList.contains("complete")||e.classList.contains("error"))&&(ie(!0),document.querySelector('.wtr-if-tab-btn[data-tab="finder"]').click(),q(R.runtime.cumulativeResults),re("hidden"))}function Y(e){const t=e.currentTarget,n=t.dataset.action,i=t.dataset.suggestion||"";let r=[];R.config.loggingEnabled&&y("Button click analysis:",{action:n,replacementValue:i,replacementLength:i?i.length:"empty",buttonDataset:t.dataset}),"apply-all"===n?r=JSON.parse(t.dataset.variations):"apply-selected"===n&&t.closest(".wtr-if-result-group").querySelectorAll(".wtr-if-variation-checkbox:checked").forEach(e=>r.push(e.value));const o=[...new Set(r)];if(0===o.length){const e=t.textContent;return t.textContent="None Selected!",void setTimeout(()=>{t.textContent=e},2e3)}let s,a;o.length>1?(o.sort((e,t)=>t.length-e.length),s=o.map(e=>k(e)).join("|"),a=!0,y(`Applying suggestion "${i}" via multi-term regex: /${s}/gi`)):(s=o[0],a=!1,y(`Applying suggestion "${i}" via simple replacement for: "${s}"`));const c=i&&""!==i.trim()?i.trim():null;if(!c){y("ERROR: Empty or invalid replacement value detected. Aborting term addition.",{originalReplacement:i,variations:o});const e=t.textContent;return t.textContent="Invalid Suggestion!",t.style.backgroundColor="#dc3545",void setTimeout(()=>{t.textContent=e,t.style.backgroundColor=""},3e3)}const l=new CustomEvent("wtr:addTerm",{detail:{original:s,replacement:c,isRegex:a}});window.dispatchEvent(l);const d=t.textContent;t.classList.add("sent"),t.textContent="Applied!",setTimeout(()=>{t.classList.remove("sent"),t.textContent=d},2e3)}function W(e){const t=e.currentTarget,n=t.dataset.text;n&&navigator.clipboard.writeText(n).then(()=>{const e=t.innerHTML;t.innerHTML="✅",t.disabled=!0,setTimeout(()=>{t.innerHTML=e,t.disabled=!1},1500)}).catch(e=>{console.error("Inconsistency Finder: Failed to copy text:",e);const n=t.innerHTML;t.innerHTML="❌",setTimeout(()=>{t.innerHTML=n},1500)})}function X(){const e={version:"5.2",timestamp:(new Date).toISOString(),config:R.config,preferences:{autoRestoreResults:R.preferences.autoRestoreResults}},t=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),n=URL.createObjectURL(t),i=document.createElement("a");i.href=n,i.download=`WTR Lab Term Inconsistency Finder-5.2-config-${(new Date).toISOString().split("T")[0]}.json`,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(n);const r=document.getElementById("wtr-if-status");r.textContent="Configuration exported successfully",setTimeout(()=>r.textContent="",3e3)}function Q(){const e=document.createElement("input");e.type="file",e.accept=".json",e.onchange=e=>{const t=e.target.files[0];if(!t)return;const n=new FileReader;n.onload=e=>{try{const t=JSON.parse(e.target.result);if(!t.config||!t.version)throw new Error("Invalid configuration file format");R.config,R.config={...R.config,...t.config},t.preferences&&(R.preferences={...R.preferences,...t.preferences}),N(),te(),Z(),document.getElementById("wtr-if-use-json").checked=R.config.useJson,document.getElementById("wtr-if-logging-enabled").checked=R.config.loggingEnabled,document.getElementById("wtr-if-auto-restore").checked=R.preferences.autoRestoreResults,document.getElementById("wtr-if-temperature").value=R.config.temperature,document.getElementById("wtr-if-temp-value").textContent=R.config.temperature;const n=document.getElementById("wtr-if-status");n.textContent="Configuration imported successfully",setTimeout(()=>n.textContent="",3e3)}catch(e){alert("Failed to import configuration: "+e.message)}},n.readAsText(t)},e.click()}async function Z(){const e=document.getElementById("wtr-if-model");e.innerHTML="<option>Loading from cache...</option>",e.disabled=!0;const t=await GM_getValue(C,null);t&&t.models&&t.models.length>0?(e.innerHTML=t.models.map(e=>`<option value="${e}">${e.replace("models/","")}</option>`).join(""),e.value=R.config.model):e.innerHTML='<option value="">No models cached. Please refresh.</option>',e.disabled=!1}async function ee(){const e=O(),t=document.getElementById("wtr-if-status");if(!e)return t.textContent="Error: No available API keys. Add one or wait for cooldowns.",void setTimeout(()=>t.textContent="",4e3);const n=e.key;t.textContent="Fetching model list...",document.getElementById("wtr-if-refresh-models-btn").disabled=!0,GM_xmlhttpRequest({method:"GET",url:`https://generativelanguage.googleapis.com/v1beta/models?key=${n}`,onload:async function(e){try{const n=JSON.parse(e.responseText);if(n.error)throw new Error(n.error.message);const i=n.models.filter(e=>e.supportedGenerationMethods.includes("generateContent")).map(e=>e.name);i.length>0?(await GM_setValue(C,{timestamp:Date.now(),models:i}),t.textContent=`Success! Found ${i.length} models.`,await Z()):t.textContent="No compatible models found."}catch(e){t.textContent=`Error: ${e.message}`}finally{setTimeout(()=>t.textContent="",4e3),document.getElementById("wtr-if-refresh-models-btn").disabled=!1}},onerror:function(e){console.error("Model fetch error:",e),t.textContent="Network error while fetching models.",setTimeout(()=>t.textContent="",4e3),document.getElementById("wtr-if-refresh-models-btn").disabled=!1}})}function te(){const e=document.getElementById("wtr-if-api-keys-container");e.innerHTML="",(R.config.apiKeys.length>0?R.config.apiKeys:[""]).forEach(t=>{const n=document.createElement("div");n.className="wtr-if-key-row",n.innerHTML=`\n            <input type="password" class="wtr-if-api-key-input" value="${S(t)}" placeholder="Enter your API key">\n            <button class="wtr-if-remove-key-btn" title="Remove this key">&times;</button>\n        `,e.appendChild(n)})}function ne(){const e=document.getElementById("wtr-if-api-keys-container"),t=document.createElement("div");t.className="wtr-if-key-row",t.innerHTML='\n        <input type="password" class="wtr-if-api-key-input" placeholder="Enter your API key">\n        <button class="wtr-if-remove-key-btn" title="Remove this key">&times;</button>\n    ',e.appendChild(t),t.querySelector("input").focus()}async function ie(e=null){const t=document.getElementById("wtr-if-panel"),n="flex"===t.style.display,i=null!==e?e:!n;if(t.style.display=i?"flex":"none",i){te(),document.getElementById("wtr-if-use-json").checked=R.config.useJson,document.getElementById("wtr-if-logging-enabled").checked=R.config.loggingEnabled,document.getElementById("wtr-if-auto-restore").checked=R.preferences.autoRestoreResults;const e=document.getElementById("wtr-if-temperature"),n=document.getElementById("wtr-if-temp-value");e.value=R.config.temperature,n.textContent=R.config.temperature,t.querySelectorAll(".wtr-if-tab-btn").forEach(e=>e.classList.remove("active")),t.querySelectorAll(".wtr-if-tab-content").forEach(e=>e.classList.remove("active"));const i=t.querySelector(`.wtr-if-tab-btn[data-tab="${R.config.activeTab}"]`),r=t.querySelector(`#wtr-if-tab-${R.config.activeTab}`);i&&i.classList.add("active"),r&&r.classList.add("active"),document.getElementById("wtr-if-deep-analysis-depth").value=R.config.deepAnalysisDepth.toString(),document.getElementById("wtr-if-filter-select").value=R.config.activeFilter,await Z();const o=document.getElementById("wtr-if-session-restore");R.session.hasSavedResults&&R.preferences.autoRestoreResults?J():R.session.hasSavedResults?o.style.display="block":o.style.display="none"}}function re(e,t=""){const n=document.getElementById("wtr-if-status-indicator");if(!n)return;const i=n.querySelector(".wtr-if-status-icon"),r=n.querySelector(".wtr-if-status-text");n.className=e,r.textContent=t,i.textContent="",n.style.display="hidden"===e?"none":"flex",oe()}function oe(){const e=document.getElementById("wtr-if-status-indicator");if(!e)return;const t=document.querySelector(".nig-status-widget");t&&"none"!==getComputedStyle(t).display?(y("Conflict detected with .nig-status-widget, adjusting position."),e.style.bottom="80px"):e.style.bottom="20px"}!async function(){await async function(){const e=await GM_getValue(A,{});e.apiKey&&!e.apiKeys&&(y("Migrating legacy single API key to new array format."),e.apiKeys=[e.apiKey],delete e.apiKey),e.preferences&&(R.preferences={...R.preferences,...e.preferences},y("Loaded preferences from config:",R.preferences)),R.config={...R.config,...e};const t=sessionStorage.getItem(T);if(t)try{const e=JSON.parse(t),n=e.results||[],i=n.map(e=>e.suggestions&&Array.isArray(e.suggestions)?{...e,suggestions:e.suggestions.map(L)}:e);if(R.runtime.cumulativeResults=i,R.session.hasSavedResults=!0,R.session.lastAnalysisTime=e.timestamp,y("Session results loaded and sanitized:",R.runtime.cumulativeResults.length,"items"),i.length!==n.length)y("🔧 Data sanitization: Results count changed during cleanup");else{let e=0;for(let t=0;t<i.length;t++){const r=n[t],o=i[t];if(r.suggestions&&o.suggestions)for(let t=0;t<o.suggestions.length;t++)r.suggestions[t]?.suggestion!==o.suggestions[t]?.suggestion&&e++}e>0&&y(`🔧 Data sanitization: Fixed ${e} corrupted suggestion fields`)}}catch(e){y("Failed to parse session results:",e)}}(),y("Configuration loaded."),function(){if(document.getElementById("wtr-if-panel"))return;const e=document.createElement("div");e.id="wtr-if-panel",e.innerHTML='\n            <div class="wtr-if-header"><h2>Term Inconsistency Finder 5.3.2</h2><button class="wtr-if-close-btn">&times;</button></div>\n            <div class="wtr-if-tabs">\n                <button class="wtr-if-tab-btn" data-tab="finder">Finder</button>\n                <button class="wtr-if-tab-btn" data-tab="config">Configuration</button>\n            </div>\n            <div class="wtr-if-content">\n                <input type="file" id="wtr-if-file-input" accept=".json" style="display: none;">\n                <div id="wtr-if-tab-finder" class="wtr-if-tab-content">\n                    \x3c!-- Primary Analysis Controls Section --\x3e\n                    <div class="wtr-if-section">\n                        <div class="wtr-if-section-header">\n                            <h3><i class="wtr-if-icon">🔍</i> Primary Analysis Controls</h3>\n                        </div>\n                        <div class="wtr-if-section-content">\n                            <div class="wtr-if-finder-controls">\n                                <button id="wtr-if-find-btn" class="wtr-if-btn wtr-if-btn-primary wtr-if-btn-large">Find Inconsistencies</button>\n                                <button id="wtr-if-continue-btn" class="wtr-if-btn wtr-if-btn-secondary wtr-if-btn-large" disabled>Continue Analysis</button>\n                            </div>\n                        </div>\n                    </div>\n\n                    \x3c!-- Deep Analysis Configuration Section --\x3e\n                    <div class="wtr-if-section">\n                        <div class="wtr-if-section-header">\n                            <h3><i class="wtr-if-icon">⚙️</i> Deep Analysis Configuration</h3>\n                        </div>\n                        <div class="wtr-if-section-content">\n                            <div class="wtr-if-deep-analysis-controls">\n                                <div class="wtr-if-form-row">\n                                    <label for="wtr-if-deep-analysis-depth" class="wtr-if-form-label">Analysis Depth:</label>\n                                    <select id="wtr-if-deep-analysis-depth" class="wtr-if-form-select">\n                                        <option value="1">1 (Single Analysis)</option>\n                                        <option value="2">2 (Deep Analysis)</option>\n                                        <option value="3">3 (Very Deep Analysis)</option>\n                                        <option value="4">4 (Maximum Analysis)</option>\n                                        <option value="5">5 (Ultra Deep Analysis)</option>\n                                    </select>\n                                </div>\n                                <small class="wtr-if-hint">Run multiple analysis iterations for more comprehensive results. Higher values provide better accuracy but take longer.</small>\n                            </div>\n                        </div>\n                    </div>\n\n                    \x3c!-- Filter and Display Controls Section --\x3e\n                    <div class="wtr-if-section">\n                        <div class="wtr-if-section-header">\n                            <h3><i class="wtr-if-icon">🎛️</i> Filter and Display Controls</h3>\n                        </div>\n                        <div class="wtr-if-section-content">\n                            <div class="wtr-if-filter-controls">\n                                <div class="wtr-if-form-row">\n                                    <label for="wtr-if-filter-select" class="wtr-if-form-label">Filter Results:</label>\n                                    <select id="wtr-if-filter-select" class="wtr-if-form-select">\n                                        <option value="all">Show All</option>\n                                        <option value="new">Show New Only</option>\n                                        <option value="verified">Show Verified Only</option>\n                                        <option value="CRITICAL">Priority: Critical</option>\n                                        <option value="HIGH">Priority: High</option>\n                                        <option value="MEDIUM">Priority: Medium</option>\n                                        <option value="LOW">Priority: Low</option>\n                                        <option value="STYLISTIC">Priority: Stylistic</option>\n                                        <option value="INFO">Priority: Info</option>\n                                    </select>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n\n                    \x3c!-- Results Display Area Section --\x3e\n                    <div class="wtr-if-section">\n                        <div class="wtr-if-section-header">\n                            <h3><i class="wtr-if-icon">📋</i> Results Display Area</h3>\n                        </div>\n                        <div class="wtr-if-section-content">\n                            <div id="wtr-if-results"></div>\n                        </div>\n                    </div>\n                </div>\n                <div id="wtr-if-tab-config" class="wtr-if-tab-content">\n                    \x3c!-- API Keys Management Section --\x3e\n                    <div class="wtr-if-section">\n                        <div class="wtr-if-section-header">\n                            <h3><i class="wtr-if-icon">🔑</i> API Keys Management</h3>\n                        </div>\n                        <div class="wtr-if-section-content">\n                            <div class="wtr-if-form-group">\n                                <label>Gemini API Keys</label>\n                                <div class="wtr-if-api-keys-container-wrapper">\n                                    <div id="wtr-if-api-keys-container"></div>\n                                </div>\n                                <button id="wtr-if-add-key-btn" class="wtr-if-btn wtr-if-btn-secondary" style="margin-top: 8px; width: auto; padding: 5px 10px; font-size: 12px;">+ Add Key</button>\n                            </div>\n                        </div>\n                    </div>\n\n                    \x3c!-- Model Configuration Section --\x3e\n                    <div class="wtr-if-section">\n                        <div class="wtr-if-section-header">\n                            <h3><i class="wtr-if-icon">🤖</i> Model Configuration</h3>\n                        </div>\n                        <div class="wtr-if-section-content">\n                            <div class="wtr-if-form-group">\n                                <label for="wtr-if-model">Gemini Model</label>\n                                <div class="wtr-if-model-controls">\n                                    <select id="wtr-if-model"></select>\n                                    <button id="wtr-if-refresh-models-btn" class="wtr-if-btn wtr-if-btn-secondary">Refresh List</button>\n                                </div>\n                            </div>\n                            <div class="wtr-if-form-group">\n                                <label for="wtr-if-temperature">AI Temperature (<span id="wtr-if-temp-value">0.5</span>)</label>\n                                <input type="range" id="wtr-if-temperature" min="0" max="1" step="0.1" value="0.5">\n                                <small class="wtr-if-hint">Lower is more predictable, higher is more creative.</small>\n                            </div>\n                        </div>\n                    </div>\n\n                    \x3c!-- Advanced Settings Section --\x3e\n                    <div class="wtr-if-section">\n                        <div class="wtr-if-section-header">\n                            <h3><i class="wtr-if-icon">⚙️</i> Advanced Settings</h3>\n                        </div>\n                        <div class="wtr-if-section-content">\n                            <div class="wtr-if-form-group">\n                                <label class="checkbox-label"><input type="checkbox" id="wtr-if-use-json"> Use Term Replacer JSON File</label>\n                            </div>\n                            <div class="wtr-if-form-group">\n                                <label class="checkbox-label"><input type="checkbox" id="wtr-if-logging-enabled"> Enable Debug Logging</label>\n                                <small class="wtr-if-hint">Outputs detailed script operations to the browser console.</small>\n                            </div>\n                        </div>\n                    </div>\n\n                    \x3c!-- Data Management Section --\x3e\n                    <div class="wtr-if-section">\n                        <div class="wtr-if-section-header">\n                            <h3><i class="wtr-if-icon">💾</i> Data Management</h3>\n                        </div>\n                        <div class="wtr-if-section-content">\n                            <div class="wtr-if-form-group">\n                                <label class="checkbox-label"><input type="checkbox" id="wtr-if-auto-restore"> Auto-restore saved results on panel open</label>\n                                <small class="wtr-if-hint">Automatically offer to restore previous analysis results when opening the panel.</small>\n                            </div>\n                            <div class="wtr-if-import-export">\n                                <div class="wtr-if-form-row">\n                                    <button id="wtr-if-export-config-btn" class="wtr-if-btn wtr-if-btn-secondary">Export Configuration</button>\n                                    <button id="wtr-if-import-config-btn" class="wtr-if-btn wtr-if-btn-secondary">Import Configuration</button>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n\n                    \x3c!-- Action Section --\x3e\n                    <div class="wtr-if-section">\n                        <div class="wtr-if-section-content">\n                            <button id="wtr-if-save-config-btn" class="wtr-if-btn wtr-if-btn-primary">Save Configuration</button>\n                            <div id="wtr-if-status" class="wtr-if-status"></div>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        ',document.body.appendChild(e);const t=document.createElement("div");t.id="wtr-if-status-indicator",t.innerHTML='<div class="wtr-if-status-icon"></div><span class="wtr-if-status-text"></span>',document.body.appendChild(t),function(){const e=document.getElementById("wtr-if-panel");if(!e)return;e.querySelector(".wtr-if-close-btn").addEventListener("click",()=>ie(!1)),e.querySelector("#wtr-if-save-config-btn").addEventListener("click",j),e.querySelector("#wtr-if-find-btn").addEventListener("click",H),e.querySelector("#wtr-if-continue-btn").addEventListener("click",U),e.querySelector("#wtr-if-refresh-models-btn").addEventListener("click",ee),e.querySelector("#wtr-if-file-input").addEventListener("change",K),e.querySelector("#wtr-if-export-config-btn").addEventListener("click",X),e.querySelector("#wtr-if-import-config-btn").addEventListener("click",Q),e.querySelector("#wtr-if-restore-btn")?.addEventListener("click",J),e.querySelector("#wtr-if-clear-session-btn")?.addEventListener("click",V);const t=e.querySelector("#wtr-if-filter-select");t.addEventListener("change",()=>{q(R.runtime.cumulativeResults),R.config.activeFilter=t.value,N()}),document.getElementById("wtr-if-status-indicator").addEventListener("click",G),e.querySelector("#wtr-if-temperature").addEventListener("input",e=>{document.getElementById("wtr-if-temp-value").textContent=e.target.value}),e.querySelector("#wtr-if-auto-restore").addEventListener("change",e=>{R.preferences.autoRestoreResults=e.target.checked,N()}),e.querySelector("#wtr-if-deep-analysis-depth").addEventListener("change",e=>{R.config.deepAnalysisDepth=parseInt(e.target.value)||1,N()}),e.querySelectorAll(".wtr-if-tab-btn").forEach(t=>{t.addEventListener("click",t=>{const n=t.target.dataset.tab;e.querySelectorAll(".wtr-if-tab-btn").forEach(e=>e.classList.remove("active")),t.target.classList.add("active"),e.querySelectorAll(".wtr-if-tab-content").forEach(e=>e.classList.remove("active")),e.querySelector(`#wtr-if-tab-${n}`).classList.add("active"),R.config.activeTab=n,N()})}),e.querySelector("#wtr-if-add-key-btn").addEventListener("click",ne),e.querySelector("#wtr-if-api-keys-container").addEventListener("click",t=>{t.target.classList.contains("wtr-if-remove-key-btn")&&(e.querySelectorAll(".wtr-if-key-row").length>1?t.target.closest(".wtr-if-key-row").remove():t.target.closest(".wtr-if-key-row").querySelector("input").value="")})}()}(),new MutationObserver((e,t)=>{const n=document.querySelector("nav.bottom-reader-nav");if(n){y("Bottom navigation bar found. Attaching persistent observer."),t.disconnect(),new MutationObserver(()=>{const e=n.querySelector('div[role="group"].btn-group');if(e&&!document.getElementById("wtr-if-analyze-btn")){y("Button container found. Injecting button.");const t=document.createElement("button");t.id="wtr-if-analyze-btn",t.className="wtr btn btn-outline-dark btn-sm",t.type="button",t.title="Analyze Inconsistencies",t.innerHTML='<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a4 4 0 0 0-4 4v2a4 4 0 0 0-4 4v2a4 4 0 0 0 4 4h8a4 4 0 0 0 4-4v-2a4 4 0 0 0-4-4V6a4 4 0 0 0-4-4Z"/><path d="M12 2v20"/><path d="M12 12h8"/><path d="M12 12H4"/><path d="M12 6h6"/><path d="M12 6H6"/><path d="M12 18h6"/><path d="M12 18H6"/></svg>',t.addEventListener("click",()=>ie(!0)),e.appendChild(t)}}).observe(n,{childList:!0,subtree:!0});const e=n.querySelector('div[role="group"].btn-group');if(e&&!document.getElementById("wtr-if-analyze-btn")){const t=document.createElement("button");t.id="wtr-if-analyze-btn",t.className="wtr btn btn-outline-dark btn-sm",t.type="button",t.title="Analyze Inconsistencies",t.innerHTML='<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a4 4 0 0 0-4 4v2a4 4 0 0 0-4 4v2a4 4 0 0 0 4 4h8a4 4 0 0 0 4-4v-2a4 4 0 0 0-4-4V6a4 4 0 0 0-4-4Z"/><path d="M12 2v20"/><path d="M12 12h8"/><path d="M12 12H4"/><path d="M12 6h6"/><path d="M12 6H6"/><path d="M12 18h6"/><path d="M12 18H6"/></svg>',t.addEventListener("click",()=>ie(!0)),e.appendChild(t)}}}).observe(document.body,{childList:!0,subtree:!0}),new MutationObserver(()=>{oe()}).observe(document.body,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["style","class"]}),y("Conflict observer initialized."),GM_registerMenuCommand("Term Inconsistency Finder",()=>ie(!0))}()})();