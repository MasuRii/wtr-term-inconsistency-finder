// ==UserScript==
// @name WTR Lab Term Inconsistency Finder
// @description Finds term inconsistencies in WTR Lab chapters using Gemini AI. Supports multiple API keys with smart rotation, dynamic model fetching, and background processing.
// @version 5.3.6
// @author MasuRii
// @supportURL https://github.com/MasuRii/wtr-term-inconsistency-finder/issues
// @match https://wtr-lab.com/en/novel/*/*/*
// @connect generativelanguage.googleapis.com
// @downloadURL https://raw.githubusercontent.com/MasuRii/wtr-term-inconsistency-finder/main/dist/wtr-lab-term-inconsistency-finder.user.js
// @grant GM_setValue
// @grant GM_getValue
// @grant GM_addStyle
// @grant GM_registerMenuCommand
// @grant GM_xmlhttpRequest
// @icon https://www.google.com/s2/favicons?sz=64&domain=wtr-lab.com
// @license MIT
// @namespace http://tampermonkey.net/
// @run-at document-idle
// @updateURL https://raw.githubusercontent.com/MasuRii/wtr-term-inconsistency-finder/main/dist/wtr-lab-term-inconsistency-finder.user.js
// @website https://github.com/MasuRii/wtr-term-inconsistency-finder
// ==/UserScript==

(()=>{var e={56:(e,t,n)=>{"use strict";e.exports=function(e){var t=n.nc;t&&e.setAttribute("nonce",t)}},72:e=>{"use strict";var t=[];function n(e){for(var n=-1,i=0;i<t.length;i++)if(t[i].identifier===e){n=i;break}return n}function i(e,i){for(var o={},s=[],a=0;a<e.length;a++){var c=e[a],l=i.base?c[0]+i.base:c[0],d=o[l]||0,u="".concat(l," ").concat(d);o[l]=d+1;var p=n(u),f={css:c[1],media:c[2],sourceMap:c[3],supports:c[4],layer:c[5]};if(-1!==p)t[p].references++,t[p].updater(f);else{var g=r(f,i);i.byIndex=a,t.splice(a,0,{identifier:u,updater:g,references:1})}s.push(u)}return s}function r(e,t){var n=t.domAPI(t);return n.update(e),function(t){if(t){if(t.css===e.css&&t.media===e.media&&t.sourceMap===e.sourceMap&&t.supports===e.supports&&t.layer===e.layer)return;n.update(e=t)}else n.remove()}}e.exports=function(e,r){var o=i(e=e||[],r=r||{});return function(e){e=e||[];for(var s=0;s<o.length;s++){var a=n(o[s]);t[a].references--}for(var c=i(e,r),l=0;l<o.length;l++){var d=n(o[l]);0===t[d].references&&(t[d].updater(),t.splice(d,1))}o=c}}},92:(e,t,n)=>{"use strict";n.d(t,{A:()=>a});var i=n(601),r=n.n(i),o=n(314),s=n.n(o)()(r());s.push([e.id,'/* Utility and Status Styles */\n.wtr-if-status {\n  font-size: 14px;\n  margin-top: 10px;\n  text-align: center;\n}\n\n.wtr-if-session-restore {\n  background-color: var(--bs-info-bg-subtle, #cff4fc);\n  border: 1px solid var(--bs-info-border-subtle, #9eeaf9);\n  border-radius: 4px;\n  margin-bottom: 16px;\n  padding: 10px;\n}\n\n.wtr-if-session-restore button {\n  margin-right: 8px;\n}\n\n.wtr-if-priority {\n  border-radius: 12px;\n  color: white;\n  font-size: 12px;\n  font-weight: bold;\n  padding: 3px 8px;\n}\n\n.wtr-if-priority-critical {\n  background-color: var(--bs-danger, #dc3545);\n}\n\n.wtr-if-priority-high {\n  background-color: var(--bs-warning, #ffc107);\n  color: #000;\n}\n\n.wtr-if-priority-medium {\n  background-color: var(--bs-info, #0dcaf0);\n}\n\n.wtr-if-priority-low {\n  background-color: var(--bs-secondary, #6c757d);\n}\n\n.wtr-if-priority-stylistic,\n.wtr-if-priority-info {\n  background-color: var(--bs-light, #f8f9fa);\n  border: 1px solid #ccc;\n  color: #000;\n}\n\n.wtr-if-concept {\n  color: var(--bs-link-color, #0d6efd);\n  font-weight: bold;\n}\n\n.wtr-if-chapter {\n  background-color: var(--bs-tertiary-bg, #f8f9fa);\n  border-radius: 4px;\n  color: var(--bs-secondary-color, #6c757d);\n  font-size: 12px;\n  font-weight: bold;\n  padding: 3px 6px;\n}\n\n.wtr-if-error {\n  background-color: var(--bs-danger-bg-subtle, #f8d7da);\n  border: 1px solid var(--bs-danger, #dc3545);\n  border-radius: 4px;\n  color: var(--bs-danger-text-emphasis, #58151c);\n  margin-bottom: 10px;\n  padding: 10px;\n}\n\n.wtr-if-no-results {\n  padding: 10px;\n  text-align: center;\n}\n\n.wtr-if-verified-badge {\n  background-color: var(--bs-success, #198754);\n  border-radius: 12px;\n  color: white;\n  font-size: 11px;\n  font-weight: bold;\n  margin-left: 8px;\n  padding: 3px 8px;\n}\n\n.wtr-if-recommended-badge {\n  background-color: var(--bs-info, #0dcaf0);\n  border-radius: 12px;\n  color: white;\n  font-size: 11px;\n  font-weight: bold;\n  margin-left: 8px;\n  padding: 3px 8px;\n  vertical-align: middle;\n}\n\n/* Status Indicator */\n#wtr-if-status-indicator {\n  align-items: center;\n  background-color: #2c2c2e;\n  border-radius: 8px;\n  bottom: var(--nig-space-xl, 20px);\n  box-shadow: 0 4px 8px rgb(0 0 0 / 30%);\n  color: #f0f0f0;\n  display: none;\n  font-family: sans-serif;\n  font-size: 14px;\n  gap: 10px;\n  left: 20px;\n  padding: 10px 15px;\n  position: fixed;\n  transition:\n    background-color 0.3s ease,\n    bottom 0.3s ease;\n  z-index: 10000;\n}\n\n.wtr-if-status-icon {\n  align-items: center;\n  display: flex;\n  height: 20px;\n  justify-content: center;\n  width: 20px;\n}\n\n#wtr-if-status-indicator.running .wtr-if-status-icon {\n  animation: wtr-if-spin 1s linear infinite;\n  border: 3px solid #555;\n  border-radius: 50%;\n  border-top-color: #4285f4;\n  box-sizing: border-box;\n}\n\n#wtr-if-status-indicator.complete {\n  background-color: #4caf50;\n  cursor: pointer;\n}\n\n#wtr-if-status-indicator.complete .wtr-if-status-icon::before {\n  content: "✅";\n}\n\n#wtr-if-status-indicator.error {\n  background-color: #f44336;\n  cursor: pointer;\n}\n\n#wtr-if-status-indicator.error .wtr-if-status-icon::before {\n  content: "❌";\n}\n',""]);const a=s},113:e=>{"use strict";e.exports=function(e,t){if(t.styleSheet)t.styleSheet.cssText=e;else{for(;t.firstChild;)t.removeChild(t.firstChild);t.appendChild(document.createTextNode(e))}}},131:(e,t,n)=>{"use strict";n.d(t,{A:()=>a});var i=n(601),r=n.n(i),o=n(314),s=n.n(o)()(r());s.push([e.id,".wtr-if-btn {\n  border: none;\n  border-radius: 4px;\n  color: white;\n  cursor: pointer;\n  font-weight: bold;\n  padding: 10px 15px;\n}\n\n.wtr-if-btn:disabled {\n  cursor: not-allowed;\n  opacity: 0.6;\n}\n\n.wtr-if-btn-primary {\n  background-color: var(--bs-primary, #fd7e14);\n}\n\n.wtr-if-btn-secondary {\n  background-color: var(--bs-secondary, #6c757d);\n}\n\n.wtr-if-btn-large {\n  flex: 1;\n  font-size: 16px;\n  min-width: 180px;\n  padding: 12px 20px;\n}\n\n.wtr-if-action-buttons {\n  display: flex;\n  flex-wrap: wrap;\n  gap: 10px;\n}\n\n.wtr-if-apply-btn {\n  background-color: var(--bs-success, #198754);\n  border: none;\n  border-radius: 4px;\n  color: white;\n  cursor: pointer;\n  font-size: 12px;\n  padding: 4px 10px;\n  white-space: nowrap;\n}\n\n.wtr-if-apply-btn.sent {\n  background-color: var(--bs-secondary, #6c757d);\n}\n\n.wtr-if-copy-variation-btn {\n  background: none;\n  border: none;\n  cursor: pointer;\n  font-size: 16px;\n  line-height: 1;\n  opacity: 0.7;\n  padding: 2px 4px;\n  transition: opacity 0.2s;\n}\n\n.wtr-if-copy-variation-btn:hover {\n  opacity: 1;\n}\n",""]);const a=s},198:(e,t,n)=>{"use strict";n.d(t,{A:()=>a});var i=n(601),r=n.n(i),o=n(314),s=n.n(o)()(r());s.push([e.id,"/* Results Display Styles */\n#wtr-if-results {\n  margin-top: 10px;\n}\n\n.wtr-if-result-group {\n  background-color: var(--bs-body-bg, #fff);\n  border: 1px solid var(--bs-border-color, #dee2e6);\n  border-radius: 6px;\n  margin-bottom: 16px;\n}\n\n.wtr-if-group-header {\n  background-color: var(--bs-tertiary-bg, #f8f9fa);\n  border-bottom: 1px solid var(--bs-border-color, #dee2e6);\n  padding: 12px;\n  position: relative;\n}\n\n.wtr-if-group-header h3 {\n  align-items: center;\n  display: flex;\n  flex-wrap: wrap;\n  font-size: 16px;\n  gap: 8px;\n  margin: 0 0 8px;\n}\n\n.wtr-if-explanation {\n  font-size: 14px;\n  font-style: italic;\n  margin: 0;\n  opacity: 0.9;\n}\n\n.wtr-if-group-actions {\n  position: absolute;\n  right: 12px;\n  top: 12px;\n}\n\n.wtr-if-details-section {\n  padding: 12px;\n}\n\n.wtr-if-details-section h4 {\n  border-bottom: 1px solid var(--bs-border-color-translucent, #dee2e6);\n  font-size: 14px;\n  font-weight: bold;\n  margin-bottom: 8px;\n  margin-top: 0;\n  padding-bottom: 4px;\n}\n\n.wtr-if-variations,\n.wtr-if-suggestions {\n  display: flex;\n  flex-direction: column;\n  gap: 8px;\n}\n\n.wtr-if-variation-item {\n  border: 1px solid var(--bs-border-color-translucent, #dee2e6);\n  border-radius: 4px;\n}\n\n.wtr-if-variation-header {\n  align-items: center;\n  background-color: var(--bs-secondary-bg, #e9ecef);\n  display: flex;\n  gap: 8px;\n  justify-content: space-between;\n  padding: 6px 8px;\n}\n\n.wtr-if-incorrect {\n  color: var(--bs-danger-text-emphasis, #58151c);\n  font-weight: bold;\n}\n\n.wtr-if-variation-header .wtr-if-incorrect {\n  flex-grow: 1;\n  color: var(--bs-danger-text-emphasis, #58151c);\n  font-weight: bold;\n}\n\n.wtr-if-variation-checkbox {\n  flex-shrink: 0;\n  margin: 0;\n}\n\n.wtr-if-context {\n  font-size: 13px;\n  margin: 0;\n  padding: 6px 8px;\n}\n\n.wtr-if-suggestion-item {\n  border: 1px solid var(--bs-border-color-translucent, #dee2e6);\n  border-radius: 4px;\n  overflow: hidden;\n}\n\n.wtr-if-suggestion-header {\n  align-items: center;\n  background-color: var(--bs-success-bg-subtle, #d1e7dd);\n  display: flex;\n  justify-content: space-between;\n  padding: 8px;\n}\n\n.wtr-if-correct {\n  color: var(--bs-success-text-emphasis, #0a3622);\n  font-weight: bold;\n}\n\n.wtr-if-suggestion-header .wtr-if-correct {\n  flex-grow: 1;\n  color: var(--bs-success-text-emphasis, #0a3622);\n  font-weight: bold;\n}\n\n.wtr-if-suggestion-actions {\n  display: flex;\n  gap: 8px;\n}\n\n.wtr-if-replacement-info {\n  background-color: var(--bs-tertiary-bg, #f8f9fa);\n  border-top: 1px solid var(--bs-border-color-translucent, #dee2e6);\n  font-size: 13px;\n  margin: 0;\n  padding: 6px 8px;\n}\n\n.wtr-if-replacement-info code {\n  background-color: var(--bs-body-bg, #fff);\n  border: 1px solid var(--bs-border-color, #dee2e6);\n  border-radius: 4px;\n  font-family: var(--bs-font-monospace, monospace);\n  padding: 2px 5px;\n}\n\n.wtr-if-reasoning {\n  font-size: 13px;\n  margin: 0;\n  padding: 6px 8px;\n}\n\n/* Base color classes for text highlighting */\n",""]);const a=s},249:(e,t,n)=>{"use strict";n.d(t,{A:()=>g});var i=n(601),r=n.n(i),o=n(314),s=n.n(o),a=n(974),c=n(784),l=n(421),d=n(131),u=n(198),p=n(92),f=s()(r());f.i(a.A),f.i(c.A),f.i(l.A),f.i(d.A),f.i(u.A),f.i(p.A),f.push([e.id,"/* WTR Term Inconsistency Finder - Modular CSS */\n\n/* Import all component styles */\n\n/* 1. Panel and core layout */\n\n/* 2. Layout and responsive design */\n\n/* 3. Form controls and inputs */\n\n/* 4. Buttons and actions */\n\n/* 5. Results display */\n\n/* 6. Utilities, status, and indicators */\n",""]);const g=f},314:e=>{"use strict";e.exports=function(e){var t=[];return t.toString=function(){return this.map(function(t){var n="",i=void 0!==t[5];return t[4]&&(n+="@supports (".concat(t[4],") {")),t[2]&&(n+="@media ".concat(t[2]," {")),i&&(n+="@layer".concat(t[5].length>0?" ".concat(t[5]):""," {")),n+=e(t),i&&(n+="}"),t[2]&&(n+="}"),t[4]&&(n+="}"),n}).join("")},t.i=function(e,n,i,r,o){"string"==typeof e&&(e=[[null,e,void 0]]);var s={};if(i)for(var a=0;a<this.length;a++){var c=this[a][0];null!=c&&(s[c]=!0)}for(var l=0;l<e.length;l++){var d=[].concat(e[l]);i&&s[d[0]]||(void 0!==o&&(void 0===d[5]||(d[1]="@layer".concat(d[5].length>0?" ".concat(d[5]):""," {").concat(d[1],"}")),d[5]=o),n&&(d[2]?(d[1]="@media ".concat(d[2]," {").concat(d[1],"}"),d[2]=n):d[2]=n),r&&(d[4]?(d[1]="@supports (".concat(d[4],") {").concat(d[1],"}"),d[4]=r):d[4]="".concat(r)),t.push(d))}},t}},330:e=>{"use strict";e.exports=JSON.parse('{"name":"wtr-lab-term-inconsistency-finder","version":"5.3.6","description":"Finds term inconsistencies in WTR Lab chapters using Gemini AI. Supports multiple API keys with smart rotation, dynamic model fetching, and background processing.","author":"MasuRii","license":"MIT","private":true,"main":"dist/main.js","repository":{"type":"git","url":"https://github.com/MasuRii/wtr-term-inconsistency-finder.git"},"bugs":{"url":"https://github.com/MasuRii/wtr-term-inconsistency-finder/issues"},"files":["dist/","src/"],"scripts":{"build":"npm run format && npm run lint:fix && npm run version:update && webpack --mode=production","build:performance":"npm run format && npm run lint:fix && webpack --config webpack.config.js --mode=production","build:greasyfork":"npm run format && npm run lint:fix && webpack --config webpack.config.js --mode=production","build:devbundle":"npm run format && npm run lint:fix && webpack --config webpack.config.js --mode=development","dev":"webpack serve --config webpack.config.js --mode=development","lint":"npm run lint:js && npm run lint:css","lint:check":"npm run lint:js && npm run lint:css","lint:fix":"npm run lint:js:fix && npm run lint:css:fix","lint:js":"eslint src/ --ext .js --max-warnings 0","lint:js:fix":"eslint src/ --ext .js --fix","lint:css":"stylelint \\"src/styles/**/*.css\\" --max-warnings 0","lint:css:fix":"stylelint \\"src/styles/**/*.css\\" --fix","format":"prettier --write \\"src/**/*.{js,css}\\"","version:update":"node scripts/update-versions.js update","version:check":"node scripts/update-versions.js version","version:banner":"node scripts/update-versions.js banner","version:header":"node scripts/update-versions.js header"},"devDependencies":{"css-loader":"^7.1.2","eslint":"^9.39.1","eslint-config-prettier":"^10.1.8","eslint-plugin-import":"^2.32.0","eslint-plugin-prettier":"^5.5.4","prettier":"^3.6.2","style-loader":"^4.0.0","stylelint":"^16.25.0","stylelint-prettier":"^5.0.3","stylelint-config-standard":"^39.0.1","webpack":"^5.102.1","webpack-cli":"^6.0.1","webpack-dev-server":"^5.2.2","webpack-userscript":"^3.2.3"}}')},387:(e,t,n)=>{const i=process.env.WTR_VERSION||process.env.APP_VERSION,r=process.env.WTR_BUILD_ENV||process.env.BUILD_ENV||"production",o=process.env.WTR_BUILD_DATE||process.env.BUILD_DATE||(new Date).toISOString().split("T")[0],s=n(330).version,a={SEMANTIC:i||s,DISPLAY:`v${i||s}`,BUILD_ENV:r||"production",BUILD_DATE:o,GREASYFORK:i||s,NPM:i||s,BADGE:i||s,CHANGELOG:i||s};e.exports={VERSION_INFO:a,getVersion:(e="semantic")=>{switch(e.toLowerCase()){case"semantic":case"semver":default:return a.SEMANTIC;case"display":return a.DISPLAY;case"build":return`${a.SEMANTIC}-${a.BUILD_ENV}`;case"dev":return`${a.SEMANTIC}-dev.${Date.now()}`}},getBuildTime:()=>(new Date).toISOString(),getBuildDate:()=>a.BUILD_DATE,isProduction:()=>"production"===a.BUILD_ENV,isDevelopment:()=>"development"===a.BUILD_ENV}},421:(e,t,n)=>{"use strict";n.d(t,{A:()=>a});var i=n(601),r=n.n(i),o=n(314),s=n.n(o)()(r());s.push([e.id,'/* Enhanced Form Styling for Configuration */\n.wtr-if-form-group {\n  background-color: var(--bs-body-bg, #fff);\n  border: 1px solid var(--bs-border-color, #dee2e6);\n  border-radius: 6px;\n  margin-bottom: 16px;\n  padding: 12px;\n}\n\n.wtr-if-form-group input,\n.wtr-if-form-group select {\n  background-color: var(--bs-secondary-bg, #e9ecef);\n  border: 1px solid var(--bs-border-color, #dee2e6);\n  border-radius: 6px;\n  box-sizing: border-box;\n  color: var(--bs-body-color, #212529);\n  font-size: 14px;\n  padding: 10px 12px;\n  transition:\n    border-color 0.15s ease-in-out,\n    box-shadow 0.15s ease-in-out;\n  width: 100%;\n}\n\n.wtr-if-model-controls select {\n  flex-grow: 1;\n}\n\n.wtr-if-key-row input {\n  flex-grow: 1;\n}\n\n.wtr-if-key-row input:focus,\n.wtr-if-form-group input:focus,\n.wtr-if-form-group select:focus {\n  border-color: var(--bs-primary, #fd7e14);\n  box-shadow: 0 0 0 0.2rem rgb(253 126 20 / 25%);\n  outline: none;\n}\n\n.wtr-if-form-group input[type="range"] {\n  background: transparent;\n  padding: 0;\n}\n\n.wtr-if-form-group label {\n  color: var(--bs-body-color, #212529);\n  display: block;\n  font-size: 14px;\n  font-weight: 600;\n  margin-bottom: 8px;\n}\n\n.wtr-if-form-group label.checkbox-label {\n  align-items: center;\n  display: flex;\n  font-weight: normal;\n  margin-bottom: 0;\n}\n\n.wtr-if-form-group label.checkbox-label input {\n  margin-bottom: 0;\n  margin-right: 10px;\n  width: auto;\n}\n\n.wtr-if-hint {\n  color: var(--bs-secondary-color, #6c757d);\n  display: block;\n  font-size: 12px;\n  font-weight: normal;\n  margin-top: 6px;\n}\n\n.wtr-if-form-row {\n  align-items: center;\n  display: flex;\n  flex-wrap: wrap;\n  gap: 12px;\n  margin-bottom: 8px;\n}\n\n.wtr-if-form-label {\n  color: var(--bs-body-color, #212529);\n  font-weight: 600;\n  min-width: 120px;\n  white-space: nowrap;\n}\n\n.wtr-if-form-select {\n  background-color: var(--bs-secondary-bg, #e9ecef);\n  border: 1px solid var(--bs-border-color, #dee2e6);\n  border-radius: 6px;\n  color: var(--bs-body-color, #212529);\n  flex: 1;\n  max-width: 100%;\n  min-width: 200px;\n  padding: 8px 12px;\n}\n\n.wtr-if-model-controls {\n  align-items: center;\n  display: flex;\n  gap: 12px;\n  margin-top: 8px;\n}\n\n.wtr-if-key-row {\n  align-items: center;\n  display: flex;\n  gap: 8px;\n  margin-bottom: 8px;\n}\n\n.wtr-if-model-controls button {\n  flex-shrink: 0;\n  white-space: nowrap;\n}\n\n.wtr-if-api-keys-container-wrapper {\n  background-color: var(--bs-secondary-bg, #e9ecef);\n  border: 1px solid var(--bs-border-color, #dee2e6);\n  border-radius: 6px;\n  margin-bottom: 8px;\n  max-height: 200px;\n  overflow-y: auto;\n  padding: 12px;\n}\n\n.wtr-if-remove-key-btn {\n  background: var(--bs-danger, #dc3545);\n  border: none;\n  border-radius: 50%;\n  color: white;\n  cursor: pointer;\n  flex-shrink: 0;\n  font-size: 16px;\n  height: 24px;\n  line-height: 1;\n  transition: background-color 0.15s ease-in-out;\n  width: 24px;\n}\n\n.wtr-if-remove-key-btn:hover {\n  background: #c82333;\n}\n\n.wtr-if-deep-analysis-controls,\n.wtr-if-filter-controls {\n  width: 100%;\n}\n',""]);const a=s},424:(e,t,n)=>{let i;try{i=n(387).VERSION_INFO}catch{i={SEMANTIC:"5.3.5",DISPLAY:"v5.3.5",BUILD_ENV:"production",BUILD_DATE:"2025-11-10"}}const r=i.SEMANTIC;e.exports?e.exports={VERSION:r,VERSION_INFO:i}:(window.WTR_VERSION=r,window.WTR_VERSION_INFO=i)},540:e=>{"use strict";e.exports=function(e){var t=document.createElement("style");return e.setAttributes(t,e.attributes),e.insert(t,e.options),t}},601:e=>{"use strict";e.exports=function(e){return e[1]}},659:e=>{"use strict";var t={};e.exports=function(e,n){var i=function(e){if(void 0===t[e]){var n=document.querySelector(e);if(window.HTMLIFrameElement&&n instanceof window.HTMLIFrameElement)try{n=n.contentDocument.head}catch(e){n=null}t[e]=n}return t[e]}(e);if(!i)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");i.appendChild(n)}},784:(e,t,n)=>{"use strict";n.d(t,{A:()=>a});var i=n(601),r=n.n(i),o=n(314),s=n.n(o)()(r());s.push([e.id,"/* Section-based Finder layout improvements */\n.wtr-if-section {\n  background-color: var(--bs-body-bg, #fff);\n  border: 1px solid var(--bs-border-color, #dee2e6);\n  border-radius: 8px;\n  box-shadow: 0 2px 4px rgb(0 0 0 / 5%);\n  margin-bottom: 20px;\n  overflow: hidden;\n}\n\n.wtr-if-section-header {\n  background-color: var(--bs-tertiary-bg, #f8f9fa);\n  border-bottom: 1px solid var(--bs-border-color, #dee2e6);\n  padding: 12px 16px;\n}\n\n.wtr-if-section-header h3 {\n  align-items: center;\n  color: var(--bs-body-color, #212529);\n  display: flex;\n  font-size: 16px;\n  font-weight: 600;\n  gap: 8px;\n  margin: 0;\n}\n\n.wtr-if-icon {\n  align-items: center;\n  display: flex;\n  font-size: 18px;\n  height: 24px;\n  justify-content: center;\n  width: 24px;\n}\n\n.wtr-if-section-content {\n  padding: 16px;\n}\n\n.wtr-if-finder-controls {\n  display: flex;\n  flex-wrap: wrap;\n  gap: 12px;\n}\n\n/* Configuration Tab Responsive Design */\n@media (width <= 768px) {\n  .wtr-if-finder-controls {\n    flex-direction: column;\n  }\n\n  .wtr-if-btn-large {\n    min-width: auto;\n    width: 100%;\n  }\n\n  .wtr-if-form-row {\n    align-items: stretch;\n    flex-direction: column;\n  }\n\n  .wtr-if-form-label {\n    min-width: auto;\n  }\n\n  .wtr-if-form-select {\n    min-width: auto;\n    width: 100%;\n  }\n\n  .wtr-if-action-buttons {\n    flex-direction: column;\n  }\n\n  .wtr-if-action-buttons button {\n    width: 100%;\n  }\n\n  /* Configuration Tab Specific Responsive */\n  .wtr-if-section {\n    margin-bottom: 16px;\n  }\n\n  .wtr-if-section-header h3 {\n    align-items: flex-start;\n    flex-direction: column;\n    font-size: 15px;\n    gap: 6px;\n  }\n\n  .wtr-if-model-controls {\n    flex-direction: column;\n    gap: 8px;\n  }\n\n  .wtr-if-model-controls select,\n  .wtr-if-model-controls button {\n    width: 100%;\n  }\n\n  .wtr-if-import-export .wtr-if-form-row {\n    flex-direction: column;\n    gap: 8px;\n  }\n\n  .wtr-if-import-export button {\n    width: 100%;\n  }\n\n  .wtr-if-section-content {\n    padding: 12px;\n  }\n\n  .wtr-if-api-keys-container-wrapper {\n    max-height: 150px;\n  }\n}\n\n/* Configuration Tab Specific Enhancements */\n.wtr-if-import-export {\n  border-top: 1px solid var(--bs-border-color, #dee2e6);\n  margin-top: 15px;\n  padding-top: 15px;\n}\n\n.wtr-if-import-export h4 {\n  font-size: 14px;\n  font-weight: bold;\n  margin-bottom: 10px;\n  margin-top: 0;\n}\n",""]);const a=s},825:e=>{"use strict";e.exports=function(e){if("undefined"==typeof document)return{update:function(){},remove:function(){}};var t=e.insertStyleElement(e);return{update:function(n){!function(e,t,n){var i="";n.supports&&(i+="@supports (".concat(n.supports,") {")),n.media&&(i+="@media ".concat(n.media," {"));var r=void 0!==n.layer;r&&(i+="@layer".concat(n.layer.length>0?" ".concat(n.layer):""," {")),i+=n.css,r&&(i+="}"),n.media&&(i+="}"),n.supports&&(i+="}");var o=n.sourceMap;o&&"undefined"!=typeof btoa&&(i+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(o))))," */")),t.styleTagTransform(i,e,t.options)}(t,e,n)},remove:function(){!function(e){if(null===e.parentNode)return!1;e.parentNode.removeChild(e)}(t)}}}},974:(e,t,n)=>{"use strict";n.d(t,{A:()=>a});var i=n(601),r=n.n(i),o=n(314),s=n.n(o)()(r());s.push([e.id,"@keyframes wtr-if-spin {\n  0% {\n    transform: rotate(0deg);\n  }\n\n  100% {\n    transform: rotate(360deg);\n  }\n}\n\n#wtr-if-panel {\n  background-color: var(--wtr-bg, #f2f3f4);\n  border: 1px solid var(--bs-border-color, #dee2e6);\n  border-radius: 8px;\n  box-shadow: 0 8px 24px rgb(0 0 0 / 40%);\n  color: var(--bs-body-color, #212529);\n  display: none;\n  flex-direction: column;\n  font-family: var(--bs-body-font-family, sans-serif);\n  left: 50%;\n  max-height: 85vh;\n  max-width: 800px;\n  position: fixed;\n  top: 50%;\n  transform: translate(-50%, -50%);\n  width: 90%;\n  z-index: 1040;\n}\n\n.wtr-if-header {\n  align-items: center;\n  background-color: var(--bs-tertiary-bg, #f8f9fa);\n  border-bottom: 1px solid var(--bs-border-color, #dee2e6);\n  display: flex;\n  justify-content: space-between;\n  padding: 12px 16px;\n}\n\n.wtr-if-header h2 {\n  font-size: 18px;\n  margin: 0;\n}\n\n.wtr-if-close-btn {\n  background: none;\n  border: none;\n  color: var(--bs-body-color, #212529);\n  cursor: pointer;\n  font-size: 24px;\n  line-height: 1;\n  padding: 0 4px;\n}\n\n.wtr-if-tabs {\n  background-color: var(--bs-tertiary-bg, #f8f9fa);\n  border-bottom: 1px solid var(--bs-border-color, #dee2e6);\n  display: flex;\n}\n\n.wtr-if-tab-btn {\n  background: none;\n  border: none;\n  border-bottom: 3px solid transparent;\n  color: var(--bs-secondary-color, #6c757d);\n  cursor: pointer;\n  font-size: 14px;\n  padding: 10px 15px;\n}\n\n.wtr-if-tab-btn.active {\n  border-bottom-color: var(--bs-primary, #fd7e14);\n  color: var(--bs-body-color, #212529);\n  font-weight: bold;\n}\n\n.wtr-if-content {\n  flex-grow: 1;\n  overflow-y: auto;\n  padding: 16px;\n}\n\n.wtr-if-tab-content {\n  display: none;\n}\n\n.wtr-if-tab-content.active {\n  display: block;\n}\n",""]);const a=s}},t={};function n(i){var r=t[i];if(void 0!==r)return r.exports;var o=t[i]={id:i,exports:{}};return e[i](o,o.exports,n),o.exports}n.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return n.d(t,{a:t}),t},n.d=(e,t)=>{for(var i in t)n.o(t,i)&&!n.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.nc=void 0,(()=>{"use strict";var e=n(72),t=n.n(e),i=n(825),r=n.n(i),o=n(659),s=n.n(o),a=n(56),c=n.n(a),l=n(540),d=n.n(l),u=n(113),p=n.n(u),f=n(249),g={};g.styleTagTransform=p(),g.setAttributes=c(),g.insert=s().bind(null,"head"),g.domAPI=r(),g.insertStyleElement=d(),t()(f.A,g),f.A&&f.A.locals&&f.A.locals;var m=n(424);function h(...e){O.config.loggingEnabled&&console.log("Inconsistency Finder:",...e)}function y(){const e=document.querySelectorAll(".chapter-tracker");h(`Found ${e.length} potential chapter elements.`);const t=[];return e.forEach((e,n)=>{const i=e.querySelector(".chapter-body"),r=e.dataset.chapterNo;i&&r?(h(`Processing chapter #${r}...`),t.push({chapter:r,text:i.innerText,tracker:e})):h(`Skipping element at index ${n}: missing chapter number or body. Chapter No: ${r||"not found"}`)}),h(`Successfully collected data for ${t.length} chapters: [${t.map(e=>e.chapter).join(", ")}]`),t}function b(e){if(!Array.isArray(e)||0===e.length)return e||[];if(void 0!==O?.config?.smartQuotesEnabled&&!Boolean(O.config.smartQuotesEnabled))return h("SMART QUOTES: Skipping conversion because smartQuotesEnabled is false."),e;h(`Applying smart quotes replacement to ${e.length} chapters...`);let t=0,n=0;const i=e.map(e=>{if(e.tracker&&e.tracker.classList.contains("chapter-tracker active"))return h(`Skipping smart quotes on ACTIVE chapter #${e.chapter} to avoid conflicts`),n++,e;const i=e.text||"",r=(i.match(/["']/g)||[]).length,o=(i.match(/[“”‘’]/g)||[]).length;if(0===r)return h(`SMART QUOTES: No straight quotes to convert for chapter #${e.chapter}. Skipping.`),e;let s=i,a=!1;try{s=function(e){if(!e||"string"!=typeof e)return"";if(void 0!==O?.config?.smartQuotesEnabled&&!Boolean(O.config.smartQuotesEnabled))return e;try{const t=e,n=(t.match(/'/g)||[]).length,i=(t.match(/"/g)||[]).length,r=(t.match(/[“”‘’]/g)||[]).length;if(0===n&&0===i)return t;let o=t.replace(/--/g,"—");o=o.replace(/'(\d{2}s)/g,"’$1"),o=o.replace(/(\p{L})'(\p{L}{1,3}\b)/gu,"$1’$2"),o=o.replace(/(\p{L})'s\b/gu,"$1’s"),o=o.replace(/(^|[\s({>“”[])"(?=\S)/g,"$1“"),o=o.replace(/"/g,"”"),o=o.replace(/(^|[\s({>“”[] )'(?=\S)/g,"$1‘"),o=o.replace(/'/g,"’");const s=(o.match(/'/g)||[]).length,a=(o.match(/"/g)||[]).length,c=(o.match(/[“”‘’]/g)||[]).length,l=n+i,d=s+a,u=l-d,p=r+2*l;return c>p||n-s<0||i-a<0?(h("SMART QUOTES SAFEGUARD: Detected anomalous conversion. Reverting to original text.",{originalStraightSingles:n,originalStraightDoubles:i,originalSmart:r,newStraightSingles:s,newStraightDoubles:a,newSmart:c,totalStraightOriginal:l,totalStraightRemaining:d,maxAllowedNewSmart:p}),t):(h("SMART QUOTES STATS (smartenQuotes):",{originalStraightSingles:n,originalStraightDoubles:i,originalSmart:r,newStraightSingles:s,newStraightDoubles:a,newSmart:c,totalStraightOriginal:l,totalStraightRemaining:d,totalStraightConsumed:u}),o)}catch(t){return h("SMART QUOTES ERROR: Failed to apply smart quotes. Returning original text.",t),e}}(i)}catch(t){h(`SMART QUOTES ERROR: Conversion failed for chapter #${e.chapter}. Using original text.`,t),s=i,a=!0}const c=(s.match(/["']/g)||[]).length,l=(s.match(/[“”‘’]/g)||[]).length,d=l-o,u=o+2*r;if(!a&&(l>u||d<0))h(`SMART QUOTES SAFEGUARD (chapter #${e.chapter}): Anomalous stats detected. Reverting to original text.`,{originalStraightQuotes:r,originalSmartQuotes:o,newStraightQuotes:c,newSmartQuotes:l,quotesConverted:d,maxAllowedNewSmart:u}),s=i;else if(a||s===i)h(`SMART QUOTES: No safe changes for chapter #${e.chapter} (${r} straight, ${o} smart).`);else{t++;const n=Math.min(160,i.length),a=i.substring(0,n).replace(/\n/g,"\\n"),u=s.substring(0,n).replace(/\n/g,"\\n");h(`SMART QUOTES CONVERSION Chapter #${e.chapter}:`),h(`  Original: ${r} straight, ${o} smart`),h(`  After:    ${c} straight, ${l} smart`),h(`  Converted: ${d} quotes to smart format`),h(`  Sample before: "${a}${i.length>n?"...":""}"`),h(`  Sample after:  "${u}${s.length>n?"...":""}"`)}return{...e,text:s}});return h(`SMART QUOTES SUMMARY: Processed ${e.length} chapters, skipped ${n} active chapters, applied safe conversions to ${t} chapters.`),i}function w(e,t=[]){if(!t||0===t.length)return h("No terms provided. Skipping replacement step."),e;h(`Applying ${t.length} replacement terms using advanced logic.`);const n=new Map,i=new Map,r=new Map,o=new Map,s=[];for(const e of t)if(e.original)if(e.wholeWord=e.wholeWord??!1,e.isRegex)try{const t=e.caseSensitive?"g":"gi";s.push({pattern:new RegExp(e.original,t),replacement:e.replacement})}catch(t){console.error(`Inconsistency Finder: Skipping invalid regex for term "${e.original}":`,t)}else{const t=e.caseSensitive?e.original:e.original.toLowerCase(),s=e.replacement;e.caseSensitive?e.wholeWord?i.set(t,s):n.set(t,s):e.wholeWord?o.set(t,s):r.set(t,s)}const a=[...s],c=(e,t,n,i)=>{if(e.size>0){const r=[...e.keys()].sort((e,t)=>t.length-e.length).map(e=>{const t=T(e);return n?`\\b${t}\\b`:t}).join("|");a.push({pattern:new RegExp(r,t),replacement_map:e,is_simple:!0,case_sensitive:i})}};return c(n,"g",!1,!0),c(i,"g",!0,!0),c(r,"gi",!1,!1),c(o,"gi",!0,!1),e.map(e=>{if(e.tracker&&e.tracker.classList.contains("chapter-tracker active"))return h(`Skipping term replacements on active chapter #${e.chapter} to avoid conflicts`),e;let t=e.text;const n=[];for(const e of a)for(const i of t.matchAll(e.pattern)){if(0===i[0].length)continue;let t;if(e.is_simple){const n=e.case_sensitive?i[0]:i[0].toLowerCase();t=e.replacement_map.get(n)}else t=e.replacement;void 0!==t&&n.push({start:i.index,end:i.index+i[0].length,replacement:t})}n.sort((e,t)=>e.start!==t.start?e.start-t.start:t.end-e.end);const i=[];let r=-1;for(const e of n)e.start>=r&&(i.push(e),r=e.end);for(let e=i.length-1;e>=0;e--){const n=i[e];t=t.substring(0,n.start)+n.replacement+t.substring(n.end)}return{...e,text:t}})}function v(e){let t=0;t+={CRITICAL:100,HIGH:80,MEDIUM:60,LOW:40,STYLISTIC:20,INFO:10}[e.priority]||10,t+=5*(e.variations?.length||0),t+=3*(e.suggestions?.length||0),"Verified"===e.status&&(t+=20),e.isNew&&(t-=10);const n=(e.concept||"").toString();return/^\s*$/.test(n)&&(t-=30),t}function x(e){if(!e||"string"!=typeof e)return"unknown";let t=!1,n=!1,i=!1,r=!1;for(const o of e){const e=o.codePointAt(0);e>=65&&e<=90||e>=97&&e<=122||e>=192&&e<=591?t=!0:e>=12352&&e<=12543||e>=13312&&e<=40959||e>=63744&&e<=64255?n=!0:e>=1024&&e<=1279?i=!0:e>=48&&e<=57||/\s/.test(o)||/[.,!?'"`:;()[\]{}\-_/\\]/.test(o)||(r=!0)}return!n||t||i||r?!i||t||n||r?!t||n||i||r?"mixed":"latin":"cyrillic":"cjk"}function S(e){if(!e||"string"!=typeof e)return!1;const t=e.trim().split(/\s+/);if(1===t.length){const e=t[0];if(/^[A-Z][a-zA-Z]+$/.test(e))return!0}return!!(t.length>1&&t.every(e=>/^[A-Z][a-z]+$/.test(e)))}function A(e,t){const n=[...e];return t.forEach(e=>{if(!e||"object"!=typeof e)return;const t=e.concept||"",i=x(t),r=n.findIndex(e=>!(!e||!e.concept)&&function(e,t){if(!e||!t)return!1;const n=e.toString(),i=t.toString(),r=x(n),o=x(i);if("unknown"!==r&&"unknown"!==o&&r!==o)return h(`Semantic similarity blocked by script mismatch: "${n}" [${r}] vs "${i}" [${o}]`),!1;const s=e=>e.toLowerCase().replace(/[^a-z0-9\s]/g,"").trim(),a=s(n),c=s(i);if(!a&&!c){const e=n.trim()===i.trim();return e||h(`Semantic similarity rejected for non-Latin pair (no normalized content): "${n}" vs "${i}"`),e}if(a===c&&a.length>0)return!0;if(a.length<=3||c.length<=3)return a.length>0&&a===c;const l=S(n),d=S(i);if(l!==d)return h(`Semantic similarity rejected due to proper-name mismatch: "${n}" (proper=${l}) vs "${i}" (proper=${d})`),!1;if(a.length>=4&&c.length>=4&&(a.includes(c)||c.includes(a)))return!0;const u=a.split(/\s+/).filter(Boolean),p=c.split(/\s+/).filter(Boolean);if(u.length&&p.length){const e=u.filter(e=>p.includes(e));if(e.length/Math.max(u.length,p.length)>=.8&&e.length>0)return!0}return h(`Semantic similarity not strong enough: "${n}" [${r}] vs "${i}" [${o}] (norm1="${a}", norm2="${c}")`),!1}(e.concept,t));if(-1===r)return void n.push(e);const o=n[r],s=o.concept||"",a=x(s),c=v(o),l=v(e);if("unknown"!==a&&"unknown"!==i&&a!==i)return h(`Merge prevented: script mismatch between "${s}" [${a}] and "${t}" [${i}].`),void n.push(e);if("mixed"===a&&"mixed"!==i||"mixed"===i&&"mixed"!==a)return h(`Merge prevented: mixed/ambiguous script conflict between "${s}" [${a}] and "${t}" [${i}].`),void n.push(e);if(h(`Semantic duplicate candidate: "${s}" vs "${t}". Quality scores: ${c} vs ${l}`),c<40&&l<40)return h(`Merge prevented: both candidates have low quality (${c}, ${l}). Keeping as separate concepts.`),void n.push(e);if(l>c)n[r]={...e,concept:e.concept},h("Merged duplicate results by favoring higher quality new result for this concept.");else{const t={...o,concept:o.concept,priority:o.priority,explanation:o.explanation,variations:[...o.variations||[],...e.variations||[]].filter((e,t,n)=>n.findIndex(t=>t.phrase===e.phrase&&t.chapter===e.chapter)===t),suggestions:[...o.suggestions||[],...e.suggestions||[]].filter((e,t,n)=>n.findIndex(t=>t.suggestion===e.suggestion)===t),status:o.status||e.status,isNew:Boolean(o.isNew&&e.isNew)};n[r]=t,h("Merged duplicate results, preserving higher or equal quality concept and safely aggregating variations/suggestions.")}}),n}function I(e){const t=e.match(/```(?:json)?\s*([\s\S]*?)\s*```/);if(t&&t[1])return h("Extracted JSON from markdown block."),t[1];const n=e.indexOf("{"),i=e.indexOf("[");let r=-1;if(r=-1===n?i:-1===i?n:Math.min(n,i),-1!==r){const t=e.lastIndexOf("}"),n=e.lastIndexOf("]"),i=Math.max(t,n);if(i>r)return h("Extracted JSON using fallback brace/bracket matching."),e.substring(r,i+1)}return h("No JSON structure found, returning raw text."),e}function T(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function E(e){return"string"!=typeof e?"":e.replace(/&/g,"&").replace(/</g,"<").replace(/>/g,">").replace(/"/g,'"').replace(/'/g,"&#039;")}let k={lastResult:!1,lastCheck:0};function C(){try{const e=Date.now(),t=3e3;if(e-k.lastCheck<t)return k.lastResult;const n=document.querySelector(".replacer-settings-btn.term-edit-btn.menu-button.small.btn.btn-outline-dark.btn-sm"),i=Boolean(n);return k={lastResult:i,lastCheck:e},i&&h("WTR Lab Term Replacer detection: positive via settings button marker."),i}catch(e){return h("WTR Lab Term Replacer detection error; defaulting to safe mode (not loaded).",e),k={lastResult:!1,lastCheck:Date.now()},!1}}const R="wtr_inconsistency_finder_",$=`${R}config`,N=`${R}models_cache`,L=`${R}session_results`,O={config:{apiKeys:[],model:"",useJson:!1,loggingEnabled:!1,temperature:.5,activeTab:"finder",activeFilter:"all",deepAnalysisDepth:1},runtime:{isAnalysisRunning:!1,cumulativeResults:[],currentApiKeyIndex:0,apiKeyCooldowns:new Map,currentIteration:1,totalIterations:1},session:{hasSavedResults:!1,lastAnalysisTime:null},preferences:{autoRestoreResults:!0}};function M(e){const t={...e};if((!t.suggestion||"string"!=typeof t.suggestion||""===t.suggestion.trim())&&t.display_text&&"string"==typeof t.display_text){const e=t.display_text.replace(/^(standardize to|use|change to|replace with|update to)\s*/i,"").replace(/^['"`]|['"`]$/g,"").trim();(e&&e!==t.display_text||e)&&(t.suggestion=e)}return t.suggestion&&"string"==typeof t.suggestion&&""!==t.suggestion.trim()||(t.suggestion=t.display_text||"[Informational]"),t.display_text=t.display_text||`Use "${t.suggestion}"`,t.reasoning=t.reasoning||"AI-generated suggestion",t}async function D(){try{const e={...O.config,preferences:O.preferences};return await GM_setValue($,e),!0}catch(e){return console.error("Inconsistency Finder: Error saving config:",e),!1}}function P(){try{const e={results:O.runtime.cumulativeResults,timestamp:Date.now(),config:{model:O.config.model,temperature:O.config.temperature}};sessionStorage.setItem(L,JSON.stringify(e)),O.session.hasSavedResults=!0,O.session.lastAnalysisTime=e.timestamp,h("Session results saved")}catch(e){console.error("Inconsistency Finder: Error saving session results:",e)}}function B(){try{sessionStorage.removeItem(L),O.session.hasSavedResults=!1,O.session.lastAnalysisTime=null,h("Session results cleared")}catch(e){console.error("Inconsistency Finder: Error clearing session results:",e)}}const F=3e5,q=new Set(["RESOURCE_EXHAUSTED","INTERNAL","UNAVAILABLE","DEADLINE_EXCEEDED"]);function z({operationName:e,retryCount:t,maxTotalRetries:n,startedAt:i,nextStep:r}){const o=Date.now();if(t>=n)return void U(`${e} failed after ${t} attempts across all keys. Please check your API keys or wait a while.`);if(o-i>F)return void U(`${e} failed after repeated retries over an extended period. Please wait a while before trying again.`);const s=function(e){const t=2e3*Math.pow(2,e);return Math.min(t,6e4)}(t);h(`${e}: Scheduling retry #${t+1} with exponential backoff delay ${s}ms.`),ue("running",`${e} retrying in ${Math.round(s/1e3)}s due to temporary API issues...`),setTimeout(()=>{try{r()}catch(t){console.error(`Inconsistency Finder: Uncaught error during scheduled retry for ${e}:`,t),U(`${e} encountered an unexpected error during retry. Please try again.`)}},s)}function _(e,t=[]){let n='You are a specialized AI assistant, a "Translation Consistency Editor," designed to detect and fix translation inconsistencies in machine-translated novels. Your primary goal is to identify terms (character names, locations, items, abilities, titles, etc.) that have been translated inconsistently across chapters, provide standardization suggestions, and offer contextual analysis for nuances like aliases, stylistic localizations, and cultural honorifics.\n\n## Core Capabilities\n1.  Scanning & Detection: Automatically scan for inconsistent translations of the same entity. Track variations of character names, place names, items, abilities, titles, and other recurring terms. Detect semantic similarities between terms that may be different translations of the same concept.\n2.  Entity Profiling & Alias Linking: Build profiles for key narrative entities (characters, locations, etc.) to link aliases, nicknames, and full names using contextual clues. Recognize component-based naming schemes (e.g., \'Heavy Cavalry\' as a shorthand for \'Heavy Cavalry Exoskeleton\') and entity-derived names (e.g., a location incorporating a character\'s name like \'[Character] City\').\n3.  Username Lexical & Formatting Analysis: Proactively identify potential usernames based on non-English lexical patterns (pinyin, romaji, etc.) and formatting violations (the presence of spaces). If a username triggers both, present both sets of suggestions together in a single, consolidated report item.\n4.  Suggestion Generation: For each identified inconsistency, provide 3 distinct standardization suggestions. Include data-driven metrics for each suggestion (e.g., frequency, first appearance) and explain the reasoning with quantitative support, maintaining the story\'s context.\n\n## What NOT to Flag (Exclusions)\n- Do not flag or report terms that have been previously confirmed as an alias cluster.\n- Do not flag onomatopoeia (sound words, emotional expressions, or expressive vocalizations like "Wuwuwu", "Aha!", "Huhu", etc.) as these are cute stylistic elements that should remain in their original flavor.\n- Do not flag casual internet expressions or emotional vocalizations that are culturally appropriate and intentionally expressive.\n- Do NOT flag anything related to author notes, author commentary, or translator notes - these are intentional additions that may make the text longer but should not be flagged for inconsistencies.\n- Do NOT flag usernames or character references that are clearly aliases, undercovers, or alternate identifications of the same character.\n- CRITICAL: Do NOT flag quote-style inconsistencies (e.g., "Project Doomsday" vs "Project Doomsday" vs "Project Doomsday"). These are caused by different chapters having been processed by different quote conversion scripts (smart quotes vs straight quotes). Terms that differ only in their quote style (straight quotes ", single quotes \', or smart quotes “ ” ‘ ’) should be considered the same term and not flagged as inconsistencies. Only flag inconsistencies when the actual text content differs, not when only the quotation marks differ.\n- CRITICAL: Do NOT flag systematic chapter title numbering offsets or mismatches that are clearly caused by the source website\'s structure or template rather than the editable chapter content. In particular:\n    * If multiple consecutive chapters show a consistent pattern where the visible chapter heading (e.g., "--- CHAPTER 302 ---") and the in-title number (e.g., "Chapter 301: Arcane Armor") are offset by the same amount (such as always lagging by one), treat this as a non-user-actionable, site-level issue.\n    * When this behavior is consistent across chapters, you MUST treat it as informational only and MUST NOT emit it as a user-facing inconsistency item, even at LOW or INFO priority.\n    * Only flag chapter numbering/title issues when the evidence indicates an isolated or user-editable mistake inside the chapter content itself (for example, a single chapter title or reference that does not follow an established, systematic site-level pattern and can reasonably be corrected by the user).\n    * Do NOT suppress other chapter-related findings such as inconsistent wording, misspellings, or title text variations that remain user-fixable. Only the systematic, structural numbering-offset pattern should be excluded.\n\n## Focus On\n- In-text content within the chapter body.\n- Character names, locations, items, abilities, techniques, titles, and organizations.\n- Chapter titles and any inconsistencies within them.\n- Potential alias clusters for entities.\n- Usernames for holistic formatting and localization opportunities.\n- Non-English honorifics for cultural nuance handling.\n\n## Prioritization System (Dynamic Impact-Based)\nYou will use a dynamic Impact Score to rank all detected issues, ensuring that items most critical to the story are prioritized.\n\n### How the Impact Score is Calculated:\n1.  Frequency & Density (Base Score): The raw count of a term\'s appearances relative to the total length of the scanned text.\n2.  Narrative Centrality (Context Multiplier): A multiplier based on how tied a term is to the core plot. Boost scores for terms appearing near the protagonist, in chapter titles, or frequently in dialogue.\n3.  Chronological Volatility (Recency & Pattern Score): Prioritize inconsistencies in recent chapters. Lower the score for terms that were inconsistent early on but have since become consistent. Flag "Potential Term Evolutions" (e.g., a title changing after a promotion) for review with a lower error score.\n4.  Dependency & "Root" Status (Architectural Multiplier): Identify "root" inconsistencies (like a sect\'s name) that cause a cascade of "dependent" inconsistencies (like titles "Sect Elder," "Sect Disciple"). The root term receives a massive priority multiplier.\n\n### Priority Levels (Based on Calculated Impact Score):\n- [Priority: CRITICAL]: High-frequency, high-centrality terms with ongoing volatility. Main character names, core concepts in chapter titles, or major "root" inconsistencies.\n- [Priority: HIGH]: Important secondary characters, key locations, or recurring abilities that are inconsistent in recent chapters.\n- [Priority: MEDIUM]: Supporting elements, items, or inconsistencies that are less frequent or occurred in earlier chapters.\n- [Priority: LOW]: Minor background elements, one-off mentions with variations, or confirmed "Term Evolutions" that just need a final check.\n- [Priority: STYLISTIC]: All localization and formatting suggestions (usernames, honorifics) are grouped here.\n- [Priority: INFO]: Informational notes, such as \'Potential Alias Clusters\' or \'Potential Nuance Clusters\'.\n\n## Improved Detection Logic\nThink step by step in your analysis: 1. Scan the text for recurring terms. 2. Build entity profiles and link aliases using contextual clues. 3. Calculate impact scores based on frequency, centrality, volatility, and dependencies. 4. Verify each detection for high-confidence errors (reflect: Is this an unintentional inconsistency or a nuance/evolution? Discard if not a true error). 5. Generate data-driven suggestions.\n1.  QUOTE NORMALIZATION (CRITICAL): Before comparing any terms for inconsistencies, first normalize all quotation marks by stripping them. Terms like "Project Doomsday", \'Project Doomsday\', and “Project Doomsday” should be treated as the SAME term "Project Doomsday" for comparison purposes. Only flag an inconsistency if the CORE TEXT (excluding quotes) differs.\n2.  Contextual Verification Snippets: For each potential inconsistency, extract and present a brief contextual snippet (1-2 sentences) for each variant to verify the match.\n3.  Disambiguation Logic for Similar Terms: If two similar-sounding terms like "Flame Art" and "Blaze Art" appear in the same chapter or are used by different characters in the same context, treat them as distinct entities.\n4.  Source Term Inference: Infer a probable source term or pinyin as the "Original Concept" anchor for grouping variations (e.g., group "Li Fuchen," "Li Fu Chen," and "Lee Fuchen" under an inferred anchor like `[Li Fuchen]`).\n5.  Conceptual Anchoring: If terms with low string similarity share conceptual anchors (e.g., consistently associated with the same character or location), create a high-confidence link.\n6.  Component-Based Matching: Break down long names into core components (e.g., [Azure Dragon] + [Flame/Burning] + [Sword/Blade]) and match based on the core entity and synonymous descriptors.\n7.  Relational Inconsistency Detection: Identify "Relational Clusters" where inconsistencies are linked (e.g., a character\'s name changing along with their title in the same chapter).\n8.  Track and Flag Chronological Inconsistencies (Term Evolution): If a term disappears and is consistently replaced by a new one from a specific chapter onward, flag it as a "Potential Term Evolution" rather than a simple error.\n9.  Speaker-Based Disambiguation: Associate terms with the characters who use them to avoid false positives.\n10.  Proactively Identify "Root" Inconsistencies: Identify "root" terms that cause multiple dependent inconsistencies and prioritize them.\n11. Advanced Entity Recognition (Aliases & Nicknames): Build a profile for each key entity. Use contextual clues (explicit links like "...friends called him Jon" or implicit links like shared attributes) to link different names to the same entity. CRITICAL: When you encounter terms like \'BattlefieldAtmosphereGroup\' and \'BattlefieldOldBro\' used for the same character, analyze the context carefully - these are clearly shorthand variants of the same entity. Look for phrases like "also known as", "also called", "alias", "shorthand", "nickname", or contextual patterns where one term consistently refers to the same character as another term. Do NOT flag these as inconsistencies - they are intentional variations used in the story.\n12. Username Analysis Protocol:\n    *   Formatting Trigger: Flag any potential username containing one or more literal space characters (e.g., \'Elderly Abin\').\n    *   Lexical Trigger: Flag any potential username matching pinyin, Japanese Romaji, Korean Romanization, or other non-English romanized language patterns. Do not flag fluent, multi-word English usernames.\n    *   Formatting Exemption: You MUST NOT flag potential usernames that are presented as a single, concatenated word (e.g., \'PlayerName\', \'AnotherUser\'), even if they use internal capitalization (PascalCase). This is a standard and acceptable format.\n    *   Holistic Analysis: If a username is flagged by BOTH triggers, you MUST provide BOTH formatting and localization suggestions.\n    *   Contextual Differentiation: You MUST NOT flag a name for username-style inconsistencies if the context explicitly identifies the character as an NPC (e.g., \'secretary,\' \'guard,\' \'shopkeeper\'). Username analysis should only apply when context strongly suggests a player character (e.g., mentions of \'player,\' \'ID,\' \'leaderboard\').\n13. Non-English Honorifics Handling: Pattern-match for common honorifics, explain their nuance, and present options that align with common genre practices.\n14. Low-Frequency Alias Boosting: Apply a confidence boost to low-frequency terms if they exhibit strong conceptual ties to high-frequency core entities.\n15. Nuance Analysis: When detecting semantically similar terms, analyze usage patterns. If patterns suggest an intentional conceptual distinction (e.g., state vs. government), flag as \'Potential Nuance Cluster\' instead of an inconsistency.\n16. Enhanced Alias Recognition Pattern: Look for these specific patterns that indicate intentional aliases, not inconsistencies:\n    - Contextual indicators: "also known as", "alias", "shorthand", "nickname", "undercover", "went by"\n    - Game/online context: References to usernames, player IDs, gaming handles, or online personas\n    - Sequential usage: Same character being referred to with different names in different chapters\n    - Character development: Names changing as part of character progression or identity evolution\n    - Example pattern: A character with full username \'BattlefieldAtmosphereGroup\' using shorter variants like \'BattlefieldOldBro\' or \'BattlefieldAtmoGroup\' - these are deliberate shorthand, not errors\n    - When you see this pattern, mark as \'INFO\' priority with explanation about intentional alias usage\n17. Pinyin vs. English Mismatch: Identify and flag pinyin terms used inconsistently within a group of otherwise standardized English terms. For example, if a character\'s skills are \'Fireball\', \'Ice Lance\', and \'Shenlong Po\', flag \'Shenlong Po\' as a potential localization inconsistency and suggest an English equivalent.\n\n16. Localization Suggestions Logic:\n    - Localization suggestions should ONLY appear for terms that are in pinyin, Chinese characters, or other non-English formats\n    - If a term is already in English or appears to be an established English term in context, DO NOT suggest localization\n    - For pinyin terms, provide localization suggestions only if there is no reasonable English equivalent already established in the context\n    - If a pinyin term appears multiple times and all instances suggest the same English meaning, treat it as a proper noun (character name, place name, etc.) and only suggest localization once with full explanation\n    - Avoid duplicate localization suggestions that are still in pinyin format\n    - Only use "localization suggestion" terminology when the context strongly indicates the term needs translation from Chinese/pinyin to English\n\n## Core Directives\n1.  Prioritization is Key: Always process items with the highest Impact Score first.\n2.  Be a Data-Driven Partner: All suggestions must be supported by data (frequency, context, etc.).\n3.  Enhance the Reading Experience: Focus on changes that have the biggest positive impact on story comprehension.\n4.  Ensure Complete Report Population: For all detected items, always populate the \'variations\' section with the identified variants, including their appearance counts, chapters, and context snippets.\n5.  Recommend the Best Suggestion: For each inconsistency, you MUST identify the single best suggestion and add the field "is_recommended": true to it. Only one suggestion per group should have this flag.\n6.  Use Plain Text: Do not use any markdown formatting like bold or italics within the JSON fields, especially in \'explanation\', \'reasoning\', and \'suggestion\' fields. Use plain text only to ensure compatibility and reduce token usage.\n7.  Treat Each Finding as a Unique Concept: Each unique term or entity identified as an issue (e.g., an inconsistent name, a username with spaces, a pinyin term needing localization) MUST be treated as its own separate \'concept\'. Do NOT group multiple distinct entities under a single generic concept. For example, if you find two usernames \'Player One\' and \'Player Two\', they must be reported as two separate items in the JSON array, each with its own \'concept\' field set to the respective username. Similarly, if \'FangChang\' and \'TengTeng\' both need localization, they are two separate concepts.\n\n## Examples (Few-Shot Demonstration)\nExample 1: Text: --- CHAPTER 1 --- The hero Li Fuchen fought in Li City. --- CHAPTER 2 --- Lee Fu Chen escaped to Lee City.\nStep-by-Step Analysis: 1. Scan: Terms \'Li Fuchen\', \'Lee Fu Chen\' (names); \'Li City\', \'Lee City\' (locations). 2. Profile: Link as same entity via context (hero\'s journey). 3. Impact: High frequency, central to plot -> CRITICAL. 4. Verify: Unintentional inconsistency, not evolution. 5. Suggestions: Standardize name to \'Li Fuchen\' (frequency: 2, first appearance Ch1).\n\nQuote Normalization Example: Text: --- CHAPTER 1 --- The hero said "Project Doomsday" was dangerous. --- CHAPTER 2 --- The villain whispered \'Project Doomsday\' again. --- CHAPTER 3 --- The report mentioned "Project Doomsday" frequently.\nStep-by-Step Analysis: 1. Scan: Terms \'Project Doomsday\', \'Project Doomsday\', \'Project Doomsday\' (same term with different quote styles). 2. Normalize: Strip all quotation marks to compare core terms. 3. Verify: All variations are the same term "Project Doomsday" with different quote formatting. 4. Decision: This is NOT an inconsistency - it\'s a false positive caused by different chapters being processed by different quote conversion scripts. 5. Action: Do NOT flag this as an inconsistency.\n\nOutput JSON:\n```json\n[\n  {\n    "concept": "Li Fuchen",\n    "priority": "CRITICAL",\n    "explanation": "Inconsistent name translations for the main character.",\n    "suggestions": [\n      {\n        "display_text": "Standardize to \'Li Fuchen\'",\n        "suggestion": "Li Fuchen",\n        "reasoning": "This is the first and most frequently used variant.",\n        "is_recommended": true\n      }\n    ],\n    "variations": [\n      {\n        "phrase": "Li Fuchen",\n        "chapter": "1",\n        "context_snippet": "The hero Li Fuchen fought..."\n      },\n      {\n        "phrase": "Lee Fu Chen",\n        "chapter": "2",\n        "context_snippet": "Lee Fu Chen escaped..."\n      }\n    ]\n  }\n]\n```\n\nBase all detections exclusively on the provided text; use plain text only in JSON fields.';n+=`\n\nHere is the text to analyze:\n---\n${e}\n---`;const i='\n         [\n           {\n             "concept": "The core concept or inferred original term.",\n             "priority": "CRITICAL | HIGH | MEDIUM | LOW | STYLISTIC | INFO",\n             "explanation": "A brief explanation of the inconsistency or issue.",\n             "suggestions": [\n               {\n                 "display_text": "A user-friendly description of the suggestion (e.g., \'Standardize to \\\'Term A\\\' everywhere.\')",\n                 "suggestion": "The exact, clean text to be used for replacement (e.g., \'Term A\'). This field MUST NOT contain conversational text like \'Standardize to...\'. Use an empty string (\\"\\") for informational suggestions.",\n                 "reasoning": "The detailed reasoning behind this suggestion.",\n                 "is_recommended": "Optional. A boolean (true) indicating if this is the AI\'s top recommendation. Only one suggestion per concept should have this flag."\n               }\n             ],\n             "variations": [\n               {\n                 "phrase": "The specific incorrect/variant phrase found.",\n                 "chapter": "The chapter number as a string.",\n                 "context_snippet": "A snippet of text showing the context."\n               }\n             ]\n           }\n         ]';if(t.length>0){const e=t.filter(e=>{const t=function(e){if(!e||"object"!=typeof e)return!1;if(!e.concept||"string"!=typeof e.concept||""===e.concept.trim())return!1;if(!e.explanation||"string"!=typeof e.explanation||""===e.explanation.trim())return!1;if(!e.variations||!Array.isArray(e.variations)||0===e.variations.length)return!1;for(const t of e.variations){if(!t.phrase||"string"!=typeof t.phrase||""===t.phrase.trim())return!1;if(!t.chapter||"string"!=typeof t.chapter||""===t.chapter.trim())return!1;if(!t.context_snippet||"string"!=typeof t.context_snippet)return!1}return!0}(e);return t||h(`Filtered out invalid result from context: ${e.concept||"Unknown concept"}`),t});0===e.length?h("All existing results failed validation, proceeding without context"):h(`Context validation: ${t.length} results filtered to ${e.length} valid results`);const r=function(e,t=50){if(e.length<=t)return e;const n=e.map(e=>({...e,qualityScore:v(e)})).sort((e,t)=>t.qualityScore-e.qualityScore).slice(0,t),i=e.length-t,r={concept:`[${i} Additional Items Summarized]`,priority:"INFO",explanation:`Additional ${i} items from previous analysis are summarized. Focus verification on the detailed items below.`,suggestions:[],variations:[]};return h(`Context summarization: ${e.length} items reduced to ${t} detailed + 1 summarized`),[...n,r]}(e,30);n+=`\n\n## Senior Editor Verification & Continuation Task\nYou are now operating as a Senior Editor. Your task is to perform a rigorous second-pass verification on a list of potential inconsistencies identified in a previous analysis. The provided text may have been updated or corrected since the initial scan. Your judgment must be strict, and your output must be based *exclusively* on the new text provided.\n\nApply Chain of Verification: 1. For each concept, plan 2-3 critical questions to check accuracy. 2. Verify answers against the text. 3. Resolve any inconsistencies or discard if invalid (e.g., aliases, evolutions). 4. Reflect: Critique your verifications for high confidence; revise if needed.\n\nYour Mandatory Tasks:\n\n1.  Re-Scan and Re-Build Verified Inconsistencies:\n       *   For each concept in the "Previously Identified" list, you must re-scan the entire new text.\n       *   If a concept still represents a genuine, high-confidence, unintentional error that harms readability, you MUST build a completely new, fresh JSON object for it.\n       *   CRUCIAL: Do NOT copy any data from the provided list. All fields—especially \`variations\`, \`context_snippet\`, and \`priority\`—must be re-calculated and re-extracted from the current text. If a variation no longer appears, it must not be included. If new variations are found, they must be added.\n       *   Place these freshly built objects into the \`verified_inconsistencies\` array.\n\n2.  Strictly Discard Invalid Concepts:\n       *   You MUST OMIT any concept from the output if it is no longer a true error. Discard items if your deeper analysis reveals they are:\n           *   Intentional Aliases/Nicknames: (e.g., "Bob" vs. "Robert" used interchangeably).\n           *   Contextual Nuance: Similar terms with distinct meanings (e.g., "Flame Art" used by Character A vs. "Blaze Art" used by Character B).\n           *   Resolved/Corrected: The inconsistency no longer exists in the provided text.\n           *   Confirmed Term Evolution: A term is consistently replaced by another from a specific chapter onward (e.g., "Squire" becomes "Knight" after a promotion).\n           *   Initial False Positive: The original flag was an error upon closer inspection.\n       *   Discarded items should NOT appear in either output array.\n\n3.  Discover New Inconsistencies:\n       *   After completing the verification process, perform a full, fresh analysis of the text to find any NEW inconsistencies that were not on the original list.\n       *   Create a standard JSON object for each new finding.\n       *   Place these new objects into the \`new_inconsistencies\` array.\n\n## Few-Shot Example\nPreviously Identified: [{"concept": "Li Fuchen", "variations": [{"phrase": "Lee Fu Chen"}]}]\nNew Text: --- CHAPTER 1 --- The hero Li Fuchen fought. --- CHAPTER 2 --- Li Fuchen escaped.\nStep-by-Step Verification: 1. Plan questions: "Does 'Li Fuchen' appear consistently? Is 'Lee Fu Chen' still present?" 2. Verify: Scan text – 'Lee Fu Chen' is gone, inconsistency resolved. 3. Resolve: Discard as corrected. 4. New Scan: Find new 'Magic Sword' vs 'Mystic Blade' inconsistency.\nOutput:\n\`\`\`json\n{\n   "verified_inconsistencies": [],\n   "new_inconsistencies": [\n     {\n       "concept": "Magic Sword",\n       "priority": "MEDIUM",\n       "explanation": "The term for the sword is inconsistent.",\n       "suggestions": [\n         {\n           "display_text": "Standardize to 'Magic Sword'",\n           "suggestion": "Magic Sword",\n           "reasoning": "Appears first.",\n           "is_recommended": true\n         }\n       ],\n       "variations": [\n         { "phrase": "Magic Sword", "chapter": "1", "context_snippet": "..." },\n         { "phrase": "Mystic Blade", "chapter": "2", "context_snippet": "..." }\n       ]\n     }\n   ]\n}\n\`\`\`\n\nPreviously Identified Inconsistencies for Verification:\n\`\`\`json\n${JSON.stringify(r.map(({concept:e,explanation:t,variations:n})=>({concept:e,explanation:t,variations:n})),null,2)}\n\`\`\`\n\nRequired Output Format:\nYour response MUST be a single, valid JSON object with two keys: \`verified_inconsistencies\` and \`new_inconsistencies\`. Both arrays must contain objects that strictly follow the provided schema. If no items are found for a category, return an empty array (\`[]\`). Do not add any conversational text outside of the final JSON object.\n\nSchema Reference:\n\`\`\`json\n${i}\n\`\`\`\n`}else n+=`\n\nIMPORTANT: Your final output MUST be ONLY a single, valid JSON array matching this specific schema. Do not include any other text, explanations, or markdown formatting outside of the JSON array itself.\n        Schema:\n        ${i}`;return n}function j(){if(!O.config.apiKeys||0===O.config.apiKeys.length)return null;const e=O.config.apiKeys.length;for(let t=0;t<e;t++){const n=(O.runtime.currentApiKeyIndex+t)%e,i=O.config.apiKeys[n];if(O.runtime.apiKeyCooldowns.has(i)){const e=O.runtime.apiKeyCooldowns.get(i);if(Date.now()<e){h(`Key at index ${n} is on cooldown. Skipping.`);continue}h(`Cooldown for key at index ${n} has expired.`),O.runtime.apiKeyCooldowns.delete(i)}return O.runtime.currentApiKeyIndex=n,{key:i,index:n}}return h("All available API keys are currently on cooldown."),null}function U(e){console.error("Inconsistency Finder:",e),O.runtime.cumulativeResults.push({error:e}),O.runtime.isAnalysisRunning=!1,O.runtime.analysisStartedAt=null,O.runtime.deepAnalysisStartTimes&&(O.runtime.deepAnalysisStartTimes={}),ue("error","Error!"),J(O.runtime.cumulativeResults)}function H(e,t=[],n=0,i=0){const r="Analysis",o=3*Math.max(1,O.config.apiKeys.length),s=O.runtime.analysisStartedAt||Date.now();if(O.runtime.analysisStartedAt||(O.runtime.analysisStartedAt=s),n>=o)return void U(`${r} failed after ${n} attempts across all keys. Please check your API keys or wait a while.`);if(Date.now()-s>F)return void U(`${r} failed after repeated retries over an extended period. Please wait a while before trying again.`);const a=j();if(!a)return void U("All API keys are currently rate-limited or failing. Please wait a moment before trying again.");const c=a.key,l=a.index;O.runtime.isAnalysisRunning=!0,ue("running",`${r} (Key ${l+1}, Attempt ${n+1})...`);const d=e.map(e=>`--- CHAPTER ${e.chapter} ---\n${e.text}`).join("\n\n");h(`${r}: Sending ${d.length} characters to the AI. Using key index: ${l}. (Total Attempt ${n+1})`);const u={contents:[{parts:[{text:_(d,t)}]}],generationConfig:{temperature:O.config.temperature}};GM_xmlhttpRequest({method:"POST",url:`https://generativelanguage.googleapis.com/v1beta/${O.config.model}:generateContent?key=${c}`,headers:{"Content-Type":"application/json"},data:JSON.stringify(u),onload:function(a){let d,u;h("Received raw response from API:",a.responseText);try{d=JSON.parse(a.responseText)}catch(a){return h(`${r}: Failed to parse API response shell: ${a.message}. Scheduling retry with backoff.`),void z({operationName:`${r} (shell parse recovery)`,retryCount:n,maxTotalRetries:o,startedAt:s,nextStep:()=>H(e,t,n+1,i)})}if(d.error){const a=d.error.status,u=d.error.message||"";if(q.has(a)||u.includes("The model is overloaded")){h(`${r}: Retriable API Error (Status: ${a}) with key index ${l}. Rotating key and scheduling retry with backoff.`);const d="RESOURCE_EXHAUSTED"===a?2:1;return O.runtime.apiKeyCooldowns.set(c,Date.now()+1e3*d),void z({operationName:r,retryCount:n,maxTotalRetries:o,startedAt:s,nextStep:()=>H(e,t,n+1,i)})}return void U(`API Error (Status: ${a}): ${u}`)}const p=d.candidates?.[0];if(!p||!p.content){let e;return e="MAX_TOKENS"===p?.finishReason?"Analysis failed: The text from the selected chapters is too long, and the AI's response was cut off. Please try again with fewer chapters.":`Invalid API response: No content found. Finish Reason: ${p?.finishReason||"Unknown"}`,void U(e)}try{const e=I(p.content.parts[0].text);u=JSON.parse(e),h(`${r}: Successfully parsed API response content.`,u)}catch(a){return i<1?(h(`${r}: Failed to parse AI response content, scheduling retry with backoff. Error: ${a.message}`),ue("running","AI response malformed. Retrying..."),void z({operationName:`${r} (parse recovery)`,retryCount:n,maxTotalRetries:o,startedAt:s,nextStep:()=>H(e,t,n+1,i+1)})):void U(`${r} failed to process AI response content after retry: ${a.message}`)}if(O.runtime.currentApiKeyIndex=(l+1)%O.config.apiKeys.length,O.runtime.isAnalysisRunning=!1,O.runtime.analysisStartedAt=null,t.length>0){if(!u.verified_inconsistencies||!u.new_inconsistencies)return void U("Invalid response format for verification run. Expected 'verified_inconsistencies' and 'new_inconsistencies' keys.");const e=u.verified_inconsistencies||[],t=u.new_inconsistencies||[];e.forEach(e=>{e.isNew=!1,e.status="Verified"}),t.forEach(e=>{e.isNew=!0}),h(`Verification complete. ${e.length} concepts re-verified. ${t.length} new concepts found.`),O.runtime.cumulativeResults=[...e,...t]}else{if(!Array.isArray(u))return void U("Invalid response format for initial run. Expected a JSON array.");u.forEach(e=>e.isNew=!0),O.runtime.cumulativeResults=u}P(),ue("complete","Complete!");const f=document.getElementById("wtr-if-continue-btn");f&&(f.disabled=!1),J(O.runtime.cumulativeResults)},onerror:function(a){console.error("Inconsistency Finder: Network error:",a),h(`${r}: Network error with key index ${l}. Rotating key and scheduling retry with backoff.`),O.runtime.apiKeyCooldowns.set(c,Date.now()+1e3),z({operationName:r,retryCount:n,maxTotalRetries:o,startedAt:s,nextStep:()=>H(e,t,n+1,i)})}})}function V(e,t=[],n=1,i=1){if(i>n)return O.runtime.isAnalysisRunning=!1,ue("complete",n>1?`Complete! (Deep Analysis: ${n} iterations)`:"Complete!"),document.getElementById("wtr-if-continue-btn").disabled=!1,void J(O.runtime.cumulativeResults);h(`Starting deep analysis iteration ${i}/${n}`),ue("running",n>1||i>1?`Deep Analysis (${i}/${n})...`:"Analyzing...");const r=O.runtime.cumulativeResults.length>0?O.runtime.cumulativeResults:t;n>1?function(e,t,n,i){const r=3*Math.max(1,O.config.apiKeys.length);let o=0,s=0;const a=`deep_${i}`,c=Date.now();O.runtime.deepAnalysisStartTimes||(O.runtime.deepAnalysisStartTimes={}),O.runtime.deepAnalysisStartTimes[a]||(O.runtime.deepAnalysisStartTimes[a]=c);const l=O.runtime.deepAnalysisStartTimes[a],d=`Deep analysis iteration ${i}/${n}`,u=()=>{if(o>=r)return U(`${d} failed after ${o} attempts. Please check your API keys or wait a while.`),void delete O.runtime.deepAnalysisStartTimes[a];if(Date.now()-l>F)return U(`${d} failed after repeated retries over an extended period. Please wait a while before trying again.`),void delete O.runtime.deepAnalysisStartTimes[a];const c=j();if(!c)return U("All API keys are currently rate-limited or failing. Please wait a moment before trying again."),void delete O.runtime.deepAnalysisStartTimes[a];const p=c.key,f=c.index,g=e.map(e=>`--- CHAPTER ${e.chapter} ---\n${e.text}`).join("\n\n");h(`${d}: Sending ${g.length} characters to the AI. Using key index: ${f}. (Total Attempt ${o+1})`);const m={contents:[{parts:[{text:_(g,t)}]}],generationConfig:{temperature:O.config.temperature}};GM_xmlhttpRequest({method:"POST",url:`https://generativelanguage.googleapis.com/v1beta/${O.config.model}:generateContent?key=${p}`,headers:{"Content-Type":"application/json"},data:JSON.stringify(m),onload:function(c){let g,m;h("Received raw response from API:",c.responseText);try{g=JSON.parse(c.responseText)}catch(e){return h(`${d}: Failed to parse API response shell: ${e.message}. Scheduling retry with backoff.`),void z({operationName:`${d} (shell parse recovery)`,retryCount:o,maxTotalRetries:r,startedAt:l,nextStep:()=>{o++,u()}})}if(g.error){const e=g.error.status,t=g.error.message||"";if(q.has(e)||t.includes("The model is overloaded")){h(`${d}: Retriable API Error (Status: ${e}) with key index ${f}. Rotating key and scheduling retry with backoff.`);const t="RESOURCE_EXHAUSTED"===e?2:1;return O.runtime.apiKeyCooldowns.set(p,Date.now()+1e3*t),void z({operationName:d,retryCount:o,maxTotalRetries:r,startedAt:l,nextStep:()=>{o++,u()}})}return U(`API Error (Status: ${e}): ${t}`),void delete O.runtime.deepAnalysisStartTimes[a]}const y=g.candidates?.[0];if(!y||!y.content){let e;return e="MAX_TOKENS"===y?.finishReason?"Analysis failed: The text from the selected chapters is too long, and the AI's response was cut off. Please try again with fewer chapters.":`Invalid API response: No content found. Finish Reason: ${y?.finishReason||"Unknown"}`,U(e),void delete O.runtime.deepAnalysisStartTimes[a]}try{const e=I(y.content.parts[0].text);m=JSON.parse(e),h(`${d}: Successfully parsed API response content.`,m)}catch(e){return s<1?(h(`${d}: Failed to parse AI response content, scheduling retry with backoff. Error: ${e.message}`),ue("running","AI response malformed. Retrying..."),void z({operationName:`${d} (parse recovery)`,retryCount:o,maxTotalRetries:r,startedAt:l,nextStep:()=>{o++,s++,u()}})):(U(`${d} failed to process AI response content after retry: ${e.message}`),void delete O.runtime.deepAnalysisStartTimes[a])}if(O.runtime.currentApiKeyIndex=(f+1)%O.config.apiKeys.length,t.length>0){if(!m.verified_inconsistencies||!m.new_inconsistencies)return U("Invalid response format for verification run. Expected 'verified_inconsistencies' and 'new_inconsistencies' keys."),void delete O.runtime.deepAnalysisStartTimes[a];const e=m.verified_inconsistencies||[],t=m.new_inconsistencies||[];e.forEach(e=>{e.isNew=!1,e.status="Verified"}),t.forEach(e=>{e.isNew=!0}),h(`${d}: ${e.length} concepts re-verified. ${t.length} new concepts found.`);const n=[...e,...t];O.runtime.cumulativeResults=A(O.runtime.cumulativeResults,n)}else{if(!Array.isArray(m))return U("Invalid response format for initial run. Expected a JSON array."),void delete O.runtime.deepAnalysisStartTimes[a];m.forEach(e=>e.isNew=!0),O.runtime.cumulativeResults=A(O.runtime.cumulativeResults,m)}if(P(),O.runtime.currentIteration=i+1,i<n)setTimeout(()=>{V(e,O.runtime.cumulativeResults,n,i+1)},1e3);else{delete O.runtime.deepAnalysisStartTimes[a],O.runtime.isAnalysisRunning=!1,ue("complete",`Complete! (Deep Analysis: ${n} iterations)`);const e=document.getElementById("wtr-if-continue-btn");e&&(e.disabled=!1),J(O.runtime.cumulativeResults)}},onerror:function(e){console.error("Inconsistency Finder: Network error:",e),h(`${d}: Network error with key index ${f}. Rotating key and scheduling retry with backoff.`),O.runtime.apiKeyCooldowns.set(p,Date.now()+1e3),z({operationName:d,retryCount:o,maxTotalRetries:r,startedAt:l,nextStep:()=>{o++,u()}})}})};u()}(e,r,n,i):H(e,r)}function J(e){const t=document.getElementById("wtr-if-tab-finder"),n=t&&t.querySelector("#wtr-if-results")||document.getElementById("wtr-if-results");if(!n)return void h("displayResults: No #wtr-if-results container found; aborting render.");n.innerHTML="";const i=document.getElementById("wtr-if-filter-select")?.value||"all";let r=e.filter(e=>!e.error&&e.concept);const o=e.filter(e=>e.error);if("new"===i?r=r.filter(e=>e.isNew):"verified"===i?r=r.filter(e=>"Verified"===e.status||!1===e.isNew&&"Verified"!==e.status):"all"!==i&&(r=r.filter(e=>e.priority===i)),0===r.length&&0===o.length)return void(n.innerHTML='<div class="wtr-if-no-results">No inconsistencies found matching the current filter.</div>');const s={CRITICAL:1,HIGH:2,MEDIUM:3,LOW:4,STYLISTIC:5,INFO:6};r.sort((e,t)=>(s[e.priority]||99)-(s[t.priority]||99));const a=document.createDocumentFragment();r.forEach(e=>{const t=document.createElement("div");t.className="wtr-if-result-group";const n=[...new Set(e.variations.map(e=>e.phrase))],i=JSON.stringify(n),r=(e.suggestions||[]).map((t,n)=>{const r=t.suggestion;let o="",s=!1;if("string"==typeof r&&r&&""!==r.trim())o=r.trim(),s=!0;else if(t.display_text&&t.display_text.trim()){const e=t.display_text.replace(/^(standardize to|use|change to|replace with|update to)\s*/i,"").replace(/^['"`]|['"`]$/g,"").trim();e&&e!==t.display_text&&(o=e,s=!0)}O.config.loggingEnabled&&!s&&h(`Suggestion validation for "${e.concept}" #${n}:`,{originalSuggestion:r,displayText:t.display_text,finalSuggestionValue:o,isActionable:s});const a=s?`<code>${E(o)}</code>`:"<em>(Informational, no replacement)</em>",c=s?"":"disabled",l=s?`Apply '${E(o)}'`:"No direct replacement",d=t.is_recommended?'<span class="wtr-if-recommended-badge">Recommended</span>':"";return`\n             <div class="wtr-if-suggestion-item">\n                 <div class="wtr-if-suggestion-header">\n                     <span class="wtr-if-correct">${E(t.display_text||r||"No suggestion available")} ${d}</span>\n                     <div class="wtr-if-suggestion-actions">\n                         <button class="wtr-if-apply-btn" data-action="apply-selected" data-suggestion="${E(o)}" title="${l} to selected variations" ${c}>Apply Selected</button>\n                         <button class="wtr-if-apply-btn" data-action="apply-all" data-suggestion="${E(o)}" data-variations='${E(i)}' title="${l} to all variations" ${c}>Apply All</button>\n                     </div>\n                 </div>\n                 <p class="wtr-if-replacement-info"><strong>Replacement:</strong> ${a}</p>\n                 <p class="wtr-if-reasoning">${E(t.reasoning)}</p>\n             </div>\n             `}).join("");t.innerHTML=`\n                <div class="wtr-if-group-header">\n                    <h3>\n                        <span class="wtr-if-priority wtr-if-priority-${(e.priority||"info").toLowerCase()}">${E(e.priority||"INFO")}</span>\n                        Concept: <span class="wtr-if-concept">${E(e.concept)}</span>\n                        ${"Verified"===e.status||!1===e.isNew&&"Verified"!==e.status?'<span class="wtr-if-verified-badge">Verified</span>':""}\n                    </h3>\n                    <p class="wtr-if-explanation">${E(e.explanation)}</p>\n                </div>\n                <div class="wtr-if-details-section">\n                    <h4>Variations Found</h4>\n                    <div class="wtr-if-variations">\n                        ${(e.variations||[]).map(e=>`\n                        <div class="wtr-if-variation-item">\n                            <div class="wtr-if-variation-header">\n                                <input type="checkbox" class="wtr-if-variation-checkbox" value="${E(e.phrase)}" title="Select this variation">\n                                <button class="wtr-if-copy-variation-btn" data-text="${E(e.phrase)}" title="Copy variation text">📋</button>\n                                <span class="wtr-if-incorrect">"${E(e.phrase)}"</span>\n                                <span class="wtr-if-chapter">Chapter ${E(e.chapter)}</span>\n                            </div>\n                            <p class="wtr-if-context"><strong>Context:</strong> <em>"...${E(e.context_snippet)}..."</em></p>\n                        </div>\n                        `).join("")}\n                    </div>\n                </div>\n                <div class="wtr-if-details-section">\n                    <h4>Suggestions</h4>\n                    <div class="wtr-if-suggestions">\n                        ${r}\n                    </div>\n                </div>\n            `,a.appendChild(t)}),n.appendChild(a),o.slice().reverse().forEach(e=>{const t=document.createElement("div");t.className="wtr-if-error",t.textContent=e.error,n.prepend(t)});const c=document.getElementById("wtr-if-tab-finder")||n;c&&c.querySelectorAll(".wtr-if-apply-btn").forEach(e=>{if(e.dataset.role||(e.dataset.role="wtr-if-apply-action"),!e.dataset.scope){const t=e.dataset.action||"";t.endsWith("-selected")?e.dataset.scope="selected":t.endsWith("-all")&&(e.dataset.scope="all")}e.addEventListener("click",ne)}),n.querySelectorAll(".wtr-if-copy-variation-btn").forEach(e=>e.addEventListener("click",ie))}function K(e=!1){if(O.runtime.isAnalysisRunning)return void alert("An analysis is already in progress.");if(!O.config.apiKeys||0===O.config.apiKeys.length||!O.config.model)return alert("Please add at least one API key and select a model in the Configuration tab first."),document.querySelector('.wtr-if-tab-btn[data-tab="config"]').click(),void de(!0);const t=Math.max(1,parseInt(O.config.deepAnalysisDepth)||1);e||(O.runtime.cumulativeResults=[],O.runtime.apiKeyCooldowns.clear(),O.runtime.currentApiKeyIndex=0,O.runtime.currentIteration=1,O.runtime.totalIterations=t,document.getElementById("wtr-if-results").innerHTML="",document.getElementById("wtr-if-continue-btn").disabled=!0,document.getElementById("wtr-if-filter-select").value="all",B()),e&&O.session.hasSavedResults&&(document.getElementById("wtr-if-continue-btn").disabled=!1),O.config.useJson?(document.getElementById("wtr-if-file-input").dataset.continuation=e,document.getElementById("wtr-if-file-input").click()):(V(w(b(y())),e?O.runtime.cumulativeResults:[],t),de(!1))}function W(){const e=document.querySelectorAll(".wtr-if-api-key-input"),t=[];e.forEach(e=>{const n=e.value.trim();n&&t.push(n)}),O.config.apiKeys=t,O.config.model=document.getElementById("wtr-if-model").value,O.config.useJson=document.getElementById("wtr-if-use-json").checked,O.config.loggingEnabled=document.getElementById("wtr-if-logging-enabled").checked,O.config.temperature=parseFloat(document.getElementById("wtr-if-temperature").value);const n=document.getElementById("wtr-if-status");n.textContent="Saving...";const i=D();n.textContent=i?"Configuration saved successfully!":"Failed to save configuration.",setTimeout(()=>n.textContent="",3e3)}function G(){K(!1)}function Y(){K(!0)}function Q(e){const t=e.target.files[0];if(!t)return;const n="true"===e.target.dataset.continuation,i=new FileReader;i.onload=t=>{try{const e=JSON.parse(t.target.result),i=function(){const e=window.location.pathname.match(/novel\/\d+\/([^/]+)/);return e?e[1]:null}();if(h(`Detected novel slug: "${i}"`),!e||"object"!=typeof e)throw new Error("File is not a valid JSON object.");if(!e.terms||"object"!=typeof e.terms)throw new Error("JSON must contain a top-level 'terms' object.");const r=e.terms[i];if(void 0===r)h(`No replacement terms found for novel slug "${i}" in the JSON file.`),alert(`No terms found for the current novel ("${i}") in this file. Analysis will proceed without replacements.`);else{if(!Array.isArray(r))throw new Error(`The entry for "${i}" must be an array of term objects.`);if(r.length>0&&(!Object.prototype.hasOwnProperty.call(r[0],"original")||!Object.prototype.hasOwnProperty.call(r[0],"replacement")))throw new Error(`Term objects for "${i}" must contain 'original' and 'replacement' properties.`)}const o=w(b(y()),r||[]),s=Math.max(1,parseInt(O.config.deepAnalysisDepth)||1);V(o,n?O.runtime.cumulativeResults:[],s),de(!1)}catch(e){alert("Failed to read or parse the JSON file. Error: "+e.message)}finally{e.target.value=""}},i.readAsText(t)}function Z(){if(O.session.hasSavedResults){J(O.runtime.cumulativeResults),te();const e=document.getElementById("wtr-if-session-restore");e&&(e.style.display="none");const t=document.getElementById("wtr-if-continue-btn");t&&(t.disabled=!1);const n=document.getElementById("wtr-if-status");n&&(n.textContent=`Restored ${O.runtime.cumulativeResults.length} results from previous session`,setTimeout(()=>n.textContent="",3e3))}}function X(){B();const e=document.getElementById("wtr-if-session-restore");e&&(e.style.display="none");const t=document.getElementById("wtr-if-continue-btn");t&&(t.disabled=!0);const n=document.getElementById("wtr-if-status");n&&(n.textContent="Saved session results cleared",setTimeout(()=>n.textContent="",3e3))}function ee(){const e=document.getElementById("wtr-if-status-indicator");if(e.classList.contains("complete")||e.classList.contains("error")){de(!0);const e=document.querySelector('.wtr-if-tab-btn[data-tab="finder"]');e&&e.click(),Array.isArray(O.runtime.cumulativeResults)&&O.runtime.cumulativeResults.length>0&&J(O.runtime.cumulativeResults),ue("hidden"),te()}}function te(){let e=!1;try{e=C()}catch(t){h("WTR Lab Term Replacer detection failed in updateApplyCopyButtonsMode; falling back to safe copy mode.",t),e=!1}const t=document.getElementById("wtr-if-tab-finder");function n(t,n){if(!t)return;const i="selected"===n,r=i?"Apply Selected":"Apply All",o=i?"Copy Selected":"Copy All",s=i?"apply-selected":"apply-all",a=i?"copy-selected":"copy-all";t.textContent=e?r:o,t.dataset.action=e?s:a}t&&(n(t.querySelector("#wtr-if-apply-selected"),"selected"),n(t.querySelector("#wtr-if-apply-all"),"all"),t.querySelectorAll("[data-role='wtr-if-apply-action'], .wtr-if-apply-btn").forEach(e=>{let t=e.dataset.scope||e.getAttribute("data-scope");if(!t){const n=e.dataset.action||"";n.endsWith("-selected")?t="selected":n.endsWith("-all")&&(t="all")}"selected"!==t&&"all"!==t||n(e,t)}))}function ne(e){const t=e.currentTarget,n=t.dataset.action||"",i=t.dataset.suggestion||"";let r=[],o=!1;try{o=C()}catch{o=!1}if(O.config.loggingEnabled&&h("Apply/Copy button click",{action:n,replacementValue:i,replacementLength:i?i.length:"empty",buttonDataset:{...t.dataset},externalAvailable:o}),"apply-all"===n||"copy-all"===n)try{r=JSON.parse(t.dataset.variations||"[]")}catch(e){h("Failed to parse variations for apply-all/copy-all.",e),r=[]}else if("apply-selected"===n||"copy-selected"===n){const e=t.closest(".wtr-if-result-group");e&&e.querySelectorAll(".wtr-if-variation-checkbox:checked").forEach(e=>r.push(e.value))}const s=[...new Set(r)];if(0===s.length){const e=t.textContent;return t.textContent="None Selected!",void setTimeout(()=>{t.textContent=e},2e3)}const a=i&&""!==i.trim()?i.trim():null;if("copy-selected"===n||"copy-all"===n){a||O.config.loggingEnabled&&h("Copy action invoked without a valid suggestion; falling back to variations-only output.",{uniqueVariations:s});const e=s.join("|"),n=a||"";let i="";if(e&&(i+=`Term: ${e}\n`),n&&(i+=`Replaced: ${n}\n`),!i){const e=t.textContent;return t.textContent="Nothing to Copy",void setTimeout(()=>{t.textContent=e},1500)}const r=e=>navigator.clipboard&&navigator.clipboard.writeText?navigator.clipboard.writeText(e):new Promise((t,n)=>{try{const i=document.createElement("textarea");i.value=e,i.style.position="fixed",i.style.opacity="0",document.body.appendChild(i),i.select();const r=document.execCommand("copy");document.body.removeChild(i),r?t():n(new Error("execCommand copy failed"))}catch(e){n(e)}}),o=t.textContent;return void r(i.trimEnd()).then(()=>{t.textContent="Copied!",setTimeout(()=>{t.textContent=o},1500)}).catch(e=>{h("Failed to copy terms payload.",e),t.textContent="Copy Failed",setTimeout(()=>{t.textContent=o},1500)})}if("apply-selected"!==n&&"apply-all"!==n)return;if(!o)return void h("Apply action attempted while external replacer is not available; ignoring.",{action:n,uniqueVariations:s});if(!a){h("ERROR: Empty or invalid replacement value detected. Aborting term addition.",{originalReplacement:i,variations:s});const e=t.textContent;return t.textContent="Invalid Suggestion!",t.style.backgroundColor="#dc3545",void setTimeout(()=>{t.textContent=e,t.style.backgroundColor=""},3e3)}let c,l;s.length>1?(s.sort((e,t)=>t.length-e.length),c=s.map(e=>T(e)).join("|"),l=!0,h(`Applying suggestion "${a}" via multi-term regex: /${c}/gi`)):(c=s[0],l=!1,h(`Applying suggestion "${a}" via simple replacement for: "${c}"`));const d=new CustomEvent("wtr:addTerm",{detail:{original:c,replacement:a,isRegex:l}});window.dispatchEvent(d);const u=t.textContent;t.classList.add("sent"),t.textContent="Applied!",setTimeout(()=>{t.classList.remove("sent"),t.textContent=u},2e3)}function ie(e){const t=e.currentTarget,n=t.dataset.text;n&&navigator.clipboard.writeText(n).then(()=>{const e=t.innerHTML;t.innerHTML="✅",t.disabled=!0,setTimeout(()=>{t.innerHTML=e,t.disabled=!1},1500)}).catch(e=>{console.error("Inconsistency Finder: Failed to copy text:",e);const n=t.innerHTML;t.innerHTML="❌",setTimeout(()=>{t.innerHTML=n},1500)})}function re(){const e={version:"5.2",timestamp:(new Date).toISOString(),config:O.config,preferences:{autoRestoreResults:O.preferences.autoRestoreResults}},t=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),n=URL.createObjectURL(t),i=document.createElement("a");i.href=n,i.download=`WTR Lab Term Inconsistency Finder-5.2-config-${(new Date).toISOString().split("T")[0]}.json`,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(n);const r=document.getElementById("wtr-if-status");r.textContent="Configuration exported successfully",setTimeout(()=>r.textContent="",3e3)}function oe(){const e=document.createElement("input");e.type="file",e.accept=".json",e.onchange=e=>{const t=e.target.files[0];if(!t)return;const n=new FileReader;n.onload=e=>{try{const t=JSON.parse(e.target.result);if(!t.config||!t.version)throw new Error("Invalid configuration file format");O.config,O.config={...O.config,...t.config},t.preferences&&(O.preferences={...O.preferences,...t.preferences}),D(),ce(),se(),document.getElementById("wtr-if-use-json").checked=O.config.useJson,document.getElementById("wtr-if-logging-enabled").checked=O.config.loggingEnabled,document.getElementById("wtr-if-auto-restore").checked=O.preferences.autoRestoreResults,document.getElementById("wtr-if-temperature").value=O.config.temperature,document.getElementById("wtr-if-temp-value").textContent=O.config.temperature;const n=document.getElementById("wtr-if-status");n.textContent="Configuration imported successfully",setTimeout(()=>n.textContent="",3e3)}catch(e){alert("Failed to import configuration: "+e.message)}},n.readAsText(t)},e.click()}async function se(){const e=document.getElementById("wtr-if-model");e.innerHTML="<option>Loading from cache...</option>",e.disabled=!0;const t=await GM_getValue(N,null);t&&t.models&&t.models.length>0?(e.innerHTML=t.models.map(e=>`<option value="${e}">${e.replace("models/","")}</option>`).join(""),e.value=O.config.model):e.innerHTML='<option value="">No models cached. Please refresh.</option>',e.disabled=!1}async function ae(){const e=j(),t=document.getElementById("wtr-if-status");if(!e)return t.textContent="Error: No available API keys. Add one or wait for cooldowns.",void setTimeout(()=>t.textContent="",4e3);const n=e.key;t.textContent="Fetching model list...",document.getElementById("wtr-if-refresh-models-btn").disabled=!0,GM_xmlhttpRequest({method:"GET",url:`https://generativelanguage.googleapis.com/v1beta/models?key=${n}`,onload:async function(e){try{const n=JSON.parse(e.responseText);if(n.error)throw new Error(n.error.message);const i=n.models.filter(e=>e.supportedGenerationMethods.includes("generateContent")).map(e=>e.name);i.length>0?(await GM_setValue(N,{timestamp:Date.now(),models:i}),t.textContent=`Success! Found ${i.length} models.`,await se()):t.textContent="No compatible models found."}catch(e){t.textContent=`Error: ${e.message}`}finally{setTimeout(()=>t.textContent="",4e3),document.getElementById("wtr-if-refresh-models-btn").disabled=!1}},onerror:function(e){console.error("Model fetch error:",e),t.textContent="Network error while fetching models.",setTimeout(()=>t.textContent="",4e3),document.getElementById("wtr-if-refresh-models-btn").disabled=!1}})}function ce(){const e=document.getElementById("wtr-if-api-keys-container");e.innerHTML="",(O.config.apiKeys.length>0?O.config.apiKeys:[""]).forEach(t=>{const n=document.createElement("div");n.className="wtr-if-key-row",n.innerHTML=`\n            <input type="password" class="wtr-if-api-key-input" value="${E(t)}" placeholder="Enter your API key">\n            <button class="wtr-if-remove-key-btn" title="Remove this key">&times;</button>\n        `,e.appendChild(n)})}function le(){const e=document.getElementById("wtr-if-api-keys-container"),t=document.createElement("div");t.className="wtr-if-key-row",t.innerHTML='\n        <input type="password" class="wtr-if-api-key-input" placeholder="Enter your API key">\n        <button class="wtr-if-remove-key-btn" title="Remove this key">&times;</button>\n    ',e.appendChild(t),t.querySelector("input").focus()}async function de(e=null){const t=document.getElementById("wtr-if-panel"),n="flex"===t.style.display,i=null!==e?e:!n;if(t.style.display=i?"flex":"none",i){ce(),document.getElementById("wtr-if-use-json").checked=O.config.useJson,document.getElementById("wtr-if-logging-enabled").checked=O.config.loggingEnabled,document.getElementById("wtr-if-auto-restore").checked=O.preferences.autoRestoreResults;const e=document.getElementById("wtr-if-temperature"),n=document.getElementById("wtr-if-temp-value");e.value=O.config.temperature,n.textContent=O.config.temperature,t.querySelectorAll(".wtr-if-tab-btn").forEach(e=>e.classList.remove("active")),t.querySelectorAll(".wtr-if-tab-content").forEach(e=>e.classList.remove("active"));const i=t.querySelector(`.wtr-if-tab-btn[data-tab="${O.config.activeTab}"]`),r=t.querySelector(`#wtr-if-tab-${O.config.activeTab}`);i&&i.classList.add("active"),r&&r.classList.add("active"),document.getElementById("wtr-if-deep-analysis-depth").value=O.config.deepAnalysisDepth.toString(),document.getElementById("wtr-if-filter-select").value=O.config.activeFilter,await se();try{const e=C(),t=document.getElementById("wtr-if-use-json-container"),n=document.getElementById("wtr-if-use-json"),i=document.getElementById("wtr-if-term-replacer-mode-hint");t&&n&&i&&(e?(t.style.display="",n.disabled=!1,i.textContent="Detected WTR Lab Term Replacer userscript. You can use the Term Replacer JSON file format or send suggestions directly via the integration buttons."):(t.style.display="none",n.checked=!1,O.config.useJson&&(O.config.useJson=!1),i.textContent="External WTR Lab Term Replacer userscript not detected. Using built-in term inconsistency finder behavior only. Install the external userscript if you want tight integration."))}catch(e){h("WTR Lab Term Replacer UI integration (togglePanel) failed; continuing in safe mode.",e)}const o=document.getElementById("wtr-if-session-restore");O.session.hasSavedResults&&O.preferences.autoRestoreResults?Z():O.session.hasSavedResults?o.style.display="block":o.style.display="none"}}function ue(e,t=""){const n=document.getElementById("wtr-if-status-indicator");if(!n)return;const i=n.querySelector(".wtr-if-status-icon"),r=n.querySelector(".wtr-if-status-text");n.className=e,r.textContent=t,i.textContent="",n.style.display="hidden"===e?"none":"flex",ge()}const pe={BASE:"var(--nig-space-xl, 20px)",NIG_CONFLICT:"80px",SAFE_DEFAULT:"60px"},fe={isMonitoringActive:!1,lastNigWidgetState:null,currentPosition:null,lastZIndex:null,debounceTimer:null,lastAppliedBottom:null};function ge(){const e=document.getElementById("wtr-if-status-indicator");if(!e)return;"fixed"!==getComputedStyle(e).position&&(e.style.position="fixed",e.style.left||(e.style.left="20px"));const t=document.querySelector(".nig-status-widget, #nig-status-widget"),{position:n,zIndex:i,states:r}=function(e,t){const n=function(e){if(!e)return!1;const t=getComputedStyle(e);if("none"===t.display||"hidden"===t.visibility||"0"===t.opacity)return!1;const n=e.getBoundingClientRect();return n.width>0&&n.height>0}(e),i={nig:n?"present":"absent"};if(!t)return{position:pe.BASE,zIndex:1025,states:i};let r=!1;if(n&&e){const n=t.getBoundingClientRect(),i=e.getBoundingClientRect(),o=20,s=(window.innerHeight||document.documentElement.clientHeight)-o-n.height,a={top:s,bottom:s+n.height,left:n.left,right:n.right},c=a.bottom>i.top,l=a.right>i.left&&a.left<i.right;c&&l&&(r=!0)}return{position:r?pe.NIG_CONFLICT:pe.BASE,zIndex:1025,states:i}}(t,e);!function(e,t,n){if(!e)return;const i=t,r=n||1025;fe.lastAppliedBottom===i&&fe.lastZIndex===r||(fe.currentPosition=i,fe.lastAppliedBottom=i,fe.lastZIndex=r,e.style.bottom=i,e.style.zIndex=String(r),h(`Position updated to: ${i}, Z-index: ${r}`))}(e,n,i),fe.lastNigWidgetState=r.nig}function me(){fe.isMonitoringActive=!0,ge(),function(){const e=function(){let e;return function(...t){clearTimeout(e),e=setTimeout(()=>{clearTimeout(e),(()=>{fe.isMonitoringActive&&ge()})(...t)},150)}}(),t=new MutationObserver(t=>{t.some(e=>"childList"===e.type?e.addedNodes.length>0||e.removedNodes.length>0:"attributes"===e.type&&["style","class","display"].includes(e.attributeName))&&e()});t.observe(document.body,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["style","class","id","display"]});const n=document.querySelector(".nig-status-widget, #nig-status-widget");n&&t.observe(n,{attributes:!0,attributeFilter:["style","class","display"]});const i=document.querySelector("nav.bottom-reader-nav")||document.querySelector(".bottom-reader-nav")||document.querySelector(".fixed-bottom");i&&t.observe(i,{attributes:!0,childList:!0,subtree:!0}),h("Enhanced conflict observer initialized (NIG widget, bottom reader nav, and related widgets).")}(),function(){let e;window.addEventListener("scroll",()=>{fe.isMonitoringActive&&(clearTimeout(e),e=setTimeout(()=>{ge()},150))},{passive:!0}),h("Scroll listener initialized for collision detection.")}(),function(){let e;window.addEventListener("resize",()=>{fe.isMonitoringActive&&(clearTimeout(e),e=setTimeout(()=>{ge()},250))}),h("Resize listener initialized for collision detection.")}(),h("Dynamic collision avoidance system initialized.")}!async function(){try{await async function(){const e=await GM_getValue($,{});e.apiKey&&!e.apiKeys&&(h("Migrating legacy single API key to new array format."),e.apiKeys=[e.apiKey],delete e.apiKey),e.preferences&&(O.preferences={...O.preferences,...e.preferences},h("Loaded preferences from config:",O.preferences)),O.config={...O.config,...e};const t=sessionStorage.getItem(L);if(t)try{const e=JSON.parse(t),n=e.results||[],i=n.map(e=>e.suggestions&&Array.isArray(e.suggestions)?{...e,suggestions:e.suggestions.map(M)}:e);if(O.runtime.cumulativeResults=i,O.session.hasSavedResults=!0,O.session.lastAnalysisTime=e.timestamp,h("Session results loaded and sanitized:",O.runtime.cumulativeResults.length,"items"),i.length!==n.length)h("🔧 Data sanitization: Results count changed during cleanup");else{let e=0;for(let t=0;t<i.length;t++){const r=n[t],o=i[t];if(r.suggestions&&o.suggestions)for(let t=0;t<o.suggestions.length;t++)r.suggestions[t]?.suggestion!==o.suggestions[t]?.suggestion&&e++}e>0&&h(`🔧 Data sanitization: Fixed ${e} corrupted suggestion fields`)}}catch(e){h("Failed to parse session results:",e)}}(),h("Configuration loaded."),function(){if(document.getElementById("wtr-if-panel"))return;const e=document.createElement("div");e.id="wtr-if-panel",e.innerHTML=`\n            <div class="wtr-if-header"><h2>Term Inconsistency Finder ${m.VERSION}</h2><button class="wtr-if-close-btn">&times;</button></div>\n            <div class="wtr-if-tabs">\n                <button class="wtr-if-tab-btn" data-tab="finder">Finder</button>\n                <button class="wtr-if-tab-btn" data-tab="config">Configuration</button>\n            </div>\n            <div class="wtr-if-content">\n                <input type="file" id="wtr-if-file-input" accept=".json" style="display: none;">\n                <div id="wtr-if-tab-finder" class="wtr-if-tab-content">\n                    \x3c!-- Primary Analysis Controls Section --\x3e\n                    <div class="wtr-if-section">\n                        <div class="wtr-if-section-header">\n                            <h3><i class="wtr-if-icon">🔍</i> Primary Analysis Controls</h3>\n                        </div>\n                        <div class="wtr-if-section-content">\n                            <div class="wtr-if-finder-controls">\n                                <button id="wtr-if-find-btn" class="wtr-if-btn wtr-if-btn-primary wtr-if-btn-large">Find Inconsistencies</button>\n                                <button id="wtr-if-continue-btn" class="wtr-if-btn wtr-if-btn-secondary wtr-if-btn-large" disabled>Continue Analysis</button>\n                            </div>\n                        </div>\n                    </div>\n\n                    \x3c!-- Deep Analysis Configuration Section --\x3e\n                    <div class="wtr-if-section">\n                        <div class="wtr-if-section-header">\n                            <h3><i class="wtr-if-icon">⚙️</i> Deep Analysis Configuration</h3>\n                        </div>\n                        <div class="wtr-if-section-content">\n                            <div class="wtr-if-deep-analysis-controls">\n                                <div class="wtr-if-form-row">\n                                    <label for="wtr-if-deep-analysis-depth" class="wtr-if-form-label">Analysis Depth:</label>\n                                    <select id="wtr-if-deep-analysis-depth" class="wtr-if-form-select">\n                                        <option value="1">1 (Single Analysis)</option>\n                                        <option value="2">2 (Deep Analysis)</option>\n                                        <option value="3">3 (Very Deep Analysis)</option>\n                                        <option value="4">4 (Maximum Analysis)</option>\n                                        <option value="5">5 (Ultra Deep Analysis)</option>\n                                    </select>\n                                </div>\n                                <small class="wtr-if-hint">Run multiple analysis iterations for more comprehensive results. Higher values provide better accuracy but take longer.</small>\n                            </div>\n                        </div>\n                    </div>\n\n                    \x3c!-- Filter and Display Controls Section --\x3e\n                    <div class="wtr-if-section">\n                        <div class="wtr-if-section-header">\n                            <h3><i class="wtr-if-icon">🎛️</i> Filter and Display Controls</h3>\n                        </div>\n                        <div class="wtr-if-section-content">\n                            <div class="wtr-if-filter-controls">\n                                <div class="wtr-if-form-row">\n                                    <label for="wtr-if-filter-select" class="wtr-if-form-label">Filter Results:</label>\n                                    <select id="wtr-if-filter-select" class="wtr-if-form-select">\n                                        <option value="all">Show All</option>\n                                        <option value="new">Show New Only</option>\n                                        <option value="verified">Show Verified Only</option>\n                                        <option value="CRITICAL">Priority: Critical</option>\n                                        <option value="HIGH">Priority: High</option>\n                                        <option value="MEDIUM">Priority: Medium</option>\n                                        <option value="LOW">Priority: Low</option>\n                                        <option value="STYLISTIC">Priority: Stylistic</option>\n                                        <option value="INFO">Priority: Info</option>\n                                    </select>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n\n                    \x3c!-- Results Display Area Section --\x3e\n                    <div class="wtr-if-section">\n                        <div class="wtr-if-section-header">\n                            <h3><i class="wtr-if-icon">📋</i> Results Display Area</h3>\n                        </div>\n                        <div class="wtr-if-section-content">\n                            <div id="wtr-if-results"></div>\n                        </div>\n                    </div>\n                </div>\n                <div id="wtr-if-tab-config" class="wtr-if-tab-content">\n                    \x3c!-- API Keys Management Section --\x3e\n                    <div class="wtr-if-section">\n                        <div class="wtr-if-section-header">\n                            <h3><i class="wtr-if-icon">🔑</i> API Keys Management</h3>\n                        </div>\n                        <div class="wtr-if-section-content">\n                            <div class="wtr-if-form-group">\n                                <label>Gemini API Keys</label>\n                                <div class="wtr-if-api-keys-container-wrapper">\n                                    <div id="wtr-if-api-keys-container"></div>\n                                </div>\n                                <button id="wtr-if-add-key-btn" class="wtr-if-btn wtr-if-btn-secondary" style="margin-top: 8px; width: auto; padding: 5px 10px; font-size: 12px;">+ Add Key</button>\n                            </div>\n                        </div>\n                    </div>\n\n                    \x3c!-- Model Configuration Section --\x3e\n                    <div class="wtr-if-section">\n                        <div class="wtr-if-section-header">\n                            <h3><i class="wtr-if-icon">🤖</i> Model Configuration</h3>\n                        </div>\n                        <div class="wtr-if-section-content">\n                            <div class="wtr-if-form-group">\n                                <label for="wtr-if-model">Gemini Model</label>\n                                <div class="wtr-if-model-controls">\n                                    <select id="wtr-if-model"></select>\n                                    <button id="wtr-if-refresh-models-btn" class="wtr-if-btn wtr-if-btn-secondary">Refresh List</button>\n                                </div>\n                            </div>\n                            <div class="wtr-if-form-group">\n                                <label for="wtr-if-temperature">AI Temperature (<span id="wtr-if-temp-value">0.5</span>)</label>\n                                <input type="range" id="wtr-if-temperature" min="0" max="1" step="0.1" value="0.5">\n                                <small class="wtr-if-hint">Lower is more predictable, higher is more creative.</small>\n                            </div>\n                        </div>\n                    </div>\n\n                    \x3c!-- Advanced Settings Section --\x3e\n                    <div class="wtr-if-section">\n                        <div class="wtr-if-section-header">\n                            <h3><i class="wtr-if-icon">⚙️</i> Advanced Settings</h3>\n                        </div>\n                        <div class="wtr-if-section-content">\n                            <div class="wtr-if-form-group" id="wtr-if-use-json-container">\n                                <label class="checkbox-label">\n                                    <input type="checkbox" id="wtr-if-use-json">\n                                    Use Term Replacer JSON File\n                                </label>\n                            </div>\n                            <div class="wtr-if-form-group">\n                                <label class="checkbox-label">\n                                    <input type="checkbox" id="wtr-if-logging-enabled">\n                                    Enable Debug Logging\n                                </label>\n                                <small class="wtr-if-hint">Outputs detailed script operations to the browser console.</small>\n                            </div>\n                            <div class="wtr-if-form-group">\n                                <div class="wtr-if-hint">\n                                    If you do not want to use the original site term replacer, you may use the external userscript from:\n                                    <a href="https://github.com/MasuRii/wtr-lab-term-replacer/tree/main/dist" target="_blank" rel="noopener noreferrer">\n                                        WTR Lab Term Replacer (GitHub)\n                                    </a>.\n                                    Navigate to this URL to install the supported userscript.\n                                </div>\n                                <small id="wtr-if-term-replacer-mode-hint" class="wtr-if-hint"></small>\n                            </div>\n                        </div>\n                    </div>\n\n                    \x3c!-- Data Management Section --\x3e\n                    <div class="wtr-if-section">\n                        <div class="wtr-if-section-header">\n                            <h3><i class="wtr-if-icon">💾</i> Data Management</h3>\n                        </div>\n                        <div class="wtr-if-section-content">\n                            <div class="wtr-if-form-group">\n                                <label class="checkbox-label"><input type="checkbox" id="wtr-if-auto-restore"> Auto-restore saved results on panel open</label>\n                                <small class="wtr-if-hint">Automatically offer to restore previous analysis results when opening the panel.</small>\n                            </div>\n                            <div class="wtr-if-import-export">\n                                <div class="wtr-if-form-row">\n                                    <button id="wtr-if-export-config-btn" class="wtr-if-btn wtr-if-btn-secondary">Export Configuration</button>\n                                    <button id="wtr-if-import-config-btn" class="wtr-if-btn wtr-if-btn-secondary">Import Configuration</button>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n\n                    \x3c!-- Action Section --\x3e\n                    <div class="wtr-if-section">\n                        <div class="wtr-if-section-content">\n                            <button id="wtr-if-save-config-btn" class="wtr-if-btn wtr-if-btn-primary">Save Configuration</button>\n                            <div id="wtr-if-status" class="wtr-if-status"></div>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `,document.body.appendChild(e);const t=document.createElement("div");t.id="wtr-if-status-indicator",t.style.position="fixed",t.style.left="20px",t.style.bottom=pe.BASE,t.style.zIndex="1025",t.innerHTML='<div class="wtr-if-status-icon"></div><span class="wtr-if-status-text"></span>',document.body.appendChild(t),function(){const e=document.getElementById("wtr-if-panel");if(!e)return;e.querySelector(".wtr-if-close-btn").addEventListener("click",()=>de(!1)),e.querySelector("#wtr-if-save-config-btn").addEventListener("click",W),e.querySelector("#wtr-if-find-btn").addEventListener("click",G),e.querySelector("#wtr-if-continue-btn").addEventListener("click",Y),e.querySelector("#wtr-if-refresh-models-btn").addEventListener("click",ae),e.querySelector("#wtr-if-file-input").addEventListener("change",Q),e.querySelector("#wtr-if-export-config-btn").addEventListener("click",re),e.querySelector("#wtr-if-import-config-btn").addEventListener("click",oe),e.querySelector("#wtr-if-restore-btn")?.addEventListener("click",Z),e.querySelector("#wtr-if-clear-session-btn")?.addEventListener("click",X);const t=e.querySelector("#wtr-if-filter-select");t.addEventListener("change",()=>{J(O.runtime.cumulativeResults),O.config.activeFilter=t.value,D()}),document.getElementById("wtr-if-status-indicator").addEventListener("click",ee),e.querySelector("#wtr-if-temperature").addEventListener("input",e=>{document.getElementById("wtr-if-temp-value").textContent=e.target.value}),e.querySelector("#wtr-if-auto-restore").addEventListener("change",e=>{O.preferences.autoRestoreResults=e.target.checked,D()}),e.querySelector("#wtr-if-deep-analysis-depth").addEventListener("change",e=>{O.config.deepAnalysisDepth=parseInt(e.target.value)||1,D()}),e.querySelectorAll(".wtr-if-tab-btn").forEach(t=>{t.addEventListener("click",t=>{const n=t.target.dataset.tab;if(e.querySelectorAll(".wtr-if-tab-btn").forEach(e=>e.classList.remove("active")),t.target.classList.add("active"),e.querySelectorAll(".wtr-if-tab-content").forEach(e=>e.classList.remove("active")),e.querySelector(`#wtr-if-tab-${n}`).classList.add("active"),O.config.activeTab=n,D(),"finder"===n&&te(),"config"===n)try{const e=C(),t=document.getElementById("wtr-if-use-json-container"),n=document.getElementById("wtr-if-use-json"),i=document.getElementById("wtr-if-term-replacer-mode-hint");t&&n&&i&&(e?(t.style.display="",n.disabled=!1,i.textContent="Detected WTR Lab Term Replacer userscript. You can use JSON mode or direct Apply integration."):(t.style.display="none",n.checked=!1,O.config.useJson&&(O.config.useJson=!1),i.textContent="External WTR Lab Term Replacer userscript not detected. JSON integration is disabled; using built-in behavior."))}catch(e){h("WTR Lab Term Replacer detection failed on tab switch; keeping existing configuration UI.",e)}})}),e.querySelector("#wtr-if-add-key-btn").addEventListener("click",le),e.querySelector("#wtr-if-api-keys-container").addEventListener("click",t=>{t.target.classList.contains("wtr-if-remove-key-btn")&&(e.querySelectorAll(".wtr-if-key-row").length>1?t.target.closest(".wtr-if-key-row").remove():t.target.closest(".wtr-if-key-row").querySelector("input").value="")}),setTimeout(()=>{try{const e=C(),t=document.getElementById("wtr-if-term-replacer-mode-hint");t&&(e?t.textContent="Detected WTR Lab Term Replacer userscript. Apply buttons will send terms directly to the external replacer.":t.textContent||(t.textContent="External WTR Lab Term Replacer userscript not detected yet. Actions will operate in safe (copy/manual) mode unless the userscript loads.")),te()}catch(e){h("WTR Lab Term Replacer delayed detection check failed; continuing safely.",e)}},2e3)}()}(),new MutationObserver((e,t)=>{const n=document.querySelector("nav.bottom-reader-nav");if(n){h("Bottom navigation bar found. Attaching persistent observer."),t.disconnect(),new MutationObserver(()=>{const e=n.querySelector('div[role="group"].btn-group');if(e&&!document.getElementById("wtr-if-analyze-btn")){h("Button container found. Injecting button.");const t=document.createElement("button");t.id="wtr-if-analyze-btn",t.className="wtr btn btn-outline-dark btn-sm",t.type="button",t.title="Analyze Inconsistencies",t.innerHTML='<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a4 4 0 0 0-4 4v2a4 4 0 0 0-4 4v2a4 4 0 0 0 4 4h8a4 4 0 0 0 4-4v-2a4 4 0 0 0-4-4V6a4 4 0 0 0-4-4Z"/><path d="M12 2v20"/><path d="M12 12h8"/><path d="M12 12H4"/><path d="M12 6h6"/><path d="M12 6H6"/><path d="M12 18h6"/><path d="M12 18H6"/></svg>',t.addEventListener("click",()=>de(!0)),e.appendChild(t)}}).observe(n,{childList:!0,subtree:!0});const e=n.querySelector('div[role="group"].btn-group');if(e&&!document.getElementById("wtr-if-analyze-btn")){const t=document.createElement("button");t.id="wtr-if-analyze-btn",t.className="wtr btn btn-outline-dark btn-sm",t.type="button",t.title="Analyze Inconsistencies",t.innerHTML='<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a4 4 0 0 0-4 4v2a4 4 0 0 0-4 4v2a4 4 0 0 0 4 4h8a4 4 0 0 0 4-4v-2a4 4 0 0 0-4-4V6a4 4 0 0 0-4-4Z"/><path d="M12 2v20"/><path d="M12 12h8"/><path d="M12 12H4"/><path d="M12 6h6"/><path d="M12 6H6"/><path d="M12 18h6"/><path d="M12 18H6"/></svg>',t.addEventListener("click",()=>de(!0)),e.appendChild(t)}}}).observe(document.body,{childList:!0,subtree:!0}),me(),GM_registerMenuCommand("Term Inconsistency Finder",()=>de(!0)),h(`WTR Term Inconsistency Finder v${m.VERSION} initialized successfully.`)}catch(e){console.error("Failed to initialize WTR Term Inconsistency Finder:",e)}}()})()})();